
<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پەنەلا کونترۆلێ - پڕۆژێ ئیسلام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --dark-bg: #0d1117; --card-bg: #161b22; --primary-text: #c9d1d9; --secondary-text: #8b949e;
            --accent-color: #58a6ff; --border-color: #30363d; --success-color: #2ea043; --danger-color: #f85149;
            --font-kurdish: 'Noto Sans Arabic', sans-serif;
        }
        body { font-family: var(--font-kurdish); background-color: var(--dark-bg); color: var(--primary-text); margin: 0; }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: var(--card-bg); padding: 20px; border-left: 1px solid var(--border-color); }
        .sidebar h2 { text-align: center; margin-bottom: 20px; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li a { display: block; padding: 10px 15px; color: var(--primary-text); text-decoration: none; border-radius: 6px; margin-bottom: 5px; }
        .sidebar li a:hover, .sidebar li a.active { background-color: var(--accent-color); color: var(--dark-bg); }
        .main-content { flex: 1; padding: 30px; }
        .login-view, .content-view { display: none; }
        .login-view.visible, .content-view.visible { display: block; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 30px; background-color: var(--card-bg); border-radius: 10px; }
        h1, h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        input, textarea, select, button {
            width: 100%; padding: 10px; font-family: var(--font-kurdish); border-radius: 6px;
            background-color: var(--dark-bg); color: var(--primary-text); border: 1px solid var(--border-color);
        }
        button { background-color: var(--accent-color); color: #fff; cursor: pointer; border: none; font-size: 1rem; }
        button.danger { background-color: var(--danger-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: right; }
        th { background-color: #1c222c; }
        .action-btns { display: flex; gap: 10px; }
        .dynamic-fields-container .form-group { border: 1px dashed var(--border-color); padding: 10px; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-view" class="login-view visible">
        <div class="login-container">
            <h2>چوونا ژوور - پەنەلا کونترۆلێ</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">ئیمێل</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">پاسۆرد</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">چوونا ژوور</button>
                <p id="login-error" style="color:var(--danger-color); margin-top:10px;"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="admin-container" style="display: none;">
        <aside class="sidebar">
            <h2>بەڕێوەبردن</h2>
            <ul id="sidebar-nav">
                <!-- Links will be generated by JS -->
            </ul>
            <button id="logout-btn" style="width:100%; margin-top: 20px;" class="danger">دەرکەڤتن</button>
        </aside>
        <main id="main-content" class="main-content">
            <div id="welcome-message">
                <h1>بخێر هاتن بۆ پەنەلا کونترۆلێ</h1>
                <p>ژ لیستا لایێ ڕاستێ بەشەکێ هەلبژێرە بۆ بەڕێوەبرنێ.</p>
            </div>
            <div id="content-view" class="content-view">
                <h1 id="view-title"></h1>
                <div id="form-container"></div>
                <div id="table-container"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDi3HtFigGy3qFpFVhSATal3yzm7Z_dZA",
            authDomain: "projeislam.firebaseapp.com",
            projectId: "projeislam",
            storageBucket: "projeislam.appspot.com",
            messagingSenderId: "686343038831",
            appId: "1:686343038831:web:8b5e19daa95176000b6a9a",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loginView = document.getElementById('login-view');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const mainContent = document.getElementById('main-content');
        const contentView = document.getElementById('content-view');
        const viewTitle = document.getElementById('view-title');
        const formContainer = document.getElementById('form-container');
        const tableContainer = document.getElementById('table-container');

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                loginView.style.display = 'none';
                adminPanel.style.display = 'flex';
                initAdminPanel();
            } else {
                loginView.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });

        // Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = "ئیمێل یان پاسۆرد خەلەتە.";
                    console.error("Login error:", error);
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        const collectionsConfig = {
            teachers: {
                name: 'مامۆستایان',
                fields: [
                    { name: 'name', label: 'ناڤ', type: 'text' },
                    { name: 'profileImage', label: 'لینکێ وێنەی', type: 'text' },
                    { name: 'bio', label: 'کورتەناساندن', type: 'textarea' },
                    { name: 'phone', label: 'ژمارا تەلەفونێ', type: 'text' },
                    { name: 'social.youtube', label: 'لینکێ یوتوبی', type: 'text' },
                    { name: 'social.telegram', label: 'لینکێ تێلێگرامی', type: 'text' },
                    { name: 'social.facebook', label: 'لینکێ فەیسبوکی', type: 'text' }
                ]
            },
            generalLectures: {
                name: 'وانەیێن گشتی',
                fields: [
                    { name: 'title', label: 'ناڤنیشان', type: 'text' },
                    { name: 'teacherId', label: 'ID یا مامۆستای', type: 'text' },
                    { name: 'category', label: 'بابەت', type: 'text' },
                    { name: 'image', label: 'لینکێ وێنەی', type: 'text' },
                    { name: 'pdfUrl', label: 'لینکێ PDF', type: 'text' },
                    { name: 'videos', label: 'ڤیدیۆکان (هەر لینکەک ل دێرەکێ)', type: 'dynamic-textarea', subfields: [{name: 'title', label: 'ناڤێ ڤیدیۆیێ'}, {name: 'url', label: 'لینکێ ڤیدیۆیێ'}] },
                ]
            },
            // ZÊDEKIRINA BEŞÊN DIN LI VIR... (Books, Levels, Hadiths, etc.)
            // Min tenê 2 nimûne danan ji bo kurtkirinê, lê dikarî hemîyan bi heman şêweyî zêde bikî.
        };

        function initAdminPanel() {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = Object.keys(collectionsConfig).map(key => `<li><a href="#" data-collection="${key}">${collectionsConfig[key].name}</a></li>`).join('');
            
            nav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelector('#sidebar-nav a.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    const collectionKey = e.target.dataset.collection;
                    loadCollectionView(collectionKey);
                });
            });
        }
        
        function loadCollectionView(collectionKey) {
            document.getElementById('welcome-message').style.display = 'none';
            contentView.classList.add('visible');
            const config = collectionsConfig[collectionKey];
            viewTitle.textContent = `بەڕێوەبرنا: ${config.name}`;
            renderForm(collectionKey, config.fields);
            renderTable(collectionKey, config.fields);
        }

        function renderForm(collectionKey, fields, docData = {}) {
            const docId = docData.id || '';
            let formHTML = `<h3>${docId ? 'دەستکاریکرنا بابەتی' : 'زێدەکرنا بابەتەکێ نوو'}</h3>
                            <form data-collection="${collectionKey}" data-id="${docId}">`;
            
            fields.forEach(field => {
                const value = getNestedValue(docData, field.name) || '';
                formHTML += `<div class="form-group">
                                <label for="${field.name}">${field.label}</label>`;
                if (field.type === 'textarea') {
                    formHTML += `<textarea id="${field.name}" name="${field.name}" rows="4">${value}</textarea>`;
                } else if(field.type === 'dynamic-textarea') {
                    // Nimûneya destpêkê ji bo dynamic fields
                    formHTML += `<div class="dynamic-fields-container" data-field-name="${field.name}">`;
                    (value || [{}]).forEach((item, index) => {
                         formHTML += `<div class="form-group">
                                        ${field.subfields.map(sub => `<label>${sub.label}</label><input type="text" name="${field.name}[${index}][${sub.name}]" value="${item[sub.name] || ''}">`).join('')}
                                     </div>`;
                    });
                    formHTML += `</div><button type="button" class="add-dynamic-field" data-field-name="${field.name}">+ زێدەکرنا فیلدەکێ دی</button>`;
                } else {
                    formHTML += `<input type="text" id="${field.name}" name="${field.name}" value="${value}">`;
                }
                formHTML += `</div>`;
            });
            
            formHTML += `<button type="submit">${docId ? 'پاشکەفتکرن' : 'زێدەکرن'}</button>`;
            if (docId) formHTML += `<button type="button" class="cancel-edit" style="margin-right:10px;">هەلوەشاندن</button>`;
            formHTML += `</form>`;

            formContainer.innerHTML = formHTML;
            attachFormListeners();
        }

        function renderTable(collectionKey, fields) {
            tableContainer.innerHTML = '<h3>لیستا بابەتان</h3><div id="table-wrapper"></div>';
            const tableWrapper = document.getElementById('table-wrapper');
            
            db.collection(collectionKey).onSnapshot(snapshot => {
                if (snapshot.empty) {
                    tableWrapper.innerHTML = "<p>هیچ بابەتەک نەهاتیە تۆمارکرن.</p>";
                    return;
                }
                let tableHTML = `<table><thead><tr>`;
                fields.slice(0, 3).forEach(field => tableHTML += `<th>${field.label}</th>`); // Tenê 3 field nîşan dide
                tableHTML += `<th>کردار</th></tr></thead><tbody>`;

                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    tableHTML += `<tr>`;
                    fields.slice(0, 3).forEach(field => {
                        let value = getNestedValue(data, field.name) || '';
                        if(typeof value === 'object') value = JSON.stringify(value).substring(0, 30) + '...';
                        tableHTML += `<td>${String(value).substring(0, 50)}</td>`;
                    });
                    tableHTML += `<td><div class="action-btns">
                                    <button class="edit-btn" data-id="${doc.id}">دەستکاری</button>
                                    <button class="danger delete-btn" data-id="${doc.id}">ژێبرن</button>
                                 </div></td></tr>`;
                });

                tableHTML += `</tbody></table>`;
                tableWrapper.innerHTML = tableHTML;
                attachTableListeners(collectionKey, fields);
            });
        }
        
        function attachFormListeners(){
            const form = formContainer.querySelector('form');
            if(form) {
                form.addEventListener('submit', handleFormSubmit);
                const cancelBtn = form.querySelector('.cancel-edit');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        const collectionKey = document.querySelector('#sidebar-nav a.active').dataset.collection;
                        loadCollectionView(collectionKey); // Formê reset dike
                    });
                }
            }
             document.querySelectorAll('.add-dynamic-field').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     // Lojîka zêdekirina dynamic fields li vir
                });
            });
        }

        function attachTableListeners(collectionKey, fields) {
            tableContainer.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    const doc = await db.collection(collectionKey).doc(docId).get();
                    renderForm(collectionKey, fields, { id: doc.id, ...doc.data() });
                });
            });

            tableContainer.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    if (confirm('تۆ پشتراستی دێ ڤی بابەتی ژێبەی؟')) {
                        db.collection(collectionKey).doc(docId).delete()
                          .then(() => alert('بابەت هاتە ژێبرن.'))
                          .catch(err => console.error("Error deleting doc:", err));
                    }
                });
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const collectionKey = form.dataset.collection;
            const docId = form.dataset.id;
            const config = collectionsConfig[collectionKey];
            
            let data = {};
            config.fields.forEach(field => {
                // Pêdivî ye ku lojîk bo komkirina dynamic fields were zêdekirin
                if(form.elements[field.name]) {
                    setNestedValue(data, field.name, form.elements[field.name].value);
                }
            });

            try {
                if (docId) { // Update
                    await db.collection(collectionKey).doc(docId).set(data, { merge: true });
                    alert('بابەت هاتە نووژەنکرن.');
                } else { // Create
                    await db.collection(collectionKey).add(data);
                    alert('بابەت هاتە زێدەکرن.');
                }
                form.reset();
                if(docId) loadCollectionView(collectionKey); // Vegere ser forma vala
            } catch (err) {
                console.error("Error saving to Firestore:", err);
                alert('چەوتیەک روویدا.');
            }
        }
        
        // Fonksiyonên alîkar bo nested objects
        function getNestedValue(obj, path) {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj);
        }
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            keys.reduce((acc, key, i) => {
                if (i === keys.length - 1) {
                    acc[key] = value;
                } else {
                    acc[key] = acc[key] || {};
                }
                return acc[key];
            }, obj);
        }

    </script>
</body>
</html>
