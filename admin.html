<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پانێلێ کونترۆلێ - پرۆژێ ئیسلام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');
        
        :root {
            --dark-bg: #0d1117; --card-bg: #161b22; --primary-text: #c9d1d9;
            --secondary-text: #8b949e; --accent-color: #58a6ff; --border-color: #30363d;
            --success-color: #2ea043; --danger-color: #f85149; --warning-color: #f0b429;
            --font-kurdish: 'Noto Sans Arabic', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-kurdish); background-color: var(--dark-bg);
            color: var(--primary-text); line-height: 1.6;
        }
        
        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        #login-box {
            background: var(--card-bg); padding: 30px; border-radius: 10px;
            width: 90%; max-width: 400px; text-align: center;
            border-top: 3px solid var(--accent-color);
        }
        #login-box h2 { margin-bottom: 20px; }
        #login-box input {
            width: 100%; padding: 12px; margin-bottom: 20px;
            background: var(--dark-bg); border: 1px solid var(--border-color);
            color: var(--primary-text); border-radius: 6px; font-family: var(--font-kurdish);
        }
        #login-box button {
            width: 100%; padding: 12px; background: var(--accent-color);
            color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;
        }

        #admin-panel { display: none; }
        .admin-container {
            display: flex; height: 100vh;
        }
        #sidebar {
            width: 250px; background: var(--card-bg); padding: 20px;
            border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        #sidebar h2 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        #sidebar .collection-list button {
            display: block; width: 100%; text-align: right;
            padding: 12px 10px; background: none; border: none;
            color: var(--secondary-text); cursor: pointer; font-size: 1rem;
            border-radius: 6px; margin-bottom: 5px;
        }
        #sidebar .collection-list button:hover { background: var(--border-color); color: var(--primary-text); }
        #sidebar .collection-list button.active { background: var(--accent-color); color: white; }
        #logout-btn { margin-top: auto; color: var(--danger-color); }
        
        #main-content {
            flex: 1; padding: 30px; overflow-y: auto;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .add-new-btn {
            background: var(--success-color); color: white; padding: 10px 20px;
            border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: right; }
        thead { background-color: var(--dark-bg); }
        .actions-cell button {
            background: none; border: none; cursor: pointer; font-size: 1.1rem;
            margin: 0 5px; color: var(--secondary-text);
        }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 500;
            display: none; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card-bg); padding: 30px; border-radius: 10px;
            width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; background: var(--dark-bg);
            border: 1px solid var(--border-color); color: var(--primary-text);
            border-radius: 6px; font-family: var(--font-kurdish);
        }
        .modal-footer { margin-top: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="app-loader">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div id="login-box">
            <h2><i class="fas fa-lock"></i> پانێلێ کونترۆلێ</h2>
            <p style="color:var(--secondary-text); margin-bottom: 20px;">هیڤی یە وشەیا نهێنی داخل بکە.</p>
            <form id="login-form">
                <input type="password" id="password-input" placeholder="وشەیا نهێنی" required>
                <button type="submit">چوونە ژۆر</button>
                <p id="login-error" style="color:var(--danger-color); margin-top:15px; display:none;">وشەیا نهێنی خەلەتە!</p>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="admin-container">
            <aside id="sidebar">
                <h2><i class="fas fa-database"></i> بەشێن داتایێ</h2>
                <div class="collection-list" id="collection-list">
                    <!-- Collection buttons will be loaded here -->
                </div>
                <button id="logout-btn" class="collection-list-btn"><i class="fas fa-sign-out-alt"></i> دەرکەفتن</button>
            </aside>
            <main id="main-content">
                <!-- Content will be loaded here -->
                <div id="welcome-message">
                    <h2>بخێر هاتن بۆ پانێلێ کونترۆلێ</h2>
                    <p>هیڤی یە بەشەکێ ژ لیستا لایێ راستێ هەلبژێرە دا دەست ب کارکرنێ بکەی.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">فۆرم</h3>
                <button onclick="closeModal()" style="background:none; border:none; font-size:1.8rem; color:var(--secondary-text); cursor:pointer;">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-collection">
                <div id="form-fields"></div>
                <div class="modal-footer">
                    <button type="submit" class="save-btn"><i class="fas fa-save"></i> پاشکەفتکرن</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    'use strict';
    
    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const appLoader = document.getElementById('app-loader');
        
        // ##############################################################
        // ## گرنگ: وشەیا نهێنی یا پانێلی لڤێرە بگۆهڕە                  ##
        // ##############################################################
        const ADMIN_PASSWORD = "1234";

        const firebaseConfig = {
            apiKey: "AIzaSyDDi3HtFigGy3qFpFVhSATal3yzm7Z_dZA",
            authDomain: "projeislam.firebaseapp.com",
            projectId: "projeislam",
            storageBucket: "projeislam.firebasestorage.app",
            messagingSenderId: "686343038831",
            appId: "1:686343038831:web:745161e7543b53aa0b6a9a"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
            appLoader.style.display = 'none'; // Hide loader after init
        } catch(e) {
            console.error("Firebase Initialization Error:", e);
            document.body.innerHTML = "<h1>کێشە د گرێدانا دگەل Firebase دا هەیە. هیڤی یە پێزانینان پشتراست بکەی و Console ببینە.</h1>";
            return;
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === ADMIN_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                initializeApp();
            } else {
                loginError.style.display = 'block';
            }
        });
    });

    const collectionDisplayNames = {
        'teachers': 'مامۆستایان',
        'generalLectures': 'وانەیێن گشتی',
        'hadiths': 'کتێبخانەیا حەدیسێ',
        'pirtukxane': 'پەرتوکخانە',
        'bookSales': 'فرۆتنا پەرتووکان',
        'locations': 'خەریتە',
        'fatwas': 'پرسیار و بەرسڤ',
        'seerah': 'ژیاننامە',
        'adhkar': 'دوعا و زکران',
        'fiqh': 'فقهـ و حوکم',
        'viewStatus': 'حالەتێ بەشان',
        'levels': 'رێرەوا فێربوونێ'
    };
    
    let teacherCache = [];
    
    async function initializeApp() {
        document.getElementById('logout-btn').addEventListener('click', () => location.reload());

        // Pre-load teachers for dropdowns
        const teacherSnapshot = await db.collection('teachers').get();
        teacherCache = teacherSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const sidebar = document.getElementById('collection-list');
        sidebar.innerHTML = '';
        Object.entries(collectionDisplayNames).forEach(([key, name]) => {
            sidebar.innerHTML += `<button id="btn-${key}" onclick="loadCollection('${key}')"><i class="fas fa-chevron-left"></i> ${name}</button>`;
        });
    }

    async function loadCollection(collectionName) {
        document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${collectionName}`).classList.add('active');

        const contentArea = document.getElementById('main-content');
        contentArea.innerHTML = `<div id="app-loader"><div class="spinner"></div></div>`;

        if (collectionName === 'viewStatus') {
            await loadViewStatus();
            return;
        }
        
        const snapshot = await db.collection(collectionName).get();
        if (snapshot.empty) {
            contentArea.innerHTML = `
                <div class="section-header">
                    <h2>بەڕێوەبرنا ${collectionDisplayNames[collectionName]}</h2>
                    <button class="add-new-btn" onclick="openModal('${collectionName}')"><i class="fas fa-plus"></i> زێدەکرن</button>
                </div>
                <p>هیچ داتایەک د ڤی بەشی دا نینە.</p>`;
            return;
        }
        
        const firstDocData = snapshot.docs[0].data();
        const headers = Object.keys(firstDocData).slice(0, 4); // Show first 4 fields as headers
        
        let tableHTML = `
            <div class="section-header">
                <h2>بەڕێوەبرنا ${collectionDisplayNames[collectionName]}</h2>
                <button class="add-new-btn" onclick="openModal('${collectionName}')"><i class="fas fa-plus"></i> زێدەکرن</button>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}<th>کارپێکرن</th></tr></thead>
                    <tbody>
                        ${snapshot.docs.map(doc => {
                            const data = doc.data();
                            return `<tr id="doc-${doc.id}">
                                ${headers.map(h => {
                                    let val = data[h];
                                    if (typeof val === 'object') val = '[Object]';
                                    if (typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
                                    return `<td>${val}</td>`;
                                }).join('')}
                                <td class="actions-cell">
                                    <button onclick="openModal('${collectionName}', '${doc.id}')" title="دەستکاری"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteItem('${collectionName}', '${doc.id}')" title="ژێبرن"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>`;
        contentArea.innerHTML = tableHTML;
    }

    async function openModal(collectionName, docId = null) {
        document.getElementById('edit-collection').value = collectionName;
        document.getElementById('edit-id').value = docId || '';

        let data = {};
        if (docId) {
            const docRef = await db.collection(collectionName).doc(docId).get();
            data = docRef.data();
        }

        document.getElementById('modal-title').textContent = docId ? `دەستکاریکرنا بابەتی` : `زێدەکرنا بابه‌ته‌كێ نوو`;
        
        // Intelligent Form Generation
        const formFields = document.getElementById('form-fields');
        formFields.innerHTML = `<p>هیڤی یە پێزانینێن پێدڤی پر بکە...</p>`; // Placeholder
        
        // Define schemas to generate beautiful forms
        const schemas = {
            teachers: { name: 'text', bio: 'textarea', profileImage: 'url', phone: 'tel', social: 'map' },
            generalLectures: { title: 'text', teacherId: 'select', category: 'text', image: 'url', pdfUrl: 'url', videos: 'array' },
            locations: { locationName: 'text', lessonTaught: 'text', schedule: 'text', teacherId: 'select', coordinates: 'geopoint'},
            // ... define other schemas as needed
        };

        const schema = schemas[collectionName] || {};
        const allKeys = docId ? Object.keys(data) : (Object.keys(schema).length > 0 ? Object.keys(schema) : ['field1', 'field2']);
        
        formFields.innerHTML = allKeys.map(key => {
            const value = data[key] || '';
            const type = schema[key] || 'text'; // Default to text input
            let fieldHtml = `<div class="form-group"><label for="field-${key}">${key}</label>`;

            if (type === 'textarea') {
                fieldHtml += `<textarea id="field-${key}">${value}</textarea>`;
            } else if (type === 'select' && key === 'teacherId') {
                 fieldHtml += `<select id="field-${key}">${teacherCache.map(t => `<option value="${t.id}" ${value === t.id ? 'selected':''}>${t.name}</option>`).join('')}</select>`;
            } else if (type === 'geopoint') {
                const lat = value?.latitude ?? '';
                const long = value?.longitude ?? '';
                fieldHtml += `<div style="display:flex; gap:10px;"><input id="field-${key}-lat" placeholder="Latitude" value="${lat}"><input id="field-${key}-long" placeholder="Longitude" value="${long}"></div>`;
            }
             else { // Default to input
                fieldHtml += `<input type="text" id="field-${key}" value="${value}">`;
            }
            fieldHtml += `</div>`;
            return fieldHtml;
        }).join('');

        document.getElementById('edit-modal').classList.add('active');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const collectionName = document.getElementById('edit-collection').value;
        const docId = document.getElementById('edit-id').value;
        
        const dataToSave = {};
        const formFields = document.getElementById('form-fields').querySelectorAll('input, textarea, select');
        
        formFields.forEach(field => {
            const key = field.id.replace('field-', '');
             if (field.id.includes('-lat')) { // Handle GeoPoint
                const baseKey = key.replace('-lat', '');
                const lat = parseFloat(field.value);
                const long = parseFloat(document.getElementById(`field-${baseKey}-long`).value);
                if (!isNaN(lat) && !isNaN(long)) {
                    dataToSave[baseKey] = new firebase.firestore.GeoPoint(lat, long);
                }
            } else if (!field.id.includes('-long')) {
                dataToSave[key] = field.value;
            }
        });
        
        try {
            if (docId) {
                await db.collection(collectionName).doc(docId).update(dataToSave);
                alert('بابەت ب سەرکەفتیانە هاتە نووژەنکرن!');
            } else {
                await db.collection(collectionName).add(dataToSave);
                alert('بابەت ب سەرکەفتیانە هاتە زێدەکرن!');
            }
            closeModal();
            loadCollection(collectionName);
        } catch (error) {
            console.error("Error saving doc:", error);
            alert("چەوتیەک د پاشکەفتکرنێ دا روویدا!");
        }
    }
    
    function closeModal() {
        document.getElementById('edit-modal').classList.remove('active');
    }
    
    async function deleteItem(collectionName, docId) {
        if(confirm("تو پشتراستی دێ ڤی بابەتی ژێبەری؟")) {
            await db.collection(collectionName).doc(docId).delete();
            alert("بابەت هاتە ژێبرن.");
            loadCollection(collectionName);
        }
    }

    // Assign to window to be accessible from HTML
    window.loadCollection = loadCollection;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.deleteItem = deleteItem;

    </script>
</body>
</html>
