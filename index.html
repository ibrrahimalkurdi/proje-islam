<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرۆژێ زانست</title>
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
<style>
    /* --- CSS گشتی و گۆڕاوەکان --- */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');

    :root {
        --dark-bg: #0d1117;
        --card-bg: #161b22;
        --primary-text: #c9d1d9;
        --secondary-text: #8b949e;
        --accent-color: #58a6ff;
        --border-color: #30363d;
        --success-color: #2ea043;
        --danger-color: #f85149;
        --font-kurdish: 'Noto Sans Arabic', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { 
        scroll-behavior: smooth;
        scroll-padding-top: 80px;
    }
    body { font-family: var(--font-kurdish); background-color: var(--dark-bg); color: var(--primary-text); line-height: 1.7; }
    a { color: var(--accent-color); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { width: 90%; max-width: 1200px; margin: auto; }

    /* --- شاشەیا چاڤەڕوانیێ (Loading Screen) --- */
    #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1f2e 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-screen.fade-out { opacity: 0; pointer-events: none; }
    .loading-logo { font-size: 4rem; font-weight: 700; color: var(--primary-text); margin-bottom: 20px; animation: pulse 2s infinite; }
    .loading-logo span { color: var(--accent-color); }
    .welcome-text { font-size: 1.5rem; color: var(--secondary-text); text-align: center; margin-bottom: 30px; animation: fadeInUp 1s ease-out 0.5s both; }
    .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }

    /* --- ئەنیمەیشنەکان --- */
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- سەرە (Header) و پێ (Footer) --- */
    header { position: sticky; top: 0; width: 100%; padding: 15px 0; z-index: 1000; background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); }
    header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .logo { font-size: 26px; font-weight: 700; text-decoration: none; color: var(--primary-text); cursor: pointer; }
    .logo span { color: var(--accent-color); }
    nav { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
    nav a { color: var(--secondary-text); text-decoration: none; padding: 8px 16px; font-weight: 500; transition: color 0.3s, border-bottom-color 0.3s; cursor: pointer; border-bottom: 2px solid transparent; }
    nav a:hover, nav a.active { color: var(--primary-text); border-bottom-color: var(--accent-color); }
    footer { padding: 40px 20px; text-align: center; border-top: 1px solid var(--border-color); margin-top: 50px; color: var(--secondary-text); }
    .contribution-link-btn { display: inline-block; background-color: transparent; border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 18px; border-radius: 8px; margin-top: 20px; text-decoration: none; transition: all 0.3s; }
    .contribution-link-btn:hover { background-color: var(--card-bg); border-color: var(--accent-color); color: var(--primary-text); transform: translateY(-2px); }
    .contribution-link-btn i { margin-left: 8px; }

    /* --- دیتنێن گشتی (Views) --- */
    .view { display: none; }
    .view.is-active { display: block; animation: fadeIn 0.5s ease-in-out; }
    .page-header { text-align: center; padding: 50px 20px; }
    .page-header h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(120deg, var(--primary-text), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }

    /* --- ستایلێن بەشێ ئاستێن زانستی --- */
    #levels-view .level-accordion { background: transparent; color: var(--primary-text); cursor: pointer; padding: 18px 25px; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; text-align: right; margin-bottom: 10px; transition: all 0.3s; }
    #levels-view .level-accordion:hover { border-color: var(--accent-color); background: var(--card-bg); }
    #levels-view .level-accordion .icon { transition: transform 0.3s ease-out; font-size: 1rem; width: 20px; text-align: center;} 
    #levels-view .level-panel { padding: 5px 20px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: var(--card-bg); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; margin-top: -11px; margin-bottom: 20px; }
    #levels-view .level-header { padding: 20px 0 10px 0; }
    #levels-view .level-header p { font-size: 1rem; color: var(--secondary-text); margin-bottom: 15px; }
    #levels-view .progress-bar-container { width: 100%; background-color: var(--dark-bg); border-radius: 10px; height: 10px; overflow: hidden; border: 1px solid var(--border-color); }
    #levels-view .progress-bar { height: 100%; width: 0%; background-color: var(--success-color); transition: width 0.5s ease; }
    #levels-view .level-item-card { display: flex; align-items: center; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px 20px; margin: 15px 0; transition: all 0.3s ease; }
    #levels-view .level-item-card.completed { background-color: rgba(46, 160, 67, 0.1); border-color: var(--success-color); }
    #levels-view .level-item-card.completed .item-title { text-decoration: line-through; color: var(--secondary-text); }
    #levels-view .item-checkbox { margin-left: 20px; width: 22px; height: 22px; accent-color: var(--success-color); cursor: pointer; }
    #levels-view .item-icon { font-size: 1.5rem; color: var(--accent-color); width: 40px; text-align: center; }
    #levels-view .item-details { flex-grow: 1; }
    #levels-view .item-title { font-size: 1.1rem; color: var(--primary-text); margin-bottom: 5px; }
    #levels-view .item-teacher { font-size: 0.9rem; color: var(--secondary-text); }
    #levels-view .item-actions a { color: var(--secondary-text); font-size: 1.2rem; transition: color .3s; margin: 0 8px; }
    #levels-view .item-actions a:hover { color: var(--accent-color); }

    /* --- [NEW] ستایلێن پێشکەفتی بۆ ئاستێن زانستی --- */
    #levels-view .level-accordion.locked {
        background-color: var(--dark-bg);
        cursor: not-allowed;
        opacity: 0.6;
    }
    #levels-view .level-accordion.locked:hover {
        border-color: var(--border-color); /* No highlight on hover */
        background: var(--dark-bg);
    }
    #levels-view .level-accordion.completed-level {
        background-color: rgba(46, 160, 67, 0.1);
        border-color: var(--success-color);
    }
    #levels-view .level-accordion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        font-size: 1.2rem;
    }
    #levels-view .level-title-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    #levels-view .status-badge {
        font-size: 0.8rem;
        padding: 3px 10px;
        border-radius: 50px;
        font-weight: 500;
        white-space: nowrap;
    }
    #levels-view .status-badge.locked {
        background-color: var(--secondary-text);
        color: var(--dark-bg);
    }
    #levels-view .status-badge.in-progress {
        background-color: var(--accent-color);
        color: var(--dark-bg);
    }
    #levels-view .status-badge.completed {
        background-color: var(--success-color);
        color: white;
    }

    /* --- وانە و پەرتوکخانە (General Cards & Grids) --- */
    .filters-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; align-items: center; background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color);}
    .filter-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
    .filter-group h4 { margin: 0 15px 0 0; font-weight: 500; color: var(--primary-text); }
    .filter-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: all .3s ease; }
    .filter-btn:hover, .filter-btn.active { background: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
    .waneyan-grid, .pirtuk-grid { display: grid; gap: 25px; }
    .waneyan-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
    .pirtuk-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
    .wana-card, .pirtuk-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s; }
    .wana-card:hover, .pirtuk-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--accent-color); }
    .wana-card-img { width: 100%; height: 180px; object-fit: cover; }
    .pirtuk-card-img { width: 100%; height: 320px; object-fit: cover; border-bottom: 1px solid var(--border-color);}
    .wana-card-content, .pirtuk-card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .card-btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; }
    .card-btn-small { flex: 1; background: var(--accent-color); color: #fff; padding: 10px; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
    .card-btn-small.secondary { background: var(--border-color); }
    .card-btn-small:hover { opacity: 0.9; }

    /* --- مامۆستا (Teachers View) --- */
    #teachers-view .teachers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
    .teacher-card-simple { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; text-align: center; padding: 25px; transition: all 0.3s ease; }
    .teacher-card-simple:hover { transform: translateY(-5px); border-color: var(--accent-color); }
    .teacher-card-simple img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--dark-bg); box-shadow: 0 0 0 3px var(--border-color); margin-bottom: 15px; }
    .teacher-card-simple h3 { font-size: 1.2rem; color: var(--primary-text); margin-bottom: 5px; }
    .teacher-card-simple p { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 15px; }
    .teacher-card-simple .profile-btn-simple { background: var(--accent-color); color: white; padding: 8px 20px; border-radius: 6px; text-decoration: none; display: inline-block; font-size: 0.9rem; }
    
    /* --- دیتنا خەریتێ (Map View) --- */
    #map-view-layout { display: flex; flex-direction: column; gap: 30px; }
    .map-controls { display: flex; justify-content: center; padding: 20px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); }
    .map-search-input { width: 100%; max-width: 500px; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px 15px; border-radius: 8px; font-family: var(--font-kurdish); }
    #main-map-container { height: 500px; border-radius: 10px; border: 1px solid var(--border-color); }
    #location-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .location-list-item { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease; }
    .location-list-item:hover { transform: translateY(-4px); border-left-color: var(--accent-color); background-color: #1c222c; }
    .location-list-item h4 { font-size: 1.2rem; color: var(--primary-text); margin-bottom: 15px; }
    .location-list-item p { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; color: var(--secondary-text); }
    .location-list-item p i { color: var(--accent-color); font-size: 1rem; margin-top: 4px; }

    /* --- مۆدالەکان (Modals) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .modal-overlay.is-visible { display: flex; animation: fadeIn 0.3s; }
    .modal-content { position: relative; width: 90%; background:var(--card-bg); border-radius:10px; max-height: 85vh; overflow-y: auto; }
    .close-modal-btn { position: absolute; top: 15px; right: 20px; color: var(--secondary-text); font-size: 2rem; cursor: pointer; z-index: 10; }
    #lesson-list-modal .modal-content { max-width: 600px; padding: 30px; }
    #lesson-list-modal h3 { margin-bottom: 20px; text-align: center; font-size: 1.5rem; }
    .lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-right: 3px solid var(--border-color); transition: all .3s; }
    .lesson-item:hover { border-right-color: var(--accent-color); background-color: var(--border-color); }
    .lesson-item span { font-size: 1rem; }
    .lesson-item.clickable { cursor: pointer; }
    .watch-btn { background: none; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 5px 12px; border-radius: 5px; cursor: pointer; }
    
    /* --- مۆدالێ پرۆفایلێ --- */
    #teacher-profile-modal .modal-content { max-width: 800px; padding: 0; overflow: hidden; background-color: var(--dark-bg); }
    #profile-dynamic-content { max-height: 85vh; overflow-y: auto; }
    #profile-dynamic-content::-webkit-scrollbar { width: 8px; }
    #profile-dynamic-content::-webkit-scrollbar-track { background: var(--dark-bg); }
    #profile-dynamic-content::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; }
    #profile-dynamic-content::-webkit-scrollbar-thumb:hover { background-color: var(--secondary-text); }
    .profile-new-header { background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://picsum.photos/1000/300?blur=5') no-repeat center center/cover; padding: 40px 20px 80px 20px; position: relative; text-align: center; }
    .profile-header-img-wrapper { position: relative; width: 150px; height: 150px; margin: auto; margin-top: -100px; top: 60px; border-radius: 50%; background: linear-gradient(45deg, var(--accent-color), var(--success-color)); padding: 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
    .profile-header-img-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid var(--dark-bg); }
    #profile-header-name-new { font-size: 2.2rem; margin-top: 15px; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
    #profile-header-bio-new { color: var(--primary-text); max-width: 600px; margin: 10px auto 0 auto; font-size: 1rem; }
    .profile-new-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; padding: 40px 30px 30px 30px; background-color: var(--dark-bg); }
    .profile-main-info, .profile-tabbed-content { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 25px; }
    .profile-section-title-new { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary-text); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
    .profile-contact-buttons { display: flex; flex-direction: column; gap: 15px; }
    .profile-contact-buttons a { background: var(--dark-bg); color: var(--secondary-text); padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; text-decoration: none; }
    .profile-contact-buttons a:hover { background: var(--border-color); color: var(--primary-text); transform: translateX(4px); }
    .profile-contact-buttons a i { font-size: 1.3rem; width: 25px; text-align: center; }
    .lesson-item-new { display: flex; align-items: center; justify-content: space-between; gap: 15px; background: var(--dark-bg); padding: 12px 18px; border-radius: 8px; margin-bottom: 10px; transition: all 0.3s ease; }
    .lesson-item-new:hover { background: var(--border-color); }
    .lesson-item-new .lesson-info { display: flex; align-items: center; gap: 12px; }
    .lesson-item-new .lesson-info i { color: var(--accent-color); }
    .lesson-item-new .lesson-info span { font-size: 1rem; }
    .lesson-item-new .watch-btn-new { background: var(--accent-color); color: white; padding: 6px 15px; border-radius: 6px; text-decoration: none; border: none; cursor: pointer; font-size: 0.9rem; transition: opacity .3s; }
    .lesson-item-new .watch-btn-new:hover { opacity: 0.85; }
    @media (max-width: 900px) { .profile-new-grid { grid-template-columns: 1fr; } }

    /* --- خولێن ڕاستەوخۆ (Live Course) --- */
    .live-view-content { text-align: center; padding: 40px 20px; }
    .live-view-content .live-badge { background-color: var(--danger-color); color: white; padding: 5px 15px; border-radius: 50px; font-size: 1rem; display: inline-block; margin-bottom: 20px; animation: livePulse 2s infinite; }
    @keyframes livePulse { 0% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(248, 81, 73, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0); } }
    .live-view-content h1 { font-size: 3rem; margin-bottom: 15px; }
    .live-view-content .live-teacher-info { margin-bottom: 30px; font-size: 1.2rem; }
    #live-countdown { display: flex; justify-content: center; gap: 20px; margin: 40px 0; }
    .countdown-box { background: var(--card-bg); padding: 20px; border-radius: 10px; min-width: 100px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
    .countdown-box .number { font-size: 2.5rem; font-weight: 700; color: var(--accent-color); }
    .countdown-box .label { font-size: 0.9rem; color: var(--secondary-text); }
    .live-details-section { max-width: 800px; margin: 40px auto; text-align: right; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }
    .live-details-section ul { list-style-position: inside; padding-right: 20px; }

    /* --- فۆرمەکان (Forms) --- */
    .form-group { margin-bottom: 20px; text-align: right; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
    .form-group input[type="text"], .form-group input[type="email"], .form-group textarea { width: 100%; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px; border-radius: 6px; font-family: var(--font-kurdish); }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-color); outline: none; }
    .form-group textarea { min-height: 120px; resize: vertical; }
    .form-group-checkbox { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
    .form-submit-btn { width: 100%; padding: 12px; font-size: 1.1rem; background-color: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-kurdish); transition: background-color .3s; }
    .form-submit-btn:hover { opacity: .9; }
    .live-registration-form { max-width: 600px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }

    /* --- مۆدالێ پشکداریێ (Contribution Modal) --- */
    #contribution-modal .modal-content { max-width: 700px; padding: 30px; text-align: right; }
    #contribution-modal h3 { text-align: center; margin-bottom: 25px; font-size: 1.6rem; }
    .contribution-step-title { font-size: 1.2rem; margin-bottom: 15px; color: var(--primary-text); font-weight: 500; text-align: center;}
    #contribution-type-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
    .contribution-type-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 15px 25px; border-radius: 8px; cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; }
    .contribution-type-btn:hover, .contribution-type-btn.active { background-color: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
    .contribution-type-btn i { display: block; font-size: 1.8rem; margin-bottom: 10px; }
    #contribution-form .form-fields-group { display: none; animation: fadeIn 0.4s; }
</style>
</head>
<body>
    <!-- شاشەیا چاڤەڕوانیێ -->
    <div id="loading-screen">
        <div class="loading-logo">زانست<span>.</span></div>
        <div class="welcome-text">بخێر هاتن بۆ پرۆژێ زانست...<br><span style="font-size:1rem;">زانیاری دهێنە وەرگرتن ژ گوگل شیتس</span></div>
        <div class="loading-spinner"></div>
    </div>
    
    <!-- سەرە (Header) -->
    <header>
        <div class="container">
            <a href="#" onclick="switchNav(document.querySelector('#main-nav a'), 'live-view')" class="logo">زانست<span>.</span></a>
            <nav id="main-nav">
                <a href="#" onclick="switchNav(this, 'live-view')">خولێن ڕاستەوخۆ</a>
                <a href="#" onclick="switchNav(this, 'waneyan-view')">وانەیێن گشتی</a>
                <a href="#" onclick="switchNav(this, 'pirtukxane-view')">پەرتوکخانە</a>
                <a href="#" onclick="switchNav(this, 'teachers-view')">مامۆستایان</a>
                <a href="#" onclick="switchNav(this, 'map-view')">خەریتە</a>
                <a href="#" onclick="switchNav(this, 'levels-view')">ئاستێن زانستی</a>
            </nav>
        </div>
    </header>

    <!-- ناڤەروکا سەرەکی (Main Content) -->
    <main class="container">
        <div id="live-view" class="view"></div>
        <div id="waneyan-view" class="view"></div>
        <div id="pirtukxane-view" class="view"></div>
        <div id="teachers-view" class="view"></div>
        <div id="map-view" class="view"></div>
        <div id="levels-view" class="view"></div>
    </main>

    <!-- === هەمی مۆدالەکان === -->
    <div class="modal-overlay" id="lesson-list-modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('lesson-list-modal')">&times;</span>
            <h3 id="lesson-list-title"></h3>
            <div id="lesson-list-container"></div>
        </div>
    </div>

    <div class="modal-overlay" id="teacher-profile-modal">
        <div class="modal-content profile-modal-content">
            <span class="close-modal-btn" onclick="closeModal('teacher-profile-modal')">&times;</span>
            <div id="profile-dynamic-content"></div>
        </div>
    </div>

    <div class="modal-overlay" id="contribution-modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('contribution-modal')">&times;</span>
            <h3>پشکداریێ د پرۆژەی دا بکە</h3>
            <div id="contribution-form-container">
                <p class="contribution-step-title">تۆ دێ حەزکەی چ جورە پشکداریێ کەی؟</p>
                <div id="contribution-type-selector">
                    <button class="contribution-type-btn" onclick="showContributionFields('teacher')"><i class="fas fa-chalkboard-teacher"></i>مامۆستا</button>
                    <button class="contribution-type-btn" onclick="showContributionFields('lesson')"><i class="fas fa-video"></i>وانەیێن گشتی</button>
                    <button class="contribution-type-btn" onclick="showContributionFields('book')"><i class="fas fa-book-open"></i>پەرتووک</button>
                </div>
                
                <form id="contribution-form" action="https://formspree.io/f/mzzvyjve" method="POST" style="display: none;">
                    <input type="hidden" id="contribution_type_input" name="جۆرێ پشکداریێ" value="">
                    <div id="teacher-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن مامۆستای بنڤیسە</p>
                        <div class="form-group"><label>ناڤێ مامۆستای:</label><input type="text" name="ناڤێ مامۆستای" required></div>
                        <div class="form-group"><label>شار/دەڤەرێ مامۆستای:</label><input type="text" name="دەڤەرێ مامۆستای" required></div>
                        <div class="form-group"><label>کورتەیەک لسەر ژیانی یان پسپۆری:</label><textarea name="ژیانناما مامۆستای"></textarea></div>
                        <div class="form-group"><label>پەیوەندی (ئیمەیل، تەلەفون، یان لینکێ سۆشیال میدیایێ):</label><input type="text" name="پەیوەندیا مامۆستای" required></div>
                    </div>
                    <div id="lesson-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن زنجیرە وانەیێ بنڤیسە</p>
                        <div class="form-group"><label>ناڤونیشانێ زنجیرە وانەیێ:</label><input type="text" name="ناڤونیشانێ وانەیێ" required></div>
                        <div class="form-group"><label>ناڤێ مامۆستایێ وانەبێژ:</label><input type="text" name="مامۆستایێ وانەیێ" required></div>
                        <div class="form-group"><label>لینکێ زنجیرە وانەیێ (بۆ نموونە لینکێ پلەیلیستا یوتیوبی):</label><input type="text" name="لینکێ وانەیێ" required></div>
                    </div>
                    <div id="book-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن پەرتووکێ بنڤیسە</p>
                        <div class="form-group"><label>ناڤێ پەرتووکێ:</label><input type="text" name="ناڤێ پەرتووکێ" required></div>
                        <div class="form-group"><label>ناڤێ نڤیسەری:</label><input type="text" name="نڤیسەرێ پەرتووکێ" required></div>
                        <div class="form-group"><label>لینکێ خواندنێ یان داگرتنێ (PDF):</label><input type="text" name="لینکێ پەرتووکێ" required></div>
                    </div>
                    <div class="form-group"><label>پەیوەندییا هنێرەری (بۆ نموونە ئیمێل یان تەلەفون - نە پێدڤیە):</label><input type="text" name="پەیوەندییا هنێرەری"></div>
                    <div class="form-group"><label>تێبینی یان پێشنیارەکا دی:</label><textarea name="تێبینی"></textarea></div>
                    <button type="submit" class="form-submit-btn">پشکداریێ هنێرە</button>
                </form>
            </div>
        </div>
    </div>

    <!-- پێ (Footer) -->
    <footer>
        <p>&copy; 2025 - پرۆژێ زانست. هەمی ماف پاراستینە.</p>
        <div style="color: var(--secondary-text); margin-top: 15px; font-size: 0.9rem;">
            ژمارا گشتی یا سەرەدانکەران: 
            <span id="visitor-counter" style="font-weight: bold; color: var(--primary-text); direction: ltr; display: inline-block;">...</span>
        </div>
        <div class="footer-contribution-area">
             <a href="#" class="contribution-link-btn" onclick="openModal('contribution-modal')">
                <i class="fas fa-hands-helping"></i>
                پشکداریێ بکە یان پێشنیارەکێ بکە
            </a>
        </div>
    </footer>

    <!-- JS Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
// ====================================================================================
// ============================= JAVASCRIPT CODE (UPDATED) ==========================
// ====================================================================================

(function() {

    // --- 1. DATA STRUCTURES ---
    let allData = {
        'teachers': {},
        'generalLectures': [],
        'pirtukxane': [],
        'locations': [],
        'liveCourse': {},
        'levels': []
    };

    // --- 2. GLOBAL VARIABLES ---
    let map = null, mapInitialized = false, mapMarkers = {};
    let completedLevelItems = []; // To track user's progress
    
    // --- 3. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loadingScreen = document.getElementById('loading-screen');
        try {
            completedLevelItems = JSON.parse(localStorage.getItem('completedLevelItems')) || [];

            await loadDataFromSheets();
            
            buildLiveView();
            document.getElementById('live-view').dataset.isBuilt = 'true';
            
            switchNav(document.querySelector('#main-nav a'), 'live-view');
            
            updateAndShowVisitorCount();
        } catch (error) {
            console.error("Çewtî di destpêkê da:", error);
            loadingScreen.innerHTML = '<div class="welcome-text" style="animation:none; opacity:1;">چەوتیەک روویدا د وەرگرتنا زانیارییان دا.<br>هیڤیدارین پەیوەندیێ ب پشتەڤانیا تەکنیکی بکە.</div>';
            return;
        } finally {
            loadingScreen.classList.add('fade-out');
        }
    });

    // --- 4. DATA LOADING & PROCESSING FROM GOOGLE SHEETS ---
    const publishedCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwD58WrboATMUyuRxuXDNExmN77tXF5nI4AVoVktJ6NGpg2EoMkFe8McZaUyn_q5HrT8grpYJdVgiq/pub?output=csv';

    async function loadDataFromSheets() {
        const sheetGIDs = {
            teachers: '0',
            generalLectures: '480195998',
            books: '420495992',
            locations: '1660455979',
            liveCourse: '1559180305',
            levels: '622488432' // GID for Levels sheet
        };

        try {
            const [
                teachersCsv, lecturesCsv, booksCsv, locationsCsv, liveCourseCsv, levelsCsv
            ] = await Promise.all([
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.teachers}`).then(res => res.text()),
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.generalLectures}`).then(res => res.text()),
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.books}`).then(res => res.text()),
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.locations}`).then(res => res.text()),
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.liveCourse}`).then(res => res.text()),
                fetch(`${publishedCsvUrl}&gid=${sheetGIDs.levels}`).then(res => res.text())
            ]);

            allData.teachers = processTeachersData(parseCSV(teachersCsv));
            allData.generalLectures = processGeneralLectures(parseCSV(lecturesCsv));
            allData.pirtukxane = processBooks(parseCSV(booksCsv));
            allData.locations = processLocationsData(parseCSV(locationsCsv));
            allData.liveCourse = processLiveCourseData(parseCSV(liveCourseCsv));
            allData.levels = processLevelsData(parseCSV(levelsCsv));

        } catch (error) {
            console.error('شکەستن د بارکرنا زانیارییان ژ گوگل شیتس:', error);
            throw error;
        }
    }

    function parseCSV(csvText) {
        if (!csvText) return [];
        const lines = csvText.trim().split(/\r\n|\n/);
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const obj = {};
            const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            for (let j = 0; j < headers.length; j++) {
                 if (values[j]) {
                    obj[headers[j]] = values[j].trim().replace(/^"|"$/g, '');
                 } else {
                    obj[headers[j]] = '';
                 }
            }
            result.push(obj);
        }
        return result;
    }
    
    function processTeachersData(dataArray) {
        const teachersObject = {};
        dataArray.forEach(row => {
            if (!row.id) return;
            const teacher = { id: row.id, name: row.name || '', profileImage: row.profileimage || `https://ui-avatars.com/api/?name=${(row.name || 'M').replace(' ', '+')}&background=random`, bio: row.bio || '', phone: row.phone || '', social: {} };
            if (row.social_youtube) teacher.social.youtube = row.social_youtube;
            if (row.social_telegram) teacher.social.telegram = row.social_telegram;
            if (row.social_facebook) teacher.social.facebook = row.social_facebook;
            teachersObject[row.id] = teacher;
        });
        return teachersObject;
    }
    
    function processLocationsData(dataArray) {
        return dataArray.map(loc => {
            if (!loc.locationid || !loc.coordinates) return null;
            const coords = loc.coordinates.split(',').map(c => parseFloat(c.trim()));
            if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) return null;
            return { id: loc.locationid, name: loc.locationname, coordinates: coords, teacherId: loc.teacherid, lessonTaught: loc.lessontaught, schedule: loc.schedule };
        }).filter(Boolean);
    }
    
    function processLiveCourseData(dataArray) {
        if (!dataArray || dataArray.length === 0) return {};
        const course = dataArray[0];
        return { title: course.title, teacherId: course.teacherid, description: course.description, nextSessionDate: course.nextsessiondate, prerequisites: course.prerequisites, topics: course.topics ? course.topics.split('|') : [], schedule: course.schedule ? course.schedule.split('|') : [] };
    }

    function processLevelsData(dataArray) {
        const levels = {};
        dataArray.forEach(row => {
            if (!row.level_id) return;
            if (!levels[row.level_id]) {
                levels[row.level_id] = {
                    id: row.level_id,
                    title: row.level_title,
                    description: row.level_description,
                    items: []
                };
            }
            levels[row.level_id].items.push({
                id: row.item_id,
                type: row.item_type,
                title: row.item_title,
                link: row.item_link,
                teacherId: row.item_teacher_id
            });
        });
        return Object.values(levels);
    }

    function parseVideos(videoString) {
        if (!videoString) return [];
        return videoString.split('|').map(v => {
            const parts = v.split(';');
            return { title: parts[0] || 'وانە', url: parts[1] || '#' };
        });
    }

    function processGeneralLectures(dataArray) {
        return dataArray.map(lec => ({ id: lec.id, title: lec.title, teacherId: lec.teacherid, category: lec.category, image: lec.image, videos: parseVideos(lec.videos) })).filter(lec => lec.id);
    }
    
    function processBooks(dataArray) {
        return dataArray.map(book => ({ title: book.title, author: book.author, category: book.category, coverImage: book.coverimage, readUrl: book.readurl, downloadUrl: book.downloadurl })).filter(book => book.title);
    }

    // --- 5. VIEW & MODAL MANAGEMENT ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('is-active'));
        document.getElementById(viewId)?.classList.add('is-active');
        window.scrollTo(0, 0);
        if (viewId === 'map-view' && map) setTimeout(() => map.invalidateSize(), 10);
    }

    function switchNav(element, viewId) {
        const targetView = document.getElementById(viewId);
        if (!targetView) return;
        if (!targetView.dataset.isBuilt) {
            const viewBuilders = { 'live-view': buildLiveView, 'waneyan-view': buildWaneyanView, 'pirtukxane-view': buildPirtukxaneView, 'teachers-view': buildTeachersView, 'map-view': buildMapView, 'levels-view': buildLevelsView };
            viewBuilders[viewId]?.();
            targetView.dataset.isBuilt = 'true';
        }
        document.querySelectorAll('#main-nav a').forEach(a => a.classList.remove('active'));
        element?.classList.add('active');
        showView(viewId);
        if (viewId === 'map-view' && !mapInitialized) initializeMainMap();
    }

    function openModal(modalId) { document.getElementById(modalId)?.classList.add('is-visible'); }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('is-visible');
            if (modalId === 'contribution-modal') resetContributionModal();
            if (modalId === 'teacher-profile-modal') document.getElementById('profile-dynamic-content').innerHTML = '';
        }
    }

    // --- 6. VIEW BUILDERS ---
    function buildWaneyanView() {
        const container = document.getElementById('waneyan-view');
        container.innerHTML = `<header class="page-header"><h1>وانەیێن گشتی</h1><p>وانە و زنجیرەیێن جودا جودا</p></header><div class="filters-container" id="waneyan-filters"></div><div class="waneyan-grid" id="waneyan-grid"></div>`;
        const categories = ['all', ...new Set(allData.generalLectures.map(l => l.category).filter(Boolean))];
        const teachers = ['all', ...new Set(allData.generalLectures.map(l => l.teacherId).filter(Boolean))];
        document.getElementById('waneyan-filters').innerHTML = `
            <div class="filter-group"><h4>بابەت:</h4>${categories.map(cat => `<button class="filter-btn ${cat === 'all' ? 'active' : ''}" data-filter-type="category" data-filter-value="${cat}">${cat === 'all' ? 'هەمووی' : cat}</button>`).join('')}</div>
            <div class="filter-group"><h4>مامۆستا:</h4>${teachers.map(tId => `<button class="filter-btn ${tId === 'all' ? 'active' : ''}" data-filter-type="teacher" data-filter-value="${tId}">${tId === 'all' ? 'هەمووی' : (allData.teachers[tId]?.name || tId)}</button>`).join('')}</div>`;
        document.querySelectorAll('#waneyan-filters .filter-btn').forEach(btn => btn.addEventListener('click', function() {
            document.querySelectorAll(`#waneyan-filters .filter-btn[data-filter-type="${this.dataset.filterType}"]`).forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterLectures();
        }));
        filterLectures();
    }

    function buildPirtukxaneView() {
        const container = document.getElementById('pirtukxane-view');
        container.innerHTML = `<header class="page-header"><h1>پەرتوکخانە</h1><p>کۆمەڵێک پەرتوکی پێشنیارکراو</p></header>
            <div class="pirtuk-grid">${allData.pirtukxane.map(book => `<div class="pirtuk-card"><img src="${book.coverImage}" class="pirtuk-card-img" alt="Berga Pirtûkê"><div class="pirtuk-card-content"><h3>${book.title}</h3><p><strong>نووسەر:</strong> ${book.author}</p><div class="card-btn-group"><a href="${book.readUrl}" target="_blank" class="card-btn-small">خواندن</a><a href="${book.downloadUrl}" target="_blank" class="card-btn-small secondary">داگرتن</a></div></div></div>`).join('')}</div>`;
    }

    function buildTeachersView() {
        const container = document.getElementById('teachers-view');
        container.innerHTML = `<header class="page-header"><h1>مامۆستایان</h1><p>پرۆفایلا مامۆستایێن بەشداربووی ببینە</p></header>
        <div class="teachers-grid">
            ${Object.values(allData.teachers).map(teacher => `
                <div class="teacher-card-simple">
                    <img src="${teacher.profileImage}" alt="${teacher.name}">
                    <h3>${teacher.name}</h3>
                    <p>${(teacher.bio || '').substring(0, 50)}...</p>
                    <a href="#" onclick="event.preventDefault(); showTeacherProfile('${teacher.id}')" class="profile-btn-simple">پرۆفایل ببینە</a>
                </div>
            `).join('')}
        </div>`;
    }
    
    function buildMapView() {
        const container = document.getElementById('map-view');
        container.innerHTML = `<header class="page-header"><h1>خەریتە</h1><p>جهێ وانەگوتنێ لسەر خەریتەی ببینە و لێ بگەڕە</p></header>
        <div id="map-view-layout">
            <div class="map-controls">
                <input type="text" id="map-search-input" class="map-search-input" placeholder="ل ناڤێ جهی، مامۆستای، یان وانەیێ بگەڕە..." onkeyup="renderLocationList()">
            </div>
            <div id="main-map-container"></div>
            <div id="location-list-container"></div>
        </div>`;
        renderLocationList();
    }

    function buildLiveView() {
        const container = document.getElementById('live-view');
        const course = allData.liveCourse;
        if (!course || !course.teacherId) {
             container.innerHTML = `<header class="page-header"><h1>خولێن ڕاستەوخۆ</h1><p style="color:var(--secondary-text)">نوکە چ خولێن ڕاستەوخۆ بەردەست نینن.</p></header>`;
             return;
        }
        const teacher = allData.teachers[course.teacherId];
        if (!teacher) { container.innerHTML = '<p>چەوتی: مامۆستایێ ڤێ خولێ نەهاتە دیتن.</p>'; return; }
        container.innerHTML = `<div class="live-view-content">
                <span class="live-badge">ڕاستەوخۆ</span><h1>${course.title}</h1><p class="live-teacher-info">دگەل: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${course.teacherId}')">${teacher.name}</a></p><p style="max-width: 700px; margin: 0 auto 30px;">${course.description}</p>
                <h3 style="margin-bottom: 10px;">جڤینا بهێت دێ دەستپێکەت پشتی:</h3><div id="live-countdown"></div>
                <div class="live-details-section"><h3 class="profile-section-title-new" style="text-align: right; border:none; padding-bottom: 0;">زانیاریێن زێدەتر</h3><h4><i class="fas fa-bullseye" style="color:var(--accent-color); margin-left: 8px;"></i>بابەتێن سەرەکی:</h4><ul style="margin-bottom: 20px;">${course.topics.map(t => `<li>${t}</li>`).join('')}</ul><h4><i class="fas fa-tasks" style="color:var(--accent-color); margin-left: 8px;"></i>پێدڤیێن خولێ:</h4><p style="margin-bottom: 20px;">${course.prerequisites}</p><h4><i class="fas fa-calendar-alt" style="color:var(--accent-color); margin-left: 8px;"></i>خشتێ جڤینان:</h4><ul>${course.schedule.map(s => `<li>${s}</li>`).join('')}</ul></div>
                <div id="live-registration-section"><h2 class="profile-section-title-new" style="text-align:center; border-bottom-width:2px; max-width:400px; margin: 40px auto 20px auto;">فورما پشکداریێ</h2><p style="color: var(--secondary-text); max-width: 600px; margin: 0 auto 20px;">ئەگەر تۆ حەزدکەی پشکداریێ بکەی، ڤێ فورمێ پر بکە.</p><form action="https://formspree.io/f/mvgqdwav" method="POST" class="live-registration-form"><input type="hidden" name="_subject" value="داواکاریەکا نووی بۆ خولا راستەوخۆ!"><div class="form-group"><label for="fullname">ناڤێ سیانی:</label><input type="text" id="fullname" name="ناڤ" required></div><div class="form-group"><label for="email">ئیمێل:</label><input type="email" id="email" name="ئیمێل" required></div><div class="form-group form-group-checkbox"><input type="checkbox" id="prereq" name="مەرج قەبیلکرن" value="بەلێ" required><label for="prereq">ئەز پشتراستم کو من مەرجێن پێدڤی هەنە</label></div><button type="submit" class="form-submit-btn">هنارتن</button></form></div>
            </div>`;
        startCountdown(course.nextSessionDate);
    }
    
    // ========== [UPDATED] - فەنکشنێن نوو و نویکری بۆ ئاستێن زانستی ==========

    /**
     * فەنکشنەکا ناڤەندی بۆ زانینا ستاتوسا هەر ئاستەکی (قفلە، بەردەوامە، یان تەمامبویە)
     * @param {string} levelId - ID یا ئاستێ پێدڤی
     * @returns {object} - Objectek تێدا ستاتوس و ڕێژا پێشکەفتنێ هەیە
     */
    function checkLevelCompletion(levelId) {
        const level = allData.levels.find(l => l.id === levelId);
        if (!level) return { status: 'locked', progress: 0 };

        // 1. ئاستێن ل پێشتر بهێنە پشکنین
        const levelIndex = allData.levels.findIndex(l => l.id === levelId);
        if (levelIndex > 0) {
            const prevLevel = allData.levels[levelIndex - 1];
            const prevLevelTotal = prevLevel.items.length;
            const prevLevelCompleted = prevLevel.items.filter(item => completedLevelItems.includes(item.id)).length;
            if (prevLevelTotal > 0 && prevLevelCompleted < prevLevelTotal) {
                return { status: 'locked', progress: 0 };
            }
        }
        
        // 2. ئەگەر قفل نەبوو، پێشکەفتنا وی بحەسبینە
        const totalItems = level.items.length;
        if (totalItems === 0) return { status: 'completed', progress: 100 }; // ئاستێ ڤالا، تەمام هاتیە حەسباندن

        const completedCount = level.items.filter(item => completedLevelItems.includes(item.id)).length;
        const progress = (completedCount / totalItems) * 100;
        
        if (progress === 100) return { status: 'completed', progress: 100 };
        return { status: 'in-progress', progress: progress };
    }
    
    /**
     * UI یا ئاستەکی لسەر بنەمایێ ستاتوسێ وی نوکە دکەت (کلاس، نیشان، ئایکۆن)
     * @param {string} levelId - ID یا ئاستێ پێدڤی بۆ نویکرنێ
     */
    function updateLevelUI(levelId) {
        const level = allData.levels.find(l => l.id === levelId);
        if (!level) return;

        const accordionBtn = document.querySelector(`.level-accordion[data-level-id="${levelId}"]`);
        if (!accordionBtn) return;
        
        const { status, progress } = checkLevelCompletion(levelId);

        // نویکرنا کلاس و نیشانان
        accordionBtn.classList.remove('locked', 'completed-level');
        const badge = accordionBtn.querySelector('.status-badge');
        const icon = accordionBtn.querySelector('.icon');

        if (status === 'locked') {
            accordionBtn.classList.add('locked');
            badge.textContent = 'قفلە';
            badge.className = 'status-badge locked';
            icon.className = 'icon fas fa-lock';
        } else if (status === 'completed') {
            accordionBtn.classList.add('completed-level');
            badge.textContent = 'تەمامبوویە';
            badge.className = 'status-badge completed';
            icon.className = 'icon fas fa-check';
        } else { // in-progress
            badge.textContent = 'بەردەوامە';
            badge.className = 'status-badge in-progress';
            icon.className = 'icon fas fa-chevron-right';
        }
        
        // نویکرنا پرا پێشکەفتنێ
        const progressBar = document.querySelector(`.progress-bar[data-level-id="${levelId}"]`);
        if(progressBar) progressBar.style.width = `${progress}%`;
    }
    
    /**
     * [UPDATED] دروستکرنا دیتنا ئاستێن زانستی ب ستایلێ پێشکەفتی
     */
    function buildLevelsView() {
        const container = document.getElementById('levels-view');
        if (!allData.levels || allData.levels.length === 0) {
            container.innerHTML = `<header class="page-header"><h1>ئاستێن زانستی</h1><p style="color:var(--secondary-text)">چ ئاستەک نەهاتیە تۆمارکرن.</p></header>`;
            return;
        }

        let content = `<header class="page-header"><h1>ئاستێن زانستی</h1><p>ب شێوەیەکێ تەدریجی و قۆناغ ب قۆناغ، زانستێ شەرعی بخوینە</p></header><div id="levels-accordion-container">`;

        allData.levels.forEach(level => {
            const { status, progress } = checkLevelCompletion(level.id);
            
            let accordionClass = 'level-accordion';
            let badgeClass = '';
            let badgeText = '';
            let iconElement = '<span class="icon fas fa-chevron-right"></span>';

            if (status === 'locked') {
                accordionClass += ' locked';
                badgeClass = 'locked';
                badgeText = 'قفلە';
                iconElement = '<span class="icon fas fa-lock"></span>';
            } else if (status === 'completed') {
                accordionClass += ' completed-level';
                badgeClass = 'completed';
                badgeText = 'تەمامبوویە';
                iconElement = '<span class="icon fas fa-check"></span>';
            } else { // in-progress
                badgeClass = 'in-progress';
                badgeText = 'بەردەوامە';
            }

            content += `
                <button class="${accordionClass}" onclick="toggleAccordion(this)" data-level-id="${level.id}">
                    <div class="level-accordion-header">
                        <div class="level-title-group">
                            <span class="status-badge ${badgeClass}">${badgeText}</span>
                            <span>${level.title}</span>
                        </div>
                        ${iconElement}
                    </div>
                </button>
                <div class="level-panel">
                    <div class="level-header">
                        <p>${level.description}</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${progress}%;" data-level-id="${level.id}"></div>
                        </div>
                    </div>
                    <div class="level-items-wrapper">
                        ${level.items.map(item => {
                            const isCompleted = completedLevelItems.includes(item.id);
                            const teacher = allData.teachers[item.teacherId];
                            const iconClass = item.type === 'book' ? 'fa-book' : 'fa-video';
                            return `
                                <div class="level-item-card ${isCompleted ? 'completed' : ''}" data-item-id="${item.id}">
                                    <input type="checkbox" class="item-checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleLevelItem('${item.id}', '${level.id}')">
                                    <i class="fas ${iconClass} item-icon"></i>
                                    <div class="item-details">
                                        <h4 class="item-title">${item.title}</h4>
                                        ${teacher ? `<p class="item-teacher">دگەل: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${teacher.id}')">${teacher.name}</a></p>` : ''}
                                    </div>
                                    <div class="item-actions">
                                        <a href="${item.link}" target="_blank" aria-label="لینک ببینە"><i class="fas fa-external-link-alt"></i></a>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
        });
        
        content += `</div>`;
        container.innerHTML = content;
    }
    
    /**
     * [UPDATED] ڤەکرن و داخستنا ئەکۆردیۆنێ ئاستی، ڕێگری ل ڤەکرنا یێ قفل دکەت
     */
    function toggleAccordion(button) {
        if (button.classList.contains('locked')) {
            return; // ئەگەر ئاست قفل بیت، چ نەکە
        }
        button.classList.toggle("active");
        const panel = button.nextElementSibling;
        const icon = button.querySelector('.icon');
        
        if (button.classList.contains('active')) {
            panel.style.maxHeight = panel.scrollHeight + "px";
            if (icon && !icon.classList.contains('fa-check') && !icon.classList.contains('fa-lock')) { 
                 icon.style.transform = 'rotate(90deg)';
            }
        } else {
            panel.style.maxHeight = null;
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    /**
     * [UPDATED] تەمامکرنا باباتەکی، و پشکنین بۆ ڤەکرنا ئاستێ ل دویڤ
     */
    function toggleLevelItem(itemId, levelId) {
        const card = document.querySelector(`.level-item-card[data-item-id="${itemId}"]`);
        const isCompleted = card.querySelector('.item-checkbox').checked;

        if (isCompleted) {
            if (!completedLevelItems.includes(itemId)) completedLevelItems.push(itemId);
            card.classList.add('completed');
        } else {
            completedLevelItems = completedLevelItems.filter(id => id !== itemId);
            card.classList.remove('completed');
        }
        
        localStorage.setItem('completedLevelItems', JSON.stringify(completedLevelItems));
        
        // UI یا ئاستێ نوکە نوکەڤە بکە
        updateLevelUI(levelId);

        // پشکنین بکە کا ئاستێ نوکە تەمام بوویە، ئەگەر بەلێ، یێ ل دویڤ ڤەبکە
        const currentLevelState = checkLevelCompletion(levelId);
        if (currentLevelState.status === 'completed') {
            const currentLevelIndex = allData.levels.findIndex(l => l.id === levelId);
            if (currentLevelIndex < allData.levels.length - 1) {
                const nextLevel = allData.levels[currentLevelIndex + 1];
                updateLevelUI(nextLevel.id); // ئەڤە دێ ستاتوسێ وی ژ 'قفل' گوهوریت بۆ 'بەردەوامە'
            }
        }
    }

    // --- 7. HELPER FUNCTIONS (OTHER) ---
    function filterLectures() {
        const activeCategory = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="category"].active').dataset.filterValue;
        const activeTeacher = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="teacher"].active').dataset.filterValue;
        const grid = document.getElementById('waneyan-grid');
        const filteredLectures = allData.generalLectures.filter(l => (activeCategory === 'all' || l.category === activeCategory) && (activeTeacher === 'all' || l.teacherId === activeTeacher));
        grid.innerHTML = filteredLectures.length ? filteredLectures.map(lecture => {
            const teacher = allData.teachers[lecture.teacherId];
            return `<div class="wana-card"><img src="${lecture.image}" class="wana-card-img" alt="Wêneya Waneyê"><div class="wana-card-content"><h3>${lecture.title}</h3><p><strong>مامۆستا:</strong> <a href="#" onclick="event.preventDefault(); showTeacherProfile('${lecture.teacherId}')">${teacher?.name || 'نەناسراو'}</a></p><p><strong>بابەت:</strong> ${lecture.category}</p><div class="card-btn-group"><button class="card-btn-small" onclick="showLessonList('${lecture.id}')">لیستی وانەکان</button><button class="card-btn-small secondary" onclick="showTeacherProfile('${lecture.teacherId}')">پرۆفایل</button></div></div></div>`;
        }).join('') : '<p style="text-align:center; grid-column: 1 / -1;">هیچ وانەیەک لسەر ڤان فیلتەران نەهاتە دیتن.</p>';
    }

    function showLessonList(lectureId) {
        const lecture = allData.generalLectures.find(l => l.id === lectureId);
        if (!lecture) return;
        openModal('lesson-list-modal');
        document.getElementById('lesson-list-title').textContent = lecture.title;
        document.getElementById('lesson-list-container').innerHTML = lecture.videos.map(video => `<div class="lesson-item clickable" onclick="window.open('${video.url}','_blank')"><span>${video.title}</span><button class="watch-btn">تەماشەکرن</button></div>`).join('');
    }
    
    function showTeacherProfile(teacherId) {
        const teacher = allData.teachers[teacherId];
        if (!teacher) return;
        openModal('teacher-profile-modal');
        const container = document.getElementById('profile-dynamic-content');
        
        let contactHTML = Object.entries(teacher.social).map(([platform, url]) => {
            if(url && url.trim() !== '') return `<a href="${url}" target="_blank"><i class="fab fa-${platform.toLowerCase()}"></i> ${platform.charAt(0).toUpperCase() + platform.slice(1)}</a>`;
            return '';
        }).join('');
        if (teacher.phone && teacher.phone.trim() !== '') {
            contactHTML = `<a href="tel:${teacher.phone}"><i class="fas fa-phone"></i> ${teacher.phone}</a>` + contactHTML;
        }

        const teacherLectures = allData.generalLectures.filter(l => l.teacherId === teacherId);
        const lessonsHTML = teacherLectures.map(l => `<div class="lesson-item-new"><div class="lesson-info"><i class="fas fa-video"></i> <span>${l.title}</span></div><button class="watch-btn-new" onclick="closeModal('teacher-profile-modal');showLessonList('${l.id}')">وانەکان ببینە</button></div>`).join('');
        
        const teacherLocations = allData.locations.filter(loc => loc.teacherId === teacherId);
        let locationsHTML = '';
        if (teacherLocations.length > 0) {
            locationsHTML = `
            <div style="padding: 0 30px 30px 30px; background-color: var(--dark-bg);">
                <div class="profile-tabbed-content">
                    <h3 class="profile-section-title-new"><i class="fas fa-map-marker-alt"></i> جهێن وانەگوتنێ</h3>
                    <div class="profile-locations-panel" style="display: grid; gap: 15px;">
                        ${teacherLocations.map(loc => `
                            <div class="location-list-item" style="cursor: default; border-left-color: var(--border-color); transform: none; background: var(--dark-bg);">
                                <h4>${loc.name}</h4>
                                <p><i class="fas fa-book-open"></i> <span><strong>وانە:</strong> ${loc.lessonTaught}</span></p>
                                <p><i class="fas fa-clock"></i> <span><strong>کەنگی:</strong> ${loc.schedule}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        const mainProfileHTML = `
            <div class="profile-new-header"><div class="profile-header-img-wrapper"><img src="${teacher.profileImage}" alt="Wêneyê Profaylê"></div></div>
            <div style="text-align: center; margin-top: -60px; position:relative; z-index:2;"><h2 id="profile-header-name-new">${teacher.name}</h2><p id="profile-header-bio-new">${teacher.bio}</p></div>
            <div class="profile-new-grid">
                <div class="profile-main-info"><h3 class="profile-section-title-new"><i class="fas fa-link"></i> پەیوەندی</h3><div class="profile-contact-buttons">${contactHTML || '<p style="color:var(--secondary-text);">هیچ زانیارییەکی پەیوەندی نییە.</p>'}</div></div>
                <div class="profile-tabbed-content"><h3 class="profile-section-title-new"><i class="fas fa-book-reader"></i> وانەیێن گشتی</h3><div class="profile-lessons-panel">${lessonsHTML || '<p style="color:var(--secondary-text); text-align:center;">هیچ وانەیەک بۆ ڤی مامۆستای نەهاتیە تۆمارکرن.</p>'}</div></div>
            </div>`;
            
        container.innerHTML = mainProfileHTML + locationsHTML;
    }

    function updateAndShowVisitorCount() {
        const counterElement = document.getElementById('visitor-counter');
        if (!counterElement) return;
        fetch(`https://api.countapi.xyz/hit/proje-zanst-badini/visits`).then(res => res.json()).then(data => { counterElement.textContent = new Intl.NumberFormat('en-US').format(data.value); }).catch(err => { console.error("Çewtî di wergirtina jimara seredankera da:", err); counterElement.textContent = "N/A"; });
    }
    
    function renderLocationList() {
        const container = document.getElementById('location-list-container');
        const searchInput = document.getElementById('map-search-input');
        if (!container) return;
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const filteredLocations = allData.locations.filter(loc => {
            const teacherName = allData.teachers[loc.teacherId]?.name || '';
            return loc.name.toLowerCase().includes(searchTerm) || loc.lessonTaught.toLowerCase().includes(searchTerm) || teacherName.toLowerCase().includes(searchTerm);
        });
        container.innerHTML = filteredLocations.map(loc => {
            const teacher = allData.teachers[loc.teacherId];
            return `<div class="location-list-item" onclick="focusOnMapLocation('${loc.id}')"><h4>${loc.name}</h4><p><i class="fas fa-chalkboard-teacher"></i> <span><strong>مامۆستا:</strong> ${teacher ? teacher.name : 'نەناسراو'}</span></p><p><i class="fas fa-book-open"></i> <span><strong>وانە:</strong> ${loc.lessonTaught}</span></p><p><i class="fas fa-clock"></i> <span><strong>کەنگی:</strong> ${loc.schedule}</span></p></div>`;
        }).join('');
    }

    // --- 8. OTHER FEATURES & LOGIC ---
    function initializeMainMap() {
        if (mapInitialized || !document.getElementById('main-map-container')) return;
        map = L.map('main-map-container').setView([36.85, 42.98], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
        mapMarkers = {};
        allData.locations.forEach(location => {
            const teacher = allData.teachers[location.teacherId];
            const marker = L.marker(location.coordinates).addTo(map);
            marker.bindPopup(`<div style="text-align:center;font-family:var(--font-kurdish);"><h4 style="margin:0;font-size:1.1rem;">${location.name}</h4><p style="margin:5px 0;"><strong>مامۆستا:</strong> ${teacher ? teacher.name : 'نەناسراو'}</p><p style="margin:5px 0;font-size:0.9rem;"><strong>وانە:</strong> ${location.lessonTaught}</p></div>`);
            mapMarkers[location.id] = marker;
        });
        mapInitialized = true;
    }
    
    function focusOnMapLocation(locationId) {
        if (!map || !mapMarkers[locationId]) return;
        const location = allData.locations.find(l => l.id === locationId);
        if (!location) return;
        map.setView(location.coordinates, 15);
        mapMarkers[locationId].openPopup();
        window.scrollTo({ top: document.getElementById('main-map-container').offsetTop - 100, behavior: 'smooth' });
    }

    function startCountdown(targetDateStr) {
        const countdownContainer = document.getElementById('live-countdown');
        if(!countdownContainer || !targetDateStr) return;
        const targetDate = new Date(targetDateStr).getTime();
        const interval = setInterval(() => {
            const distance = targetDate - new Date().getTime();
            if (distance < 0) { clearInterval(interval); countdownContainer.innerHTML = "<h3>خول دەستپێکریە یان ب دوماهیک هاتیە!</h3>"; return; }
            const time = { days: Math.floor(distance / (1000 * 60 * 60 * 24)), hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)), minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)), seconds: Math.floor((distance % (1000 * 60)) / 1000) };
            countdownContainer.innerHTML = `<div class="countdown-box"><div class="number">${time.days}</div><div class="label">ڕۆژ</div></div><div class="countdown-box"><div class="number">${time.hours}</div><div class="label">دەمژمێر</div></div><div class="countdown-box"><div class="number">${time.minutes}</div><div class="label">خولەک</div></div><div class="countdown-box"><div class="number">${time.seconds}</div><div class="label">چرکە</div></div>`;
        }, 1000);
    }
    
    function showContributionFields(type) {
        document.getElementById('contribution-form').style.display = 'block'; 
        document.getElementById('contribution_type_input').value = { teacher: 'پێشنیارا مامۆستای', lesson: 'پێشنیارا وانەیێ', book: 'پێشنیارا پەرتووکێ' }[type] || '';
        document.querySelectorAll('.form-fields-group').forEach(group => group.style.display = 'none'); 
        document.getElementById(`${type}-fields`).style.display = 'block';
        document.querySelectorAll('.contribution-type-btn').forEach(btn => btn.classList.remove('active')); 
        document.querySelector(`.contribution-type-btn[onclick*="'${type}'"]`).classList.add('active');
    }

    function resetContributionModal() {
        const form = document.getElementById('contribution-form'); 
        form.style.display = 'none'; 
        form.reset(); 
        document.querySelectorAll('.form-fields-group').forEach(group => group.style.display = 'none'); 
        document.querySelectorAll('.contribution-type-btn').forEach(btn => btn.classList.remove('active'));
    }

    // Export functions to global scope for onclick attributes
    window.switchNav = switchNav; window.openModal = openModal; window.closeModal = closeModal; 
    window.showLessonList = showLessonList; window.showTeacherProfile = showTeacherProfile; 
    window.showContributionFields = showContributionFields;
    window.renderLocationList = renderLocationList; window.focusOnMapLocation = focusOnMapLocation;
    window.toggleAccordion = toggleAccordion; window.toggleLevelItem = toggleLevelItem;
    
})(); // --> End of JavaScript code

</script>
</body>
</html>
