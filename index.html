<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پرۆژێ تەوحید</title>
<!-- CSS Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
<style>
/* --- CSS گشتی و گۆڕاوەکان --- */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');

:root {
    --dark-bg: #0d1117;
    --card-bg: #161b22;
    --primary-text: #c9d1d9;
    --secondary-text: #8b949e;
    --accent-color: #58a6ff;
    --border-color: #30363d;
    --success-color: #2ea043;
    --danger-color: #f85149;
    --warning-color: #f0b429;
    --font-kurdish: 'Noto Sans Arabic', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { 
    scroll-behavior: smooth;
    scroll-padding-top: 80px;
}
body { font-family: var(--font-kurdish); background-color: var(--dark-bg); color: var(--primary-text); line-height: 1.7; }
a { color: var(--accent-color); text-decoration: none; }
a:hover { text-decoration: underline; }
.container { width: 90%; max-width: 1200px; margin: auto; }

/* --- شاشەیا چاڤەڕوانیێ (Loading Screen) --- */
#loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1f2e 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
#loading-screen.fade-out { opacity: 0; pointer-events: none; }
.loading-logo { font-size: 4rem; font-weight: 700; color: var(--primary-text); margin-bottom: 20px; animation: pulse 2s infinite; }
.loading-logo span { color: var(--accent-color); }
.welcome-text { font-size: 1.5rem; color: var(--secondary-text); text-align: center; margin-bottom: 30px; animation: fadeInUp 1s ease-out 0.5s both; }
.loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }

/* --- ئەنیمەیشنەکان --- */
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- سەرە (Header) و پێ (Footer) --- */
header { position: sticky; top: 0; width: 100%; padding: 15px 0; z-index: 1000; background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); }
header .container { display: flex; justify-content: space-between; align-items: center; }
.logo { font-size: 26px; font-weight: 700; text-decoration: none; color: var(--primary-text); cursor: pointer; }
.logo span { color: var(--accent-color); }

/* گوهۆڕینی نوێ: دیکما ڤەگەریانێ */
#back-to-home-btn {
    display: none; /* By default hidden */
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--primary-text);
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-kurdish);
    font-size: 0.9rem;
    transition: all 0.3s ease;
    align-items: center;
    gap: 8px;
}
#back-to-home-btn:hover {
    background: var(--border-color);
    border-color: var(--accent-color);
    text-decoration: none;
}


footer { padding: 40px 20px; text-align: center; border-top: 1px solid var(--border-color); margin-top: 50px; color: var(--secondary-text); }
.footer-social-links { margin: 25px 0; display: flex; justify-content: center; gap: 20px; }
.footer-social-links a { font-size: 1.8rem; color: var(--secondary-text); transition: color 0.3s ease, transform 0.3s ease; }
.footer-social-links a:hover { color: var(--accent-color); transform: translateY(-3px); }

/* --- ستایلێ گشتی بۆ بەشان --- */
.view-section {
    padding: 50px 0;
    display: none; /* هەمی بەش ڤەشارتی دبن ب شێوەیێ بنەرەت */
}
.view-section.is-visible {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
}
.page-header { text-align: center; padding: 50px 20px; }
.page-header h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(120deg, var(--primary-text), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
.empty-state-message { text-align: center; color: var(--secondary-text); padding: 50px 20px; font-size: 1.1rem; }

/* === ستایلی نوێ و سەرنجراکێش بۆ مالپەرێ سەرەکی === */
#home-view.is-visible {
    padding: 0; /* No extra padding for the home view wrapper */
}
.home-hero-section {
    min-height: 70vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 60px 20px;
    background: linear-gradient(160deg, rgba(13, 17, 23, 0.95), rgba(13, 17, 23, 0.6)), url('https://images.unsplash.com/photo-1585036919222-91184de2a58b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1740&q=80') no-repeat center center/cover;
    border-bottom: 2px solid var(--accent-color);
}
.home-hero-section h1 {
    font-size: 4.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 20px;
    text-shadow: 0 5px 20px rgba(0,0,0,0.5);
    animation: fadeInUp 1s ease-out;
}
.home-hero-section h1 span {
    background: linear-gradient(120deg, #ffffff, var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
}
.home-hero-section p {
    font-size: 1.5rem;
    color: var(--primary-text);
    max-width: 800px;
    margin: 0 auto 30px auto;
    animation: fadeInUp 1.2s ease-out;
}
.home-hero-section .hero-cta-btn {
    animation: fadeInUp 1.4s ease-out;
}

.home-navigation-container {
    padding: 80px 20px;
}
.home-navigation-container h2 {
    text-align: center;
    font-size: 2.8rem;
    margin-bottom: 50px;
    color: var(--primary-text);
    position: relative;
    padding-bottom: 15px;
}
.home-navigation-container h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background-color: var(--accent-color);
    border-radius: 2px;
}

.main-navigation-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
    gap: 30px; 
}
.main-navigation-card { 
    display: block; 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    border-radius: 12px; 
    padding: 30px; 
    text-align: center; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    position: relative;
    overflow: hidden;
}
.main-navigation-card:hover { 
    transform: translateY(-8px); 
    border-color: var(--accent-color); 
    box-shadow: 0 10px 30px rgba(88, 166, 255, 0.1); 
    text-decoration: none; 
}
.main-navigation-card i { 
    font-size: 3rem; 
    color: var(--accent-color); 
    margin-bottom: 20px; 
    display: block;
    transition: transform 0.3s ease;
}
.main-navigation-card:hover i {
    transform: scale(1.1);
}
.main-navigation-card h3 { 
    font-size: 1.5rem; 
    color: var(--primary-text); 
    margin-bottom: 10px; 
}
.main-navigation-card p { 
    color: var(--secondary-text); 
    font-size: 1rem; 
}

@media (max-width: 768px) {
    .home-hero-section h1 { font-size: 2.8rem; }
    .home-hero-section p { font-size: 1.1rem; }
}
/* === کۆتایی ستایلی ماڵپەڕی سەرەکی === */

/* ستایلێ بەشێ سەرنجراکێش (Hero Section) - بۆ بەشێ ئاستەکان */
.hero-section { text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(22, 27, 34, 0.1), rgba(13, 17, 23, 0.3)), var(--dark-bg); border-radius: 12px; margin-bottom: 50px; border: 1px solid var(--border-color); }
.hero-title { font-size: 2.8rem; font-weight: 700; margin-bottom: 20px; background: linear-gradient(120deg, var(--primary-text), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
.hero-subtitle { font-size: 1.2rem; color: var(--secondary-text); max-width: 700px; margin: 0 auto 30px auto; line-height: 1.8; }
.hero-cta-btn { background-color: var(--accent-color); color: #fff; padding: 12px 30px; font-size: 1.1rem; font-weight: 500; border-radius: 8px; text-decoration: none; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; }
.hero-cta-btn:hover { background-color: #79c0ff; transform: translateY(-3px); box-shadow: 0 8px 15px rgba(88, 166, 255, 0.2); }

/* === ستایلێ ئایکۆنا ژێبرنا پێشکەفتنێ === */
.page-header-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
.reset-progress-icon {
    background: none;
    border: none;
    color: var(--secondary-text);
    font-size: 1.3rem;
    cursor: pointer;
    transition: color 0.3s, transform 0.3s;
    padding: 5px;
}
.reset-progress-icon:hover {
    color: var(--danger-color);
    transform: rotate(15deg);
    text-decoration: none;
}

/* ستایلێ پەیامێن حالەتان (STP System) */
.status-message-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 50vh; text-align: center; padding: 40px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; }
.status-icon { font-size: 4rem; margin-bottom: 25px; }
.status-icon.status-info { color: var(--accent-color); }
.status-icon.status-warning { color: var(--warning-color); }
.status-icon.status-danger { color: var(--danger-color); }
.status-icon.status-success { color: var(--success-color); }
.status-title { font-size: 2rem; margin-bottom: 15px; color: var(--primary-text); }
.status-text { font-size: 1.1rem; color: var(--secondary-text); max-width: 500px; }
.status-text a { font-weight: bold; }

/* --- وانە و پەرتوکخانە (General Cards & Grids) --- */
.filters-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; align-items: center; background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color);}
.filter-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
.filter-group h4 { margin: 0 15px 0 0; font-weight: 500; color: var(--primary-text); }
.filter-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: all .3s ease; }
.filter-btn:hover, .filter-btn.active { background: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
.waneyan-grid, .pirtuk-grid, .book-sales-grid { display: grid; gap: 25px; }
.waneyan-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
.pirtuk-grid, .book-sales-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
.wana-card, .pirtuk-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s; }
.wana-card:hover, .pirtuk-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--accent-color); }
.wana-card-img { width: 100%; height: 180px; object-fit: cover; }
.pirtuk-card-img { width: 100%; height: 320px; object-fit: cover; border-bottom: 1px solid var(--border-color);}
.wana-card-content, .pirtuk-card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
.card-btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; }
.card-btn-small { flex: 1; background: var(--accent-color); color: #fff; padding: 10px; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
.card-btn-small.secondary { background: var(--border-color); }
.card-btn-small:hover { opacity: 0.9; text-decoration: none;}
.pdf-btn-card { flex: 0 1 50px; background-color: var(--border-color); }
.pdf-btn-card:hover { background-color: var(--danger-color); }

/* === ستایلێن فرۆتنا پەرتووکان === */
.book-sale-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; }
.book-sale-card:hover { transform: translateY(-6px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); border-color: var(--accent-color); }
.book-sale-card-img-wrapper { position: relative; width: 100%; padding-top: 130%; }
.book-sale-card-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
.book-sale-card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
.book-sale-card h3 { font-size: 1.2rem; color: var(--primary-text); margin-bottom: 5px; }
.book-sale-card-author { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 15px; }
.book-sale-card-desc { font-size: 0.95rem; color: var(--primary-text); margin-bottom: 20px; line-height: 1.6; }
.book-sale-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid var(--border-color); }
.book-price { font-size: 1.5rem; font-weight: bold; color: var(--accent-color); }
.purchase-btn { background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s; }
.purchase-btn:hover { opacity: 0.9; text-decoration: none; }
.purchase-btn:disabled { background-color: var(--secondary-text); cursor: not-allowed; opacity: 0.7; }

/* ستایلێن بەشێ مامۆستایان */
#teachers-view .teachers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
.teacher-card-simple { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; text-align: center; padding: 25px; transition: all 0.3s ease; }
.teacher-card-simple:hover { transform: translateY(-5px); border-color: var(--accent-color); }
.teacher-card-simple img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--dark-bg); box-shadow: 0 0 0 3px var(--border-color); margin-bottom: 15px; }
.teacher-card-simple h3 { font-size: 1.2rem; color: var(--primary-text); margin-bottom: 5px; }
.teacher-card-simple p { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 15px; }
.teacher-card-simple .profile-btn-simple { background: var(--accent-color); color: white; padding: 8px 20px; border-radius: 6px; text-decoration: none; display: inline-block; font-size: 0.9rem; }

/* ستایلێن نووی بۆ بەشێ پسیار و بەرسڤ و حەدیس */
.fatwa-controls-new, .hadith-controls-new { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); }
.fatwa-filter-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
.fatwa-filter-group h4 { margin: 0 15px 0 0; font-weight: 500; color: var(--primary-text); }
.fatwa-scholar-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: all .3s ease; font-family: var(--font-kurdish); }
.fatwa-scholar-btn:hover, .fatwa-scholar-btn.active { background: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
.search-input-new { width: 100%; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px 15px; border-radius: 8px; font-family: var(--font-kurdish); }
.search-input-new:focus { border-color: var(--accent-color); outline: none; }

.fatwa-accordion-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
.fatwa-question { padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.fatwa-question h4 { margin: 0; font-size: 1.1rem; }
.fatwa-question i { transition: transform 0.3s; }
.fatwa-accordion-item.active .fatwa-question i { transform: rotate(180deg); }
.fatwa-answer { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; padding: 0 25px; }
.fatwa-answer-content { padding-bottom: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
.fatwa-answer-content p { margin-bottom: 15px; white-space: pre-wrap; }
.fatwa-teacher-info { color: var(--secondary-text); font-style: italic; }
.fatwa-teacher-info a { color: var(--accent-color); font-weight: bold; }

/* ستایلێ پلەیەرێ دەنگی */
.audio-player-wrapper { margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
.audio-player-wrapper p { font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.audio-player-wrapper audio { width: 100%; height: 40px; }
audio::-webkit-media-controls-panel { background-color: var(--dark-bg); }
audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display,
audio::-webkit-media-controls-mute-button,
audio::-webkit-media-controls-volume-slider,
audio::-webkit-media-controls-fullscreen-button { color: var(--primary-text); }

/* --- دیتنا خەریتێ (Map View) --- */
#map-view-layout { display: flex; flex-direction: column; gap: 30px; }
.map-controls { display: flex; justify-content: center; padding: 20px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); }
.map-search-input { width: 100%; max-width: 500px; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px 15px; border-radius: 8px; font-family: var(--font-kurdish); }
#main-map-container { height: 60vh; min-height: 400px; max-height: 500px; border-radius: 10px; border: 1px solid var(--border-color); }
#location-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
.location-list-item { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--border-color); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease; }
.location-list-item:hover { transform: translateY(-4px); border-left-color: var(--accent-color); background-color: #1c222c; }
.location-list-item h4 { font-size: 1.2rem; color: var(--primary-text); margin-bottom: 15px; }
.location-list-item p { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; color: var(--secondary-text); }
.location-list-item p i { color: var(--accent-color); font-size: 1rem; margin-top: 4px; }
.leaflet-popup-content .profile-link-in-popup { color: var(--accent-color); font-weight: bold; margin-top: 10px; display: inline-block; }

/* --- مۆدالەکان (Modals) --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
.modal-overlay.is-visible { display: flex; animation: fadeIn 0.3s; }
.modal-content { position: relative; width: 90%; background:var(--card-bg); border-radius:10px; max-height: 85vh; overflow-y: auto; }
.close-modal-btn { position: absolute; top: 15px; right: 20px; color: var(--secondary-text); font-size: 2rem; cursor: pointer; z-index: 10; }
#lesson-list-modal .modal-content { max-width: 600px; padding: 30px; }
#lesson-list-modal h3 { margin-bottom: 20px; text-align: center; font-size: 1.5rem; }
.lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-right: 3px solid var(--border-color); transition: all .3s; }
.lesson-item:hover { border-right-color: var(--accent-color); background-color: var(--border-color); }
.lesson-item span { font-size: 1rem; }
.lesson-item.clickable { cursor: pointer; }
.watch-btn { background: none; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 5px 12px; border-radius: 5px; cursor: pointer; }

/* مۆدالێ پلەیەرا میدیایێ (ڤیدیۆ، دەنگ، هتد) */
#media-player-modal .modal-content { max-width: 900px; padding: 25px; background-color: var(--dark-bg); overflow: hidden; }
#media-player-modal .close-modal-btn { top: 10px; right: 15px; color: var(--primary-text); }
#media-player-title { font-size: 1.4rem; margin-bottom: 20px; text-align: center; }
.media-player-container { position: relative; width: 100%; padding-top: 56.25%; /* 16:9 Aspect Ratio */ }
.media-player-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
.media-player-container audio { width: 100%; margin-top: 20px; }

/* مۆدالێ پیشاندانا PDF */
#pdf-viewer-modal .modal-content { max-width: 900px; padding: 25px; background-color: var(--dark-bg); overflow: hidden; height: 90vh; display: flex; flex-direction: column; }
#pdf-viewer-title { font-size: 1.4rem; margin-bottom: 20px; text-align: center; flex-shrink: 0; }
.pdf-iframe-container { position: relative; width: 100%; flex-grow: 1; }
.pdf-iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

/* مۆدالێ پرۆفایلێ */
#teacher-profile-modal .modal-content { max-width: 800px; padding: 0; overflow: hidden; background-color: var(--dark-bg); }
#profile-dynamic-content { max-height: 85vh; overflow-y: auto; }
#profile-dynamic-content::-webkit-scrollbar { width: 8px; }
#profile-dynamic-content::-webkit-scrollbar-track { background: var(--dark-bg); }
#profile-dynamic-content::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; }
#profile-dynamic-content::-webkit-scrollbar-thumb:hover { background-color: var(--secondary-text); }
.profile-new-header { background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://picsum.photos/1000/300?blur=5') no-repeat center center/cover; padding: 40px 20px 80px 20px; position: relative; text-align: center; }
.profile-header-img-wrapper { position: relative; width: 150px; height: 150px; margin: auto; margin-top: -100px; top: 60px; border-radius: 50%; background: linear-gradient(45deg, var(--accent-color), var(--success-color)); padding: 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
.profile-header-img-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid var(--dark-bg); }
#profile-header-name-new { font-size: 2.2rem; margin-top: 15px; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
#profile-header-bio-new { color: var(--primary-text); max-width: 600px; margin: 10px auto 0 auto; font-size: 1rem; }
.profile-new-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; padding: 40px 30px 30px 30px; background-color: var(--dark-bg); }
.profile-main-info, .profile-tabbed-content { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 25px; }
.profile-section-title-new { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary-text); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
.profile-contact-buttons { display: flex; flex-direction: column; gap: 15px; }
.profile-contact-buttons a { background: var(--dark-bg); color: var(--secondary-text); padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; text-decoration: none; }
.profile-contact-buttons a:hover { background: var(--border-color); color: var(--primary-text); transform: translateX(4px); }
.profile-contact-buttons a i { font-size: 1.3rem; width: 25px; text-align: center; }
.lesson-item-new { display: flex; align-items: center; justify-content: space-between; gap: 15px; background: var(--dark-bg); padding: 12px 18px; border-radius: 8px; margin-bottom: 10px; transition: all 0.3s ease; }
.lesson-item-new:hover { background: var(--border-color); }
.lesson-item-new .lesson-info { display: flex; align-items: center; gap: 12px; }
.lesson-item-new .lesson-info i { color: var(--accent-color); }
.lesson-item-new .lesson-info span { font-size: 1rem; }
.lesson-actions { display: flex; align-items: center; gap: 10px; }
.lesson-item-new .watch-btn-new { background: var(--accent-color); color: white; padding: 6px 15px; border-radius: 6px; text-decoration: none; border: none; cursor: pointer; font-size: 0.9rem; transition: opacity .3s; }
.lesson-item-new .watch-btn-new:hover { opacity: 0.85; }
.pdf-btn-new { display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; background-color: var(--border-color); color: var(--primary-text); border-radius: 6px; text-decoration: none; font-size: 1.2rem; transition: all 0.3s ease; }
.pdf-btn-new:hover { background-color: var(--danger-color); color: white; }
@media (max-width: 900px) { .profile-new-grid { grid-template-columns: 1fr; } }

/* --- خولێن ڕاستەوخۆ (Live Course) --- */
.live-view-content { text-align: center; padding: 40px 20px; }
.live-view-content .live-badge { background-color: var(--danger-color); color: white; padding: 5px 15px; border-radius: 50px; font-size: 1rem; display: inline-block; margin-bottom: 20px; animation: livePulse 2s infinite; }
@keyframes livePulse { 0% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(248, 81, 73, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0); } }
.live-view-content h1 { font-size: 2.5rem; margin-bottom: 15px; }
.live-view-content .live-teacher-info { margin-bottom: 30px; font-size: 1.2rem; }
#live-countdown { display: flex; justify-content: center; gap: 10px; margin: 40px 0; flex-wrap: wrap; }
.countdown-box { background: var(--card-bg); padding: 15px; border-radius: 10px; min-width: 80px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
.countdown-box .number { font-size: 2rem; font-weight: 700; color: var(--accent-color); }
.countdown-box .label { font-size: 0.8rem; color: var(--secondary-text); }
.live-details-section { max-width: 800px; margin: 40px auto; text-align: right; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }
.live-details-section ul { list-style-position: inside; padding-right: 20px; }

@media (max-width: 768px) {
    .page-header h1 { font-size: 2rem; }
    .live-view-content h1 { font-size: 2rem; }
    .hero-title { font-size: 2.2rem; }
}

/* --- فۆرمەکان (Forms) --- */
.form-group { margin-bottom: 20px; text-align: right; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
.form-group input[type="text"], .form-group input[type="email"], .form-group textarea, .form-group input[type="password"] { width: 100%; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px; border-radius: 6px; font-family: var(--font-kurdish); }
.form-group input:focus, .form-group textarea:focus { border-color: var(--accent-color); outline: none; }
.form-group textarea { min-height: 120px; resize: vertical; }
.form-group-checkbox { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
.form-submit-btn { width: 100%; padding: 12px; font-size: 1.1rem; background-color: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-kurdish); transition: background-color .3s; }
.form-submit-btn:hover { opacity: .9; }
.form-submit-btn:disabled { background-color: var(--secondary-text); cursor: not-allowed; }
.live-registration-form { max-width: 600px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }

/* === ستایلێن نووی بۆ بەشێ ئاستان === */
.levels-container { display: flex; flex-direction: column; gap: 30px; }
.level-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
.level-card-header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.level-title-group { display: flex; align-items: center; gap: 15px; }
.level-number-badge { font-size: 1.5rem; font-weight: bold; color: var(--accent-color); background-color: var(--dark-bg); border: 2px solid var(--border-color); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.level-card-header h2 { font-size: 1.8rem; margin: 0; }
.level-progress-bar { width: 120px; height: 8px; background-color: var(--dark-bg); border-radius: 5px; overflow: hidden; }
.level-progress-bar-inner { height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.5s ease; }
.level-meta { display: flex; align-items: center; gap: 15px; color: var(--secondary-text); }
.level-courses-list { padding: 0 25px 25px; border-top: 1px solid var(--border-color); margin-top: 20px; }

.level-course-wrapper {
    border: 1px solid var(--border-color);
    border-radius: 10px;
    margin-bottom: 15px;
    overflow: hidden;
}
.level-course-item-new { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-wrap: wrap; 
    gap: 15px; 
    padding: 15px;
}
.course-info-group { display: flex; align-items: center; gap: 15px; }
.course-info-group i { color: var(--accent-color); font-size: 1.2rem; }
.course-title-teacher h4 { margin: 0; font-size: 1.2rem; }
.course-title-teacher p { margin: 0; color: var(--secondary-text); font-size: 0.9rem; }
.course-actions-group { display: flex; gap: 10px; align-items: center; }
.view-lessons-btn { color: var(--secondary-text); text-decoration: none; transition: color 0.3s; }
.view-lessons-btn:hover { color: var(--primary-text); }
.level-pdf-btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 12px; border: 1px solid var(--danger-color); color: var(--danger-color); background-color: transparent; border-radius: 6px; cursor: pointer; font-family: var(--font-kurdish); font-weight: bold; transition: all 0.3s ease; gap: 8px; }
.level-pdf-btn:hover { background-color: var(--danger-color); color: white; }
.toggle-complete-btn { padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; font-family: var(--font-kurdish); font-weight: bold; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
.toggle-complete-btn.not-completed { background-color: var(--accent-color); color: white; }
.toggle-complete-btn.is-completed { background-color: transparent; border: 1px solid var(--success-color); color: var(--success-color); }

/* === ستایلی بەشی ژبەرکرنا PDF (گوهۆڕینی نوێ) === */
.memorization-pdf-section {
    background-color: rgba(88, 166, 255, 0.1);
    border-bottom: 1px dashed var(--accent-color);
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}
.memorization-info {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--primary-text);
    font-weight: 500;
}
.memorization-info i {
    color: var(--accent-color);
    font-size: 1.2rem;
}
.memorization-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}
.memorization-btn {
    background-color: transparent;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}
.memorization-btn:hover {
    background-color: var(--accent-color);
    color: var(--dark-bg);
}

.level-unlock-section { padding: 30px 25px; text-align: center; background-color: rgba(46, 160, 67, 0.1); border-top: 1px solid var(--success-color); }
.level-unlock-section i { font-size: 3rem; color: var(--success-color); margin-bottom: 15px; }
.level-unlock-section p { max-width: 500px; margin: 0 auto 20px auto; color: var(--secondary-text); }
.exam-contact-btn { background-color: var(--success-color); color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; transition: all 0.3s; }
.exam-contact-btn:hover { opacity: 0.9; text-decoration: none; }
.level-locked-overlay { padding: 40px 25px; text-align: center; filter: blur(3px); opacity: 0.6; user-select: none; pointer-events: none; border-top: 1px solid var(--border-color); }
.level-locked-overlay i { font-size: 2.5rem; color: var(--warning-color); margin-bottom: 15px; }

/* === ستایلێن نووی بۆ بەشێ حەدیس === */
#hadith-list-container { display: flex; flex-direction: column; gap: 20px; }
.hadith-card-new { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; border-left: 4px solid var(--accent-color); }
.hadith-header { padding: 15px 20px; background-color: var(--dark-bg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); }
.hadith-number { font-size: 1rem; font-weight: bold; color: var(--primary-text); }
.hadith-grade { padding: 4px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 500; }
.hadith-grade.sahih { background-color: rgba(46, 160, 67, 0.2); color: var(--success-color); border: 1px solid var(--success-color); }
.hadith-grade.hasan { background-color: rgba(240, 180, 41, 0.2); color: var(--warning-color); border: 1px solid var(--warning-color); }
.hadith-grade.daif { background-color: rgba(248, 81, 73, 0.2); color: var(--danger-color); border: 1px solid var(--danger-color); }
.hadith-content { padding: 25px; }
.hadith-text-new { font-size: 1.25rem; margin-bottom: 25px; line-height: 1.9; color: var(--primary-text); }
.hadith-actions { display: flex; align-items: center; gap: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px; }
.hadith-action-btn { background: var(--border-color); border: none; color: var(--primary-text); padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.3s; }
.hadith-action-btn:hover { background-color: var(--accent-color); }
.hadith-footer { padding: 15px 20px; background-color: var(--dark-bg); border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px 25px; color: var(--secondary-text); font-size: 0.9rem; }

.pagination-controls { text-align: center; margin-top: 30px; }
.pagination-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 8px 16px; margin: 0 5px; border-radius: 6px; cursor: pointer; }
.pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* === ستایلێن نووی بۆ بەشێ تەفسیر === */
.tafsir-controls { background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 30px; }
#surah-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
.surah-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; }
.surah-btn:hover { background-color: var(--border-color); border-color: var(--accent-color); }
.surah-btn-number { font-size: 0.9rem; color: var(--secondary-text); display: block; }
.surah-btn-name { font-size: 1.2rem; font-weight: 500; }
#tafsir-display-area .back-to-surah-btn { margin-bottom: 20px; display: inline-flex; align-items: center; gap: 8px; color: var(--accent-color); font-weight: bold; background: var(--card-bg); padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border-color); }
.tafsir-meta-info { display: flex; justify-content: center; align-items: center; gap: 20px; background: var(--dark-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 25px; }
.tafsir-meta-item { font-size: 0.95rem; color: var(--secondary-text); }
.tafsir-meta-item span { color: var(--primary-text); font-weight: bold; }
.tafsir-content-full { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 30px; white-space: pre-wrap; line-height: 1.9; font-size: 1.1rem; }

</style>
</head>
<body>
<!-- شاشەیا چاڤەڕوانیێ -->
<div id="loading-screen">
<div class="loading-logo">تەوحید<span>.</span></div>
<div class="welcome-text">بخێر هاتن بۆ پرۆژێ تەوحید...<br><span style="font-size:1rem;">زانیاری دهێنە وەرگرتن ژ گوگل شیتس</span></div>
<div class="loading-spinner"></div>
</div>

<!-- سەرە (Header) -->
<header>
    <div class="container">
        <!-- گوهۆڕینی نوێ: لۆگۆ نوکە دزڤریتە مالپەرێ سەرەکی -->
        <a href="#" onclick="showHomeView()" class="logo">تەوحید<span>.</span></a>
        <!-- گوهۆڕینی نوێ: دیکما ڤەگەریانێ -->
        <a href="#" id="back-to-home-btn" onclick="showHomeView()">
            <i class="fas fa-home"></i> مالپەرێ سەرەکی
        </a>
    </div>
</header>

<!-- ناڤەروکا سەرەکی (Main Content) -->
<main class="container">
    <section id="home-view" class="view-section"></section> 
    <section id="levels-view" class="view-section"></section>
    <section id="waneyan-view" class="view-section"></section>
    <section id="hadith-view" class="view-section"></section>
    <section id="tafsir-view" class="view-section"></section>
    <section id="pirtukxane-view" class="view-section"></section>
    <section id="book-sales-view" class="view-section"></section>
    <section id="teachers-view" class="view-section"></section>
    <!-- گوهۆڕینی نوێ: بەشێ نوو بۆ پرسیار و بەرسڤان -->
    <section id="fatwas-view" class="view-section"></section>
    <section id="map-view" class="view-section"></section>
    <section id="live-view" class="view-section"></section>
</main>

<!-- === هەمی مۆدالەکان === -->
<div class="modal-overlay" id="lesson-list-modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('lesson-list-modal')">&times;</span>
        <h3 id="lesson-list-title"></h3>
        <div id="lesson-list-container"></div>
    </div>
</div>

<div class="modal-overlay" id="teacher-profile-modal">
    <div class="modal-content profile-modal-content">
        <span class="close-modal-btn" onclick="closeModal('teacher-profile-modal')">&times;</span>
        <div id="profile-dynamic-content"></div>
    </div>
</div>

<div class="modal-overlay" id="media-player-modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('media-player-modal')">&times;</span>
        <h3 id="media-player-title"></h3>
        <div id="media-player-container" class="media-player-container"></div>
    </div>
</div>

<div class="modal-overlay" id="pdf-viewer-modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('pdf-viewer-modal')">&times;</span>
        <h3 id="pdf-viewer-title"></h3>
        <div class="pdf-iframe-container">
            <iframe id="pdf-iframe" src="" frameborder="0"></iframe>
        </div>
    </div>
</div>


<!-- پێ (Footer) -->
<footer>
    <p>&copy; 2025 - پرۆژێ تەوحید. هەمی ماف پاراستینە.</p>
    <div style="color: var(--secondary-text); margin-top: 15px; font-size: 0.9rem;">
        ژمارا گشتی یا سەرەدانکەران: 
        <span id="visitor-counter" style="font-weight: bold; color: var(--primary-text); direction: ltr; display: inline-block;">...</span>
    </div>
    <div class="footer-social-links">
        <a href="#" target="_blank" rel="noopener noreferrer" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="#" target="_blank" rel="noopener noreferrer" title="YouTube"><i class="fab fa-youtube"></i></a>
        <a href="#" target="_blank" rel="noopener noreferrer" title="Facebook"><i class="fab fa-facebook"></i></a>
    </div>
</footer>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
<script>
// ====================================================================================
// ============================= پرۆژێ تەوحید - JAVASCRIPT ============================
// ====================================================================================
(function() {
'use strict';

// === [ 1. حالەتێ گشتی و گۆڕاوەکان ] ===
const publishedCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwD58WrboATMUyuRxuXDNExmN77tXF5nI4AVoVktJ6NGpg2EoMkFe8McZaUyn_q5HrT8grpYJdVgiq/pub?output=csv';

const sheetGIDs = { 
    teachers: '0', 
    generalLectures: '480195998', 
    books: '420495992', 
    locations: '1660455979', 
    liveCourse: '1559180305', 
    levels: '622488432', 
    fatwas: '480454716',
    viewStatus: '1476353771',
    hadiths: '323793580',
    tafsir: '2031580242',
    bookSales: '99908709'
};

let allData = { 
    teachers: {}, generalLectures: [], pirtukxane: [], 
    locations: [], liveCourse: {}, levels: [], fatwas: [],
    viewStatuses: {}, hadiths: [], tafsir: {},
    bookSales: []
};

let map = null, mapInitialized = false, mapMarkers = {};
let hadithCurrentPage = 1;
const hadithsPerPage = 10;

// === بەڕێوەبەریا پێشکەفتنێ ===
const progressManager = {
    completedCoursesKey: 'tawhidProjectProgress_Courses',
    unlockedLevelsKey: 'tawhidProjectProgress_Levels',
    memorizedPdfsKey: 'tawhidProjectProgress_MemorizedPdfs',

    getCompletedCourses: function() { try { return JSON.parse(localStorage.getItem(this.completedCoursesKey) || '[]'); } catch (e) { console.error("Error getting completed courses:", e); return []; } },
    getUnlockedLevels: function() { try { const levels = JSON.parse(localStorage.getItem(this.unlockedLevelsKey) || '[0]'); if (!levels.includes(0)) levels.unshift(0); return levels; } catch (e) { console.error("Error getting unlocked levels:", e); return [0]; } },
    getMemorizedPdfs: function() { try { return JSON.parse(localStorage.getItem(this.memorizedPdfsKey) || '[]'); } catch (e) { console.error("Error getting memorized PDFs:", e); return []; } },

    isCourseComplete: function(courseId) { return this.getCompletedCourses().includes(courseId); },
    isLevelUnlocked: function(levelIndex) { return this.getUnlockedLevels().includes(levelIndex); },
    isPdfMemorized: function(courseId) { return this.getMemorizedPdfs().includes(courseId); },

    toggleCourseCompletion: function(courseId) { let completed = this.getCompletedCourses(); const index = completed.indexOf(courseId); if (index > -1) { completed.splice(index, 1); } else { completed.push(courseId); } localStorage.setItem(this.completedCoursesKey, JSON.stringify(completed)); },
    togglePdfMemorization: function(courseId) { let memorized = this.getMemorizedPdfs(); const index = memorized.indexOf(courseId); if (index > -1) { memorized.splice(index, 1); } else { memorized.push(courseId); } localStorage.setItem(this.memorizedPdfsKey, JSON.stringify(memorized)); },
    
    unlockLevel: function(levelIndex) { let unlocked = this.getUnlockedLevels(); if (!unlocked.includes(levelIndex)) { unlocked.push(levelIndex); localStorage.setItem(this.unlockedLevelsKey, JSON.stringify(unlocked)); } }
};

// === [ 2. دەستپێکرن و ڕێکخستن ] ===
document.addEventListener('DOMContentLoaded', async () => {
    const loadingScreen = document.getElementById('loading-screen');
    try {
        await loadDataFromSheets();
        buildAllViews();
        updateAndShowVisitorCount();
        setupEventListeners();
        showHomeView();
    } catch (error) {
        console.error("Çewtî di dema destpêkê da:", error);
        loadingScreen.innerHTML = '<div class="welcome-text" style="animation:none; opacity:1;">چەوتیەک روویدا د وەرگرتنا زانیارییان دا.<br>هیڤیدارین پەیوەندیێ ب پشتەڤانیا تەکنیکی بکە.</div>';
        return;
    } finally {
        loadingScreen.classList.add('fade-out');
    }
});

function setupEventListeners() {
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(event) { if (event.target === this) closeModal(this.id); });
    });
}

// === [ 3. وەرگرتن و پرۆسێسا داتایان ] ===
async function loadDataFromSheets() {
    try {
        const fetches = Object.entries(sheetGIDs).map(([key, gid]) => 
            fetch(`${publishedCsvUrl}&gid=${gid}`).then(res => {
                if (!res.ok) {
                    console.warn(`Could not fetch GID ${gid} for ${key}. It might be incorrect.`);
                    return "";
                }
                return res.text();
            })
        );
        const [
            teachersCsv, generalLecturesCsv, booksCsv, locationsCsv, 
            liveCourseCsv, levelsCsv, fatwasCsv, viewStatusCsv,
            hadithsCsv, tafsirCsv, bookSalesCsv
        ] = await Promise.all(fetches);

        allData.teachers = processTeachersData(parseCSV(teachersCsv));
        allData.generalLectures = processGeneralLectures(parseCSV(generalLecturesCsv));
        allData.pirtukxane = processBooks(parseCSV(booksCsv));
        allData.locations = processLocationsData(parseCSV(locationsCsv));
        allData.liveCourse = processLiveCourseData(parseCSV(liveCourseCsv));
        allData.levels = processLevelsData(parseCSV(levelsCsv));
        allData.fatwas = processFatwasData(parseCSV(fatwasCsv));
        allData.viewStatuses = processViewStatusData(parseCSV(viewStatusCsv));
        allData.hadiths = processHadithsData(parseCSV(hadithsCsv));
        allData.tafsir = processTafsirData(parseCSV(tafsirCsv));
        allData.bookSales = processBookSalesData(parseCSV(bookSalesCsv));

    } catch (error) { 
        console.error('شکەستن د بارکرنا داتایان ژ گوگل شیتس:', error); 
        throw error;
    }
}
function parseCSV(csvText) { if (!csvText) return []; const lines = csvText.trim().split(/\r\n|\n/); if (lines.length < 2) return []; const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, '')); return lines.slice(1).map(line => { if (!line) return null; const obj = {}; const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); headers.forEach((header, j) => { let value = (values[j] || '').trim(); if (value.startsWith('"') && value.endsWith('"')) { value = value.substring(1, value.length - 1).replace(/""/g, '"'); } obj[header] = value; }); return obj; }).filter(Boolean); }
function processTeachersData(data) { return data.reduce((acc, row) => { if (row.id) { acc[row.id] = { id: row.id, name: row.name || 'نەناسراو', profileImage: row.profileimage || `https://ui-avatars.com/api/?name=${encodeURIComponent(row.name || 'M')}&background=random`, bio: row.bio || '', phone: row.phone || '', social: { youtube: row.social_youtube, telegram: row.social_telegram, facebook: row.social_facebook } }; } return acc; }, {}); }
function processGeneralLectures(data) { return data.filter(lec => lec.id).map(lec => ({ id: lec.id, title: lec.title, teacherId: lec.teacherid, category: lec.category, image: lec.image, pdfUrl: lec.pdfurl || '', videos: lec.videos ? lec.videos.split('|').map(v => { const [title, url] = v.split(';'); return { title: title || 'وانە', url: url || '#' }; }) : [] })); }
function processBooks(data) { return data.filter(book => book.title).map(book => ({ title: book.title, author: book.author, category: book.category, coverImage: book.coverimage, readUrl: book.readurl, downloadUrl: book.downloadurl })); }
function processLocationsData(data) { return data.map(loc => { if (!loc.locationid || !loc.coordinates) return null; const coords = loc.coordinates.split(',').map(c => parseFloat(c.trim())); if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) return null; return { id: loc.locationid, name: loc.locationname, coordinates: coords, teacherId: loc.teacherid, lessonTaught: loc.lessontaught, schedule: loc.schedule }; }).filter(Boolean); }
function processLiveCourseData(data) { if (!data || data.length === 0) return {}; const course = data[0]; return { title: course.title, teacherId: course.teacherid, description: course.description, nextSessionDate: course.nextsessiondate, prerequisites: course.prerequisites, topics: course.topics ? course.topics.split('|') : [], schedule: course.schedule ? course.schedule.split('|') : [] }; }
function processLevelsData(data) { const grouped = data.reduce((acc, row) => { if (!row.level_id || !row.course_title || !row.course_id) return acc; const levelId = parseInt(row.level_id, 10); if (!acc[levelId]) { acc[levelId] = { level: levelId, levelName: row.level_name || `ئاستێ ${levelId}`, unlockCode: row.unlock_code || null, courses: [] }; } acc[levelId].courses.push({ id: row.course_id.trim(), title: row.course_title, teacherId: row.teacher_id, pdfUrl: row.pdf_url || '', memorizationPdfUrl: row.memorization_pdf_url || '', memorizationPdfTitle: row.memorization_pdf_title || 'ئەڤ پەرتوکە بۆ ژبەرکرنێ یە', videos: row.videos ? row.videos.split('|').map(v => { const [t, u] = v.split(';'); return { title: t || 'وانە', url: u || '#' }; }) : [] }); return acc; }, {}); return Object.values(grouped).sort((a, b) => a.level - b.level); }
function processFatwasData(data) { return data.filter(f => f.question && f.answer && f.teacherid).map(f => ({ question: f.question, answer: f.answer, teacherId: f.teacherid, category: f.category || 'گشتی', audioUrl: f.audio_url || '' })); }
function processViewStatusData(data) { return data.reduce((acc, row) => { if (row.viewid && row.stpcode) { acc[row.viewid.trim()] = row.stpcode.trim(); } return acc; }, {}); }
function processHadithsData(data) { return data.filter(h => h.text && h.source).map(h => ({ id: `hadith-${Math.random().toString(36).substr(2, 9)}`, text: h.text, source: h.source, narrator: h.narrator || 'نەدیار', category: h.category || 'گشتی', number: h.hadith_number || 'بێ هژمار', grade: h.grade || 'نەدیار', audioUrl: h.audio_url || '' })); }
function processTafsirData(data) { return data.reduce((acc, row) => { if (row.surah_number && row.full_tafsir_text) { acc[row.surah_number] = { surahName: row.surah_name || `سورەتا ${row.surah_number}`, fullTafsir: row.full_tafsir_text, ayahCount: row.ayah_count || 'نەدیار', revelationType: row.revelation_type || 'نەدیار', audioUrl: row.surah_audio_url || '' }; } return acc; }, {}); }
function processBookSalesData(data) { return data.filter(b => b.title && b.price).map(b => ({ title: b.title, author: b.author || 'نەدیار', coverImage: b.coverimage || 'https://picsum.photos/400/600?grayscale', description: b.description || '', price: b.price, purchaseLink: b.purchaselink, isAvailable: (b.isavailable || '').toLowerCase() === 'بەڵێ' })); }

// === [ 4. ڕێکخستنا مۆدالان ] ===
function openModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.add('is-visible'); }
function closeModal(modalId) { const modal = document.getElementById(modalId); if (!modal) return; modal.classList.remove('is-visible'); if (modalId === 'teacher-profile-modal') document.getElementById('profile-dynamic-content').innerHTML = ''; if (modalId === 'media-player-modal') { document.getElementById('media-player-container').innerHTML = ''; } if (modalId === 'pdf-viewer-modal') { document.getElementById('pdf-iframe').src = 'about:blank'; } }

// === [ 5. ئاڤاکەرێن دیتنان (View Builders) ] ===
function buildAllViews() {
    const viewBuilders = { 
        'home-view': buildHomeView, 
        'levels-view': buildLevelsView, 
        'waneyan-view': buildWaneyanView, 
        'pirtukxane-view': buildPirtukxaneView, 
        'teachers-view': buildTeachersView,
        'fatwas-view': buildFatwasView, // گوهۆڕینی نوێ
        'map-view': buildMapView, 
        'live-view': buildLiveView,
        'hadith-view': buildHadithView, 
        'tafsir-view': buildTafsirView,
        'book-sales-view': buildBookSalesView
    };

    Object.keys(viewBuilders).forEach(viewId => {
        const viewContainer = document.getElementById(viewId);
        if (viewContainer) {
            if (allData.viewStatuses[viewId] && allData.viewStatuses[viewId] !== '0') {
                if (allData.viewStatuses[viewId] !== '7') {
                    displayStatusMessage(viewId, allData.viewStatuses[viewId]);
                }
            } else {
                if (viewBuilders[viewId]) {
                    viewBuilders[viewId]();
                }
            }
        }
    });
}

const createEmptyStateMessage = (message) => `<div class="empty-state-message">${message}</div>`;

// گوهۆڕینی نوێ: دیزاینا نوو یا مالپەرێ سەرەکی
function buildHomeView() {
    const container = document.getElementById('home-view');
    container.innerHTML = `
        <div class="home-hero-section">
            <h1>پرۆژێ <span>تەوحید</span></h1>
            <p>دەروازەیەکا مودێرن و رێکخستی بۆ فێربوون و تێگەهشتنا ئیسلامێ، ژ ژێدەرێن باوەرپێکری.</p>
            <a href="#" onclick="navigateToView('levels-view')" class="hero-cta-btn"><i class="fas fa-play"></i> دەستپێبکە</a>
        </div>
        <div class="home-navigation-container">
            <h2>بەشێن سەرەکی</h2>
            <div class="main-navigation-grid">
                <a href="#" onclick="navigateToView('levels-view')" class="main-navigation-card">
                    <i class="fas fa-stairs"></i>
                    <h3>رێرەوا فێربوونێ</h3>
                    <p>فێربوونا رێکخستی ژ ئاستێ 1</p>
                </a>
                <a href="#" onclick="navigateToView('waneyan-view')" class="main-navigation-card">
                    <i class="fas fa-video"></i>
                    <h3>وانەیێن گشتی</h3>
                    <p>ل زنجیرە وانەیان بگەڕە</p>
                </a>
                <a href="#" onclick="navigateToView('tafsir-view')" class="main-navigation-card">
                    <i class="fas fa-quran"></i>
                    <h3>تەفسیرا قورئانێ</h3>
                    <p>تەفسیرا سورەتان بخوینە</p>
                </a>
                <a href="#" onclick="navigateToView('hadith-view')" class="main-navigation-card">
                    <i class="fas fa-book-quran"></i>
                    <h3>کتێبخانەیا حەدیسێ</h3>
                    <p>ل حەدیسان بگەڕە</p>
                </a>
                <a href="#" onclick="navigateToView('teachers-view')" class="main-navigation-card">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>مامۆستایان</h3>
                    <p>پرۆفایلا مامۆستایان ببینە</p>
                </a>
                <a href="#" onclick="navigateToView('fatwas-view')" class="main-navigation-card">
                    <i class="fas fa-question-circle"></i>
                    <h3>پرسیار و بەرسڤ</h3>
                    <p>بەرسڤا پرسیارێن شەرعی</p>
                </a>
                <a href="#" onclick="navigateToView('pirtukxane-view')" class="main-navigation-card">
                    <i class="fas fa-swatchbook"></i>
                    <h3>پەرتوکخانە</h3>
                    <p>پەرتوکێن هەلبژارتی بخوینە</p>
                </a>
                 <a href="#" onclick="navigateToView('book-sales-view')" class="main-navigation-card">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>فرۆتنا پەرتووکان</h3>
                    <p>پەرتوکێن بەردەست بۆ کرینێ</p>
                </a>
                <a href="#" onclick="navigateToView('map-view')" class="main-navigation-card">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>خەریتە</h3>
                    <p>جهێ وانەگوتنێ ببینە</p>
                </a>
                <a href="#" onclick="navigateToView('live-view')" class="main-navigation-card">
                    <i class="fas fa-satellite-dish"></i>
                    <h3>خولێن ڕاستەوخۆ</h3>
                    <p>پشکداریێ د خولان دا بکە</p>
                </a>
            </div>
        </div>`;
}

// گوهۆڕینی نوێ: رێکخستنا بەشێ ژبەرکرنێ
function buildLevelsView() {
    const container = document.getElementById('levels-view');
    let heroSection = `<div class="hero-section">
        <h1 class="hero-title">بەرەڤ تێگەهشتنەکا کوورتر ژ ئیسلامێ</h1>
        <p class="hero-subtitle">پرۆژێ تەوحید رێبەرێ تەیە بۆ فێربوونا زانستێن شەرعی ب شێوەیەکێ رێکخستی و قوناغ ب قوناغ، ژ دەستپێکێ حەتا ئاستێن پێشکەفتی.</p>
        <a href="#levels-container-anchor" onclick="document.getElementById('levels-container-anchor').scrollIntoView({ behavior: 'smooth' });" class="hero-cta-btn"><i class="fas fa-graduation-cap"></i>دەست ب فێربوونێ بکە</a>
    </div>`;
    
    let content = `<header class="page-header" style="padding-top:0;">
        <div class="page-header-container">
            <h1>رێرەوا فێربوونێ</h1>
            <a href="#" onclick="resetAllProgress()" class="reset-progress-icon" title="ژێبرنا هەمی پێشکەftنێ"><i class="fas fa-history"></i></a>
        </div>
        <p>ئەڤە رێبازا رێکخستیە بۆ فێربوونێ. ژ ئاستێ ئێکێ دەستپێبکە و قوناغ ب قوناغ پێشبکەڤە.</p>
    </header>`;
    
    if (!allData.levels || allData.levels.length === 0) {
        content += createEmptyStateMessage('چ ئاستەک یان وانەیەک بۆ ڤی بەشی نەهاتیە تومارکرن.');
    } else {
        content += '<div class="levels-container" id="levels-container-anchor">';
        allData.levels.forEach((level, levelIndex) => {
            const isUnlocked = progressManager.isLevelUnlocked(levelIndex);
            const prevLevel = levelIndex > 0 ? allData.levels[levelIndex - 1] : null;
            
            const isPrevLevelComplete = prevLevel 
                ? prevLevel.courses.every(c => 
                    progressManager.isCourseComplete(c.id) && 
                    (!c.memorizationPdfUrl || progressManager.isPdfMemorized(c.id))
                  ) 
                : true;
            
            const completedCoursesCount = level.courses.filter(c => progressManager.isCourseComplete(c.id)).length;
            const totalCourses = level.courses.length;
            const progressPercentage = totalCourses > 0 ? (completedCoursesCount / totalCourses) * 100 : 0;

            content += `<div class="level-card"><div class="level-card-header"><div class="level-title-group"><span class="level-number-badge">${levelIndex + 1}</span><h2>${level.levelName}</h2></div><div class="level-meta"><span>${completedCoursesCount} / ${totalCourses} وانە تەمامکرینە</span><div class="level-progress-bar"><div class="level-progress-bar-inner" style="width: ${progressPercentage}%;"></div></div></div></div>`;

            if (isUnlocked) {
                content += `<div class="level-courses-list">${level.courses.map(course => {
                    const isCompleted = progressManager.isCourseComplete(course.id);
                    const isMemorized = progressManager.isPdfMemorized(course.id);
                    const teacher = allData.teachers[course.teacherId];
                    const pdfButton = course.pdfUrl ? `<button class="level-pdf-btn" onclick="showPdfInModal('${course.pdfUrl}', '${course.title}')"><i class="fas fa-file-pdf"></i><span>PDF</span></button>` : '';
                    
                    const memorizationSectionHTML = course.memorizationPdfUrl ? `
                        <div class="memorization-pdf-section">
                            <div class="memorization-info">
                                <i class="fas fa-brain"></i>
                                <span>${course.memorizationPdfTitle}</span>
                            </div>
                            <div class="memorization-actions">
                                <button class="memorization-btn" onclick="showPdfInModal('${course.memorizationPdfUrl}', '${course.title} - بۆ ژەبەرکرنێ')">
                                    <i class="fas fa-book-open"></i> پەرتوکێ ببینە
                                </button>
                                <button class="toggle-complete-btn ${isMemorized ? 'is-completed' : 'not-completed'}" onclick="togglePdfMemorization('${course.id}')">
                                    <i class="fas fa-${isMemorized ? 'times-circle' : 'check-circle'}"></i>
                                    <span>${isMemorized ? 'هەلوەشاندن' : 'من ژبەرکر'}</span>
                                </button>
                            </div>
                        </div>` : '';

                    return `<div class="level-course-wrapper">
                                ${memorizationSectionHTML}
                                <div class="level-course-item-new">
                                    <div class="course-info-group">
                                        <i class="fas fa-book-open"></i>
                                        <div class="course-title-teacher">
                                            <h4>${course.title}</h4>
                                            <p>دگەل: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${course.teacherId}')">${teacher?.name || 'نەناسراو'}</a></p>
                                        </div>
                                    </div>
                                    <div class="course-actions-group">
                                        <a href="#" onclick="event.preventDefault(); showLevelCourseLessons(${levelIndex}, ${level.courses.indexOf(course)})" class="view-lessons-btn"><i class="fas fa-list-ul"></i> لیستا وانەیان</a>
                                        ${pdfButton}
                                        <button class="toggle-complete-btn ${isCompleted ? 'is-completed' : 'not-completed'}" onclick="toggleCourseCompletion('${course.id}')"><i class="fas fa-${isCompleted ? 'times-circle' : 'check-circle'}"></i><span>${isCompleted ? 'تەمام کر' : 'تەمام کر'}</span></button>
                                    </div>
                                </div>
                            </div>`;
                }).join('')}</div>`;
            } else { 
                if (isPrevLevelComplete) {
                    content += `<div class="level-unlock-section"><i class="fas fa-tasks"></i><h4>تاقیکرن و دەربازبوون بۆ ئاستێ ${levelIndex + 1}</h4><p>پیرۆزە! تە هەمی وانە و پەرتوکێن ژبەرکرنێ یێن ئاستێ ${levelIndex} ب سەرکەفتی تەمامکرن. بۆ دەربازبوون بۆ ئاستێ بهێت، پێدڤیە تاقیکرنەکێ ئەنجام بدەی یان ژی کۆدێ ڤەکرنێ بکاربینی.</p><a href="https://t.me/your_telegram_contact" target="_blank" rel="noopener noreferrer" class="exam-contact-btn"><i class="fab fa-telegram-plane"></i> پەیوەندیێ بکە بۆ تاقیکرنێ</a><div style="margin: 20px 0; color: var(--secondary-text);">یان</div><div style="display:flex; justify-content:center; gap:10px; max-width: 400px; margin-left:auto; margin-right:auto;"><input type="text" id="unlock-code-input-${levelIndex}" class="search-input-new" placeholder="کۆدێ ڤەکرنێ داخل بکە"><button class="exam-contact-btn" style="background-color: var(--accent-color);" onclick="checkLevelUnlockCode(${levelIndex})">ڤەکرن</button></div><p id="unlock-status-${levelIndex}" style="margin-top:10px; font-weight:bold;"></p></div>`;
                } else {
                    content += `<div class="level-locked-overlay"><i class="fas fa-lock"></i><h4>ئەڤ ئاستە قفلە</h4><p>بۆ ڤەکرنا ڤی ئاستی، هیڤیدارین هەمی وانە و پەرتوکێن ژبەرکرنێ یێن ئاستێ ${levelIndex} تەمام بکەی.</p></div>`;
                }
            }
            content += `</div>`;
        });
        content += '</div>';
    }
    container.innerHTML = heroSection + content;
}

function buildWaneyanView() { const container = document.getElementById('waneyan-view'); let content = `<header class="page-header"><h1>وانەیێن گشتی</h1><p>وانە و زنجیرەیێن جودا جودا</p></header>`; if (!allData.generalLectures || allData.generalLectures.length === 0) { content += createEmptyStateMessage('هیچ وانەیەکا گشتی نەهاتیە تۆمارکرن.'); } else { const categories = ['all', ...new Set(allData.generalLectures.map(l => l.category).filter(Boolean))]; const teachers = ['all', ...new Set(allData.generalLectures.map(l => l.teacherId).filter(Boolean))]; content += `<div class="filters-container" id="waneyan-filters"><div class="filter-group"><h4>بابەت:</h4>${categories.map(cat => `<button class="filter-btn ${cat === 'all' ? 'active' : ''}" data-filter-type="category" data-filter-value="${cat}">${cat === 'all' ? 'هەمووی' : cat}</button>`).join('')}</div><div class="filter-group"><h4>مامۆستا:</h4>${teachers.map(tId => `<button class="filter-btn ${tId === 'all' ? 'active' : ''}" data-filter-type="teacher" data-filter-value="${tId}">${tId === 'all' ? 'هەمووی' : (allData.teachers[tId]?.name || tId)}</button>`).join('')}</div></div><div class="waneyan-grid" id="waneyan-grid"></div>`; } container.innerHTML = content; if (allData.generalLectures.length > 0) { document.querySelectorAll('#waneyan-filters .filter-btn').forEach(btn => btn.addEventListener('click', function() { document.querySelectorAll(`#waneyan-filters .filter-btn[data-filter-type="${this.dataset.filterType}"]`).forEach(b => b.classList.remove('active')); this.classList.add('active'); filterLectures(); })); filterLectures(); } }
function buildPirtukxaneView() { const container = document.getElementById('pirtukxane-view'); let content = `<header class="page-header"><h1>پەرتوکخانە</h1><p>کۆمەڵێک پەرتوکی پێشنیارکراو</p></header>`; if (!allData.pirtukxane || allData.pirtukxane.length === 0) { content += createEmptyStateMessage('هیچ پەرتوکەک نەهاتیە تۆمارکرن.'); } else { content += `<div class="pirtuk-grid">${allData.pirtukxane.map(book => `<div class="pirtuk-card"><img src="${book.coverImage}" class="pirtuk-card-img" alt="بەرگێ پەرتووکێ" loading="lazy"><div class="pirtuk-card-content"><h3>${book.title}</h3><p><strong>نووسەر:</strong> ${book.author}</p><div class="card-btn-group"><button onclick="showPdfInModal('${book.readUrl}', '${book.title}')" class="card-btn-small">خواندن</button><a href="${book.downloadUrl}" target="_blank" rel="noopener noreferrer" class="card-btn-small secondary">داگرتن</a></div></div></div>`).join('')}</div>`; } container.innerHTML = content; }
// گوهۆڕینی نوێ: جوداکرنا بەشێ مامۆستایان
function buildTeachersView() { const container = document.getElementById('teachers-view'); let content = `<header class="page-header"><h1>مامۆستایان</h1><p>پرۆفایلا مامۆستایێن بەرێز ببینە</p></header>`; const teachers = Object.values(allData.teachers); if (teachers.length === 0) { content += createEmptyStateMessage('هیچ مامۆستایەک نەهاتیە تۆمارکرن.'); } else { content += `<div class="teachers-grid">${teachers.map(teacher => `<div class="teacher-card-simple"><img src="${teacher.profileImage}" alt="${teacher.name}" loading="lazy"><h3>${teacher.name}</h3><p>${(teacher.bio || '').substring(0, 50)}...</p><a href="#" onclick="event.preventDefault(); showTeacherProfile('${teacher.id}')" class="profile-btn-simple">پرۆفایل ببینە</a></div>`).join('')}</div>`; } container.innerHTML = content; }
// گوهۆڕینی نوێ: بەشێ نوو بۆ پرسیار و بەرسڤان
function buildFatwasView() { const container = document.getElementById('fatwas-view'); let content = `<header class="page-header"><h1>پرسیار و بەرسڤ</h1><p>بەرسڤا پرسیارێن شەرعی ژ مامۆستایێن باوەرپێکری</p></header>`; if (!allData.fatwas || allData.fatwas.length === 0) { content += createEmptyStateMessage('هیچ پرسیار و بەرسڤەک نەهاتیە تۆمارکرن.'); } else { const fatwaTeacherIds = [...new Set(allData.fatwas.map(f => f.teacherId))]; let scholarFilterButtons = fatwaTeacherIds.map(tId => { const teacher = allData.teachers[tId]; return `<button class="fatwa-scholar-btn" data-teacher-id="${tId}" onclick="selectFatwaTeacher(this, '${tId}')">${teacher ? teacher.name : 'نەناسراو'}</button>`; }).join(''); content += `<div class="fatwa-controls-new"><div class="fatwa-filter-group"><h4>پۆلێنکرن بەپێی مامۆستا:</h4><button class="fatwa-scholar-btn active" data-teacher-id="all" onclick="selectFatwaTeacher(this, 'all')">هەمووی</button>${scholarFilterButtons}</div><input type="text" id="fatwa-search-input" class="search-input-new" placeholder="ل پرسیارەکێ بگەڕە..." onkeyup="filterFatwas()"></div><div id="fatwa-accordion-container"></div>`; filterFatwas(); } container.innerHTML = content; }

function buildMapView() { const container = document.getElementById('map-view'); container.innerHTML = `<header class="page-header"><h1>خەریتە</h1><p>جهێ وانەگوتنێ لسەر خەریتەی ببینە و لێ بگەڕە</p></header><div id="map-view-layout"><div class="map-controls"><input type="text" id="map-search-input" class="map-search-input" placeholder="ل ناڤێ جهی، مامۆستای، یان وانەیێ بگەڕە..." onkeyup="renderLocationList()"></div><div id="main-map-container"></div><div id="location-list-container"></div></div>`; if (allData.locations.length === 0) { document.getElementById('location-list-container').innerHTML = createEmptyStateMessage('هیچ جهەک لسەر خەریتەی نەهاتیە تۆمارکرن.'); } else { renderLocationList(); } }
function buildLiveView() { const container = document.getElementById('live-view'); const course = allData.liveCourse; if (!course || !course.teacherId) { container.innerHTML = `<header class="page-header"><h1>خولێن ڕاستەوخۆ</h1></header>${createEmptyStateMessage('نوکە چ خولێن ڕاستەوخۆ بەردەست نینن.')}`; return; } const teacher = allData.teachers[course.teacherId]; if (!teacher) { container.innerHTML = createEmptyStateMessage('چەوتی: مامۆستایێ ڤێ خولێ نەهاتە دیتن.'); return; } container.innerHTML = `<div class="live-view-content"><span class="live-badge">ڕاستەوخۆ</span><h1>${course.title}</h1><p class="live-teacher-info">دگەل: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${course.teacherId}')">${teacher.name}</a></p><p style="max-width: 700px; margin: 0 auto 30px;">${course.description}</p><h3 style="margin-bottom: 10px;">جڤینا بهێت دێ دەستپێکەت پشتی:</h3><div id="live-countdown"></div><div class="live-details-section"><h3 class="profile-section-title-new" style="text-align: right; border:none; padding-bottom: 0;">زانیاریێن زێدەتر</h3><h4><i class="fas fa-bullseye" style="color:var(--accent-color); margin-left: 8px;"></i>بابەتێن سەرەکی:</h4><ul style="margin-bottom: 20px;">${course.topics.map(t => `<li>${t}</li>`).join('')}</ul><h4><i class="fas fa-tasks" style="color:var(--accent-color); margin-left: 8px;"></i>پێدڤیێن خولێ:</h4><p style="margin-bottom: 20px;">${course.prerequisites}</p><h4><i class="fas fa-calendar-alt" style="color:var(--accent-color); margin-left: 8px;"></i>خشتێ جڤینان:</h4><ul>${course.schedule.map(s => `<li>${s}</li>`).join('')}</ul></div><div id="live-registration-section"><h2 class="profile-section-title-new" style="text-align:center; border-bottom-width:2px; max-width:400px; margin: 40px auto 20px auto;">فورما پشکداریێ</h2><p style="color: var(--secondary-text); max-width: 600px; margin: 0 auto 20px;">ئەگەر تۆ حەزدکەی پشکداریێ بکەی، ڤێ فورمێ پر بکە.</p><form action="https://formspree.io/f/mvgqdwav" method="POST" class="live-registration-form"><input type="hidden" name="_subject" value="داواکاریەکا نووی بۆ خولا راستەوخۆ!"><div class="form-group"><label for="fullname">ناڤێ سیانی:</label><input type="text" id="fullname" name="ناڤ" required></div><div class="form-group"><label for="email">ئیمێل:</label><input type="email" id="email" name="ئیمێل" required></div><div class="form-group form-group-checkbox"><input type="checkbox" id="prereq" name="مەرج قەبیلکرن" value="بەڵێ" required><label for="prereq">ئەز پشتراستم کو من مەرجێن پێدڤی هەنە</label></div><button type="submit" class="form-submit-btn">هنارتن</button></form></div></div>`; startCountdown(course.nextSessionDate); }
function buildHadithView() { const container = document.getElementById('hadith-view'); let content = `<header class="page-header"><h1>کتێبخانەیا حەدیسێ</h1><p>ل حەدیسێن پێغەمبەری ﷺ بگەڕە و زانیاریێن وان ببینە</p></header>`; if (!allData.hadiths || allData.hadiths.length === 0) { content += createEmptyStateMessage('هیچ حەدیسەک نەهاتیە تۆمارکرن.'); } else { const categories = ['all', ...new Set(allData.hadiths.map(h => h.category))]; content += `<div class="hadith-controls-new"><div class="filter-group"><h4>بابەت:</h4>${categories.map(cat => `<button class="filter-btn ${cat === 'all' ? 'active' : ''}" data-filter-type="category" onclick="selectHadithFilter(this, 'category')">${cat === 'all' ? 'هەمووی' : cat}</button>`).join('')}</div><input type="text" id="hadith-search-input" class="search-input-new" placeholder="ل دەقێ حەدیسێ بگەڕە..." onkeyup="filterHadiths(true)"></div><div id="hadith-list-container"></div><div id="hadith-pagination-container" class="pagination-controls"></div>`; } container.innerHTML = content; if (allData.hadiths.length > 0) { filterHadiths(); } }
function buildTafsirView() { const container = document.getElementById('tafsir-view'); let content = `<header class="page-header"><h1>تەفسیرا قورئانا پیرۆز</h1><p>سورەتەکێ هەلبژێرە یان ل ناڤێ وێ بگەڕە</p></header>`; if (Object.keys(allData.tafsir).length === 0) { content += createEmptyStateMessage('هیچ تەفسیرەک نەهاتیە تۆمارکرن.'); } else { content += `<div id="surah-selection-area"><div class="tafsir-controls"><input type="text" id="surah-search-input" class="search-input-new" placeholder="ل ناڤێ سورەتێ بگەڕە..." onkeyup="filterSurahButtons()"></div><div id="surah-selection-grid">${Object.entries(allData.tafsir).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).map(([num, data]) => `<button class="surah-btn" data-surah-name="${data.surahName}" onclick="displaySurahTafsir('${num}')"><span class="surah-btn-number">سورەتا ${num}</span><span class="surah-btn-name">${data.surahName}</span></button>`).join('')}</div></div><div id="tafsir-display-area" style="display:none;"></div>`; } container.innerHTML = content; }
function buildBookSalesView() { const container = document.getElementById('book-sales-view'); let content = `<header class="page-header"><h1>فرۆتنا پەرتووکان</h1><p>پەرتوکێن هەلبژارتی بۆ فرۆتنێ</p></header>`; if (!allData.bookSales || allData.bookSales.length === 0) { content += createEmptyStateMessage('نوکە هیچ پەرتوکەک بۆ فرۆتنێ بەردەست نینە.'); } else { content += `<div class="book-sales-grid">${allData.bookSales.map(book => { const purchaseButton = book.isAvailable ? `<a href="${book.purchaseLink}" target="_blank" rel="noopener noreferrer" class="purchase-btn">کرین</a>` : `<button class="purchase-btn" disabled>بۆ فرۆتنێ نییە</button>`; return `
            <div class="book-sale-card">
                <div class="book-sale-card-img-wrapper">
                    <img src="${book.coverImage}" class="book-sale-card-img" alt="بەرگێ پەرتووکێ" loading="lazy">
                </div>
                <div class="book-sale-card-content">
                    <h3>${book.title}</h3>
                    <p class="book-sale-card-author">نووسەر: ${book.author}</p>
                    <p class="book-sale-card-desc">${book.description}</p>
                    <div class="book-sale-footer">
                        <span class="book-price">${book.price}</span>
                        ${purchaseButton}
                    </div>
                </div>
            </div>`; }).join('')}</div>`; } container.innerHTML = content; }
function displayStatusMessage(viewId, stpCode) { const container = document.getElementById(viewId); if (!container) return; let icon = 'fa-info-circle', iconClass = 'status-info', title = 'تێبینی', text = 'ئەڤ بەشە نوکە نە بەردەستە.'; switch (stpCode) { case '1': icon = 'fa-hourglass-half'; iconClass = 'status-info'; title = 'دەمەکێ نێزیک'; text = 'ئەڤ بەشە د کارکرنێ دایە و دێ ل پاشەرۆژەکا نێزیک بەردەست بیت. سوپاس بۆ ل هیڤیبوونا تە.'; break; case '2': icon = 'fa-exclamation-triangle'; iconClass = 'status-danger'; title = 'ئاریشەیەکا تەکنیکی'; text = 'ئاریشەیەک د ڤی بەشی دا روویدایە. تیمێ مە یێ تەکنیکی کار لسەر چارەسەرکرنا وێ دکەت.'; break; case '3': icon = 'fa-cogs'; iconClass = 'status-warning'; title = 'ژێر چاککرنێ دایە'; text = 'ئەم نوکە کار لسەر باشترکرنا ڤی بەشی دکەین. دێ ب زووترین دەم زڤرین.'; break; case '4': icon = 'fa-sync-alt'; iconClass = 'status-info'; title = 'ناڤەرۆک دهێتە نووژەنکرن'; text = 'ناڤەرۆکا ڤی بەشی دهێتە نووژەنکرن دا زانیاریێن نووی و باشتر بهێنە پێشکێشکرن.'; break; case '5': icon = 'fa-pause-circle'; iconClass = 'status-warning'; title = 'بۆ دەمەکێ کورت هاتیە راوەستاندن'; text = 'ئەڤ بەشە بۆ دەمەکێ کورت هاتیە راوەستاندن و دێ ل دەمەکێ دی بەردەست بیت.'; break; case '6': icon = 'fa-hands-helping'; iconClass = 'status-success'; title = 'پێدڤی ب پشکداریا تەیە'; text = 'ئەم دخوازین ڤی بەشی ب پشکداریێن هەوە دەولەمەند بکەین. ئەگەر تە چ پێشنیار هەبن, <a href="#" onclick="event.preventDefault(); openModal(\'contribution-modal\')">پشکداریێ بکە</a>.'; break; } container.innerHTML = `<div class="status-message-container"><i class="fas ${icon} status-icon ${iconClass}"></i><h2 class="status-title">${title}</h2><p class="status-text">${text}</p></div>`; }

// === [ 6. لۆژیکێ تایبەت ب هەر بەشەکی ] ===
function filterLectures() { const activeCategory = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="category"].active').dataset.filterValue; const activeTeacher = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="teacher"].active').dataset.filterValue; const grid = document.getElementById('waneyan-grid'); const filteredLectures = allData.generalLectures.filter(l => (activeCategory === 'all' || l.category === activeCategory) && (activeTeacher === 'all' || l.teacherId === activeTeacher)); if (filteredLectures.length === 0) { grid.innerHTML = '<p style="text-align:center; grid-column: 1 / -1; color: var(--secondary-text);">هیچ وانەیەک لسەر ڤان فیلتەران نەهاتە دیتن.</p>'; return; } grid.innerHTML = filteredLectures.map(lecture => { const teacher = allData.teachers[lecture.teacherId]; const pdfButton = lecture.pdfUrl ? `<button onclick="showPdfInModal('${lecture.pdfUrl}', '${lecture.title}')" class="card-btn-small pdf-btn-card" title="PDF ببینە"><i class="fas fa-file-pdf"></i></button>` : ''; return `<div class="wana-card"><img src="${lecture.image}" class="wana-card-img" alt="وێنەیا وانەیێ" loading="lazy"><div class="wana-card-content"><h3>${lecture.title}</h3><p><strong>مامۆستا:</strong> <a href="#" onclick="event.preventDefault(); showTeacherProfile('${lecture.teacherId}')">${teacher?.name || 'نەناسراو'}</a></p><p><strong>بابەت:</strong> ${lecture.category}</p><div class="card-btn-group"><button class="card-btn-small" onclick="showLessonList('${lecture.id}')">لیستا وانەیان</button><button class="card-btn-small secondary" onclick="showTeacherProfile('${lecture.teacherId}')">پرۆفایل</button>${pdfButton}</div></div></div>`; }).join(''); }
function toggleCourseCompletion(courseId) { progressManager.toggleCourseCompletion(courseId); buildLevelsView(); }
function togglePdfMemorization(courseId) { progressManager.togglePdfMemorization(courseId); buildLevelsView(); }
function selectFatwaTeacher(button) { document.querySelectorAll('#fatwas-view .fatwa-scholar-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); filterFatwas(); }
function filterFatwas() { const searchInput = document.getElementById('fatwa-search-input'); const searchTerm = searchInput ? searchInput.value.toLowerCase() : ''; const container = document.getElementById('fatwa-accordion-container'); if (!container) return; const activeTeacherBtn = document.querySelector('#fatwas-view .fatwa-scholar-btn.active'); const activeTeacherId = activeTeacherBtn ? activeTeacherBtn.dataset.teacherId : 'all'; const filteredFatwas = allData.fatwas.filter(f => (activeTeacherId === 'all' || f.teacherId === activeTeacherId) && (f.question.toLowerCase().includes(searchTerm) || f.answer.toLowerCase().includes(searchTerm))); if (filteredFatwas.length === 0) { container.innerHTML = createEmptyStateMessage('هیچ پرسیار و بەرسڤەک لدویڤ لێگەریانا تە نەهاتە دیتن.'); return; } container.innerHTML = filteredFatwas.map(fatwa => { const teacher = allData.teachers[fatwa.teacherId]; const audioPlayer = fatwa.audioUrl ? `<div class="audio-player-wrapper"><p><i class="fas fa-volume-up"></i>گوێبیستی وەڵام بە بە دەنگ:</p><audio controls src="${fatwa.audioUrl}"></audio></div>` : ''; return `<div class="fatwa-accordion-item"><div class="fatwa-question" onclick="toggleFatwa(this)"><h4>${fatwa.question}</h4><i class="fas fa-chevron-down"></i></div><div class="fatwa-answer"><div class="fatwa-answer-content"><p>${fatwa.answer}</p>${audioPlayer}<p class="fatwa-teacher-info" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 10px;">بەرسڤ ژلایێ: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${fatwa.teacherId}')">${teacher ? teacher.name : 'مامۆستایەکێ نەناس'}</a></p></div></div></div>`; }).join(''); }
function toggleFatwa(element) { const item = element.closest('.fatwa-accordion-item'); const answer = item.querySelector('.fatwa-answer'); item.classList.toggle('active'); if (item.classList.contains('active')) { answer.style.maxHeight = answer.scrollHeight + 'px'; } else { answer.style.maxHeight = '0px'; } }
function initializeMainMap() { if (mapInitialized || !document.getElementById('main-map-container')) return; map = L.map('main-map-container').setView([36.85, 42.98], 10); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map); mapMarkers = {}; allData.locations.forEach(location => { const teacher = allData.teachers[location.teacherId]; const marker = L.marker(location.coordinates).addTo(map); const popupContent = `<div style="text-align:center;font-family:var(--font-kurdish);"><h4 style="margin:0;font-size:1.1rem;">${location.name}</h4><p style="margin:5px 0;"><strong>مامۆستا:</strong> ${teacher ? teacher.name : 'نەناسراو'}</p><p style="margin:5px 0;font-size:0.9rem;"><strong>وانە:</strong> ${location.lessonTaught}</p>${teacher ? `<a href="#" onclick="event.preventDefault(); showTeacherProfile('${location.teacherId}')" class="profile-link-in-popup">بینینا پرۆفایلێ</a>` : ''}</div>`; marker.bindPopup(popupContent); mapMarkers[location.id] = marker; }); mapInitialized = true; }
function focusOnMapLocation(locationId) { if (!map || !mapMarkers[locationId]) return; const location = allData.locations.find(l => l.id === locationId); if (!location) return; map.setView(location.coordinates, 15); mapMarkers[locationId].openPopup(); document.getElementById('main-map-container').scrollIntoView({ behavior: 'smooth', block: 'center' }); }
function renderLocationList() { const container = document.getElementById('location-list-container'); const searchInput = document.getElementById('map-search-input'); if (!container || !searchInput) return; const searchTerm = searchInput.value.toLowerCase(); const filteredLocations = allData.locations.filter(loc => { const teacherName = allData.teachers[loc.teacherId]?.name || ''; return loc.name.toLowerCase().includes(searchTerm) || loc.lessonTaught.toLowerCase().includes(searchTerm) || teacherName.toLowerCase().includes(searchTerm); }); container.innerHTML = filteredLocations.map(loc => { const teacher = allData.teachers[loc.teacherId]; return `<div class="location-list-item" onclick="focusOnMapLocation('${loc.id}')"><h4>${loc.name}</h4><p><i class="fas fa-chalkboard-teacher"></i> <span><strong>مامۆستا:</strong> ${teacher ? teacher.name : 'نەناسراو'}</span></p><p><i class="fas fa-book-open"></i> <span><strong>وانە:</strong> ${loc.lessonTaught}</span></p><p><i class="fas fa-clock"></i> <span><strong>کەنگی:</strong> ${loc.schedule}</span></p></div>`; }).join(''); }
function startCountdown(targetDateStr) { const countdownContainer = document.getElementById('live-countdown'); if(!countdownContainer || !targetDateStr) return; const targetDate = new Date(targetDateStr).getTime(); const interval = setInterval(() => { const distance = targetDate - new Date().getTime(); if (distance < 0) { clearInterval(interval); countdownContainer.innerHTML = "<h3>خول دەستپێکریە یان ب دوماهیک هاتیە!</h3>"; return; } const time = { days: Math.floor(distance / 864e5), hours: Math.floor((distance % 864e5) / 36e5), minutes: Math.floor((distance % 36e5) / 6e4), seconds: Math.floor((distance % 6e4) / 1e3) }; countdownContainer.innerHTML = `<div class="countdown-box"><div class="number">${time.days}</div><div class="label">ڕۆژ</div></div><div class="countdown-box"><div class="number">${time.hours}</div><div class="label">دەمژمێر</div></div><div class="countdown-box"><div class="number">${time.minutes}</div><div class="label">خولەک</div></div><div class="countdown-box"><div class="number">${time.seconds}</div><div class="label">چرکە</div></div>`; }, 1000); }
function selectHadithFilter(button, type) { document.querySelectorAll(`#hadith-view .filter-btn[data-filter-type="${type}"]`).forEach(btn => btn.classList.remove('active')); button.classList.add('active'); filterHadiths(true); }
function filterHadiths(resetPage = false) { if (resetPage) hadithCurrentPage = 1; const searchInput = document.getElementById('hadith-search-input'); const searchTerm = searchInput ? searchInput.value.toLowerCase() : ''; const activeCategoryBtn = document.querySelector('#hadith-view .filter-btn[data-filter-type="category"].active'); const activeCategory = activeCategoryBtn ? activeCategoryBtn.textContent : 'هەمووی'; const filtered = allData.hadiths.filter(h => (activeCategory === 'هەمووی' || h.category === activeCategory) && (h.text.toLowerCase().includes(searchTerm))); renderHadithPage(filtered); }
function renderHadithPage(filteredData) { const container = document.getElementById('hadith-list-container'); const paginationContainer = document.getElementById('hadith-pagination-container'); if (!container || !paginationContainer) return; const totalPages = Math.ceil(filteredData.length / hadithsPerPage); const start = (hadithCurrentPage - 1) * hadithsPerPage; const end = start + hadithsPerPage; const pageData = filteredData.slice(start, end); if (pageData.length === 0) { container.innerHTML = createEmptyStateMessage('هیچ حەدیسەک لدویڤ لێگەریانا تە نەهاتە دیتن.'); paginationContainer.innerHTML = ''; return; } container.innerHTML = pageData.map(h => { let gradeClass = ''; if (h.grade.toLowerCase() === 'صحيح' || h.grade.toLowerCase() === 'sahih') gradeClass = 'sahih'; else if (h.grade.toLowerCase() === 'حسن' || h.grade.toLowerCase() === 'hasan') gradeClass = 'hasan'; else if (h.grade.toLowerCase() === 'ضعيف' || h.grade.toLowerCase() === 'daif') gradeClass = 'daif'; const audioPlayer = h.audioUrl ? `<button class="hadith-action-btn" onclick="playMediaInModal('${h.audioUrl}', 'گوهداری ل حەدیسێ بکە')"><i class="fas fa-volume-up"></i> گوهداری</button>` : ''; return `<div class="hadith-card-new"><div class="hadith-header"><span class="hadith-number">حەدیسا #${h.number}</span>${gradeClass ? `<span class="hadith-grade ${gradeClass}">${h.grade}</span>` : ''}</div><div class="hadith-content"><p class="hadith-text-new" id="${h.id}">"${h.text}"</p><div class="hadith-actions"><button class="hadith-action-btn" onclick="copyHadithText('${h.id}', this)"><i class="fas fa-copy"></i> کۆپی کرن</button>${audioPlayer}</div></div><div class="hadith-footer"><span><strong>ژێدەر:</strong> ${h.source}</span><span><strong>راوی:</strong> ${h.narrator}</span><span><strong>بابەت:</strong> ${h.category}</span></div></div>`; }).join(''); paginationContainer.innerHTML = `<button class="pagination-btn" onclick="changeHadithPage(-1)" ${hadithCurrentPage === 1 ? 'disabled' : ''}>&lt; پێشتر</button><span>پەرێ ${hadithCurrentPage} ژ ${totalPages}</span><button class="pagination-btn" onclick="changeHadithPage(1)" ${hadithCurrentPage === totalPages ? 'disabled' : ''}>پاشتر &gt;</button>`; }
function changeHadithPage(direction) { hadithCurrentPage += direction; filterHadiths(false); document.getElementById('hadith-view').scrollIntoView({ behavior: 'smooth' }); }
function filterSurahButtons() { const searchTerm = document.getElementById('surah-search-input').value.toLowerCase(); const buttons = document.querySelectorAll('#surah-selection-grid .surah-btn'); buttons.forEach(btn => { const surahName = btn.dataset.surahName.toLowerCase(); if (surahName.includes(searchTerm)) { btn.style.display = 'block'; } else { btn.style.display = 'none'; } }); }
function displaySurahTafsir(surahNumber) { const surahData = allData.tafsir[surahNumber]; if (!surahData) { console.error(`No tafsir data found for surah number: ${surahNumber}`); alert('چ زانیاریەک بۆ ڤێ سورەتێ نەهاتە دیتن.'); return; } document.getElementById('surah-selection-area').style.display = 'none'; const displayArea = document.getElementById('tafsir-display-area'); displayArea.style.display = 'block'; const audioPlayerHTML = surahData.audioUrl ? `<div class="audio-player-wrapper" style="margin: 0 0 20px 0; padding: 20px 0 0 0; border-top: 1px solid var(--border-color);"><p><i class="fas fa-volume-up"></i>گوهداریێ ل تەفسیرێ بکە:</p><audio controls src="${surahData.audioUrl}" style="width:100%;"></audio></div>` : ''; displayArea.innerHTML = `<button class="back-to-surah-btn" onclick="showSurahSelection()"><i class="fas fa-arrow-right"></i> ڤەگەڕیان بۆ لیستا سورەتان</button><h2 style="text-align:center; margin-bottom:15px;">تەفسیرا ${surahData.surahName}</h2><div class="tafsir-meta-info"><div class="tafsir-meta-item"><i class="fas fa-list-ol" style="color: var(--accent-color); margin-left: 5px;"></i> هژمارا ئایەتان: <span>${surahData.ayahCount}</span></div><div class="tafsir-meta-item"><i class="fas fa-moon" style="color: var(--accent-color); margin-left: 5px;"></i> جۆر: <span>${surahData.revelationType}</span></div></div><div class="tafsir-content-full"><p>${surahData.fullTafsir}</p></div>${audioPlayerHTML}`; displayArea.scrollIntoView({ behavior: 'smooth' }); }
function showSurahSelection() { document.getElementById('tafsir-display-area').style.display = 'none'; document.getElementById('surah-selection-area').style.display = 'block'; }


// === [ 7. فەنکشنێن هاریکار (Helper Functions) ] ===
// گوهۆڕینی نوێ: ناڤیگەیشن و دیکما ڤەگەریانێ
function navigateToView(viewId) {
    document.querySelectorAll('.view-section').forEach(section => {
        section.classList.remove('is-visible');
    });

    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.classList.add('is-visible');
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // نیشاندان/ڤەشارتنا دیکما ڤەگەریانێ
        const backBtn = document.getElementById('back-to-home-btn');
        if (viewId === 'home-view') {
            backBtn.style.display = 'none';
        } else {
            backBtn.style.display = 'inline-flex';
        }

        if (viewId === 'map-view' && !mapInitialized) {
            initializeMainMap();
        }
    } else {
        console.warn(`View with ID "${viewId}" not found.`);
    }
}
function showHomeView() {
    navigateToView('home-view');
}

function showLessonList(lectureId) { const lecture = allData.generalLectures.find(l => l.id === lectureId); if (!lecture) return; openModal('lesson-list-modal'); document.getElementById('lesson-list-title').textContent = lecture.title; document.getElementById('lesson-list-container').innerHTML = lecture.videos.map(video => `<div class="lesson-item clickable" onclick="playMediaInModal('${video.url}', '${video.title}')"><span>${video.title}</span><button class="watch-btn">تەماشەکرن</button></div>`).join(''); }
function showLevelCourseLessons(levelIndex, courseIndex) { const course = allData.levels[levelIndex]?.courses[courseIndex]; if (!course) return; openModal('lesson-list-modal'); document.getElementById('lesson-list-title').textContent = course.title; document.getElementById('lesson-list-container').innerHTML = course.videos.map(video => `<div class="lesson-item clickable" onclick="playMediaInModal('${video.url}', '${video.title} - ${course.title}')"><span>${video.title}</span><button class="watch-btn">تەماشەکرن</button></div>`).join(''); }
function showTeacherProfile(teacherId) { const teacher = allData.teachers[teacherId]; if (!teacher) return; openModal('teacher-profile-modal'); const container = document.getElementById('profile-dynamic-content'); let contactHTML = Object.entries(teacher.social).map(([platform, url]) => { if(url) return `<a href="${url}" target="_blank" rel="noopener noreferrer"><i class="fab fa-${platform.toLowerCase()}"></i> ${platform.charAt(0).toUpperCase() + platform.slice(1)}</a>`; return ''; }).join(''); if (teacher.phone) { contactHTML = `<a href="tel:${teacher.phone}"><i class="fas fa-phone"></i> ${teacher.phone}</a>` + contactHTML; } const teacherLectures = allData.generalLectures.filter(l => l.teacherId === teacherId); const lessonsHTML = teacherLectures.map(l => { const pdfButton = l.pdfUrl ? `<button class="pdf-btn-new" onclick="showPdfInModal('${l.pdfUrl}', '${l.title}')" title="PDF ببینە"><i class="fas fa-file-pdf"></i></button>` : ''; return `<div class="lesson-item-new"><div class="lesson-info"><i class="fas fa-video"></i> <span>${l.title}</span></div><div class="lesson-actions">${pdfButton}<button class="watch-btn-new" onclick="closeModal('teacher-profile-modal');showLessonList('${l.id}')">وانەکان ببینە</button></div></div>`; }).join(''); const teacherLocations = allData.locations.filter(loc => loc.teacherId === teacherId); let locationsHTML = ''; if (teacherLocations.length > 0) { locationsHTML = `<div style="padding: 0 30px 30px 30px; background-color: var(--dark-bg);"><div class="profile-tabbed-content"><h3 class="profile-section-title-new"><i class="fas fa-map-marker-alt"></i> جهێن وانەگوتنێ</h3><div class="profile-locations-panel" style="display: grid; gap: 15px;">${teacherLocations.map(loc => `<div class="location-list-item" onclick="goToMapLocation('${loc.id}')"><h4>${loc.name}</h4><p><i class="fas fa-book-open"></i> <span><strong>وانە:</strong> ${loc.lessonTaught}</span></p><p><i class="fas fa-clock"></i> <span><strong>کەنگی:</strong> ${loc.schedule}</span></p></div>`).join('')}</div></div></div>`; } container.innerHTML = `<div class="profile-new-header"><div class="profile-header-img-wrapper"><img src="${teacher.profileImage}" alt="Wêneyê Profaylê" loading="lazy"></div></div><div style="text-align: center; margin-top: -60px; position:relative; z-index:2;"><h2 id="profile-header-name-new">${teacher.name}</h2><p id="profile-header-bio-new">${teacher.bio}</p></div><div class="profile-new-grid"><div class="profile-main-info"><h3 class="profile-section-title-new"><i class="fas fa-link"></i> پەیوەندی</h3><div class="profile-contact-buttons">${contactHTML || '<p style="color:var(--secondary-text);">هیچ زانیارییەکی پەیوەندی نییە.</p>'}</div></div><div class="profile-tabbed-content"><h3 class="profile-section-title-new"><i class="fas fa-book-reader"></i> وانەیێن گشتی</h3><div class="profile-lessons-panel">${lessonsHTML || '<p style="color:var(--secondary-text); text-align:center;">هیچ وانەیەک بۆ ڤی مامۆستای نەهاتیە تۆمارکرن.</p>'}</div></div></div>${locationsHTML}`; }
function updateAndShowVisitorCount() { const counterElement = document.getElementById('visitor-counter'); if (!counterElement) return; fetch(`https://api.countapi.xyz/hit/proje-tawhid-badini/visits`).then(res => res.json()).then(data => { counterElement.textContent = new Intl.NumberFormat('en-US').format(data.value); }).catch(err => { console.error("Çewtî di wergirtina jimara seredankera da:", err); counterElement.textContent = "N/A"; }); }
function convertYoutubeUrlToEmbed(url) { if (!url) return ''; let videoId = null; const patterns = [/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/, /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/, /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?]+)/]; for (const pattern of patterns) { const match = url.match(pattern); if (match && match[1]) { videoId = match[1]; break; } } return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0` : url; }
function playMediaInModal(url, title) { document.getElementById('media-player-title').textContent = title || 'تەماشاكرنا وانەیێ'; const container = document.getElementById('media-player-container'); let embedHtml = ''; if (url.includes('youtube.com') || url.includes('youtu.be')) { const embedUrl = convertYoutubeUrlToEmbed(url); embedHtml = `<iframe src="${embedUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; container.style.paddingTop = "56.25%"; } else if (url.includes('facebook.com/')) { const encodedUrl = encodeURIComponent(url); const embedUrl = `https://www.facebook.com/plugins/video.php?href=${encodedUrl}&show_text=false&width=560&autoplay=true`; embedHtml = `<iframe src="${embedUrl}" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`; container.style.paddingTop = "56.25%"; } else if (url.match(/\.(mp3|wav|ogg|m4a)$/i)) { embedHtml = `<audio src="${url}" controls autoplay style="width: 100%; margin-top: 20px;"></audio>`; container.style.paddingTop = "0"; } else { embedHtml = `<p style="color:var(--warning-color); text-align:center;">نەهاتە پشتراستکرن کا ئەڤ لینکە دشێت بهێتە نیشاندان. دووبارە هەول بدە.</p>`; container.style.paddingTop = "0"; } container.innerHTML = embedHtml; openModal('media-player-modal'); }
function showPdfInModal(url, title) { document.getElementById('pdf-viewer-title').textContent = title || 'خواندن'; document.getElementById('pdf-iframe').src = url; openModal('pdf-viewer-modal'); }
function goToMapLocation(locationId) { closeModal('teacher-profile-modal'); navigateToView('map-view'); setTimeout(() => { focusOnMapLocation(locationId); }, 300); }
function checkLevelUnlockCode(levelIndex) { const level = allData.levels[levelIndex]; const input = document.getElementById(`unlock-code-input-${levelIndex}`); const statusMsg = document.getElementById(`unlock-status-${levelIndex}`); if (!level || !input || !statusMsg) return; const enteredCode = input.value.trim(); const correctCode = level.unlockCode; if (!correctCode) { statusMsg.textContent = 'ئەڤ ئاستە ب کۆدی ناهێتە ڤەکرن.'; statusMsg.style.color = 'var(--warning-color)'; return; } if (enteredCode === correctCode) { statusMsg.textContent = 'پیرۆزە! کۆد راستە. ئاست هاتە ڤەکرن.'; statusMsg.style.color = 'var(--success-color)'; progressManager.unlockLevel(levelIndex); setTimeout(buildLevelsView, 1500); } else { statusMsg.textContent = 'کۆد نە راستە. هیڤیدارین دووبارە هەول بدە.'; statusMsg.style.color = 'var(--danger-color)'; input.focus(); } }
function resetAllProgress() { const confirmation = confirm("ئاگاداری: ئەگەر پشتراست بی، هەمی پێشکەفتنا تە دێ هێتە ژێبرن و دێ زڤری خالا دەستپێکێ. دێ بەردەوام بی؟"); if (confirmation) { localStorage.removeItem(progressManager.completedCoursesKey); localStorage.removeItem(progressManager.memorizedPdfsKey); localStorage.removeItem(progressManager.unlockedLevelsKey); alert("پێشکەفتنا تە هاتە ژێبرن."); buildLevelsView(); } }
function copyHadithText(elementId, button) { const textElement = document.getElementById(elementId); if (!textElement) return; navigator.clipboard.writeText(textElement.innerText).then(() => { const originalText = button.innerHTML; button.innerHTML = `<i class="fas fa-check"></i> کۆپی بوو!`; setTimeout(() => { button.innerHTML = originalText; }, 2000); }).catch(err => { console.error('Failed to copy text: ', err); }); }


// === [ 8. هنارتنا فەنکشنان بۆ نافا HTML ] ===
window.openModal = openModal; window.closeModal = closeModal;
window.showLessonList = showLessonList; window.showLevelCourseLessons = showLevelCourseLessons;
window.showTeacherProfile = showTeacherProfile;
window.renderLocationList = renderLocationList;
window.focusOnMapLocation = focusOnMapLocation; window.playMediaInModal = playMediaInModal; window.showPdfInModal = showPdfInModal;
window.goToMapLocation = goToMapLocation; window.toggleCourseCompletion = toggleCourseCompletion;
window.filterFatwas = filterFatwas; window.toggleFatwa = toggleFatwa; window.selectFatwaTeacher = selectFatwaTeacher;
window.filterHadiths = filterHadiths; window.selectHadithFilter = selectHadithFilter;
window.changeHadithPage = changeHadithPage; window.copyHadithText = copyHadithText;
window.displaySurahTafsir = displaySurahTafsir; window.filterSurahButtons = filterSurahButtons;
window.showSurahSelection = showSurahSelection;
window.checkLevelUnlockCode = checkLevelUnlockCode;
window.resetAllProgress = resetAllProgress;
window.navigateToView = navigateToView;
window.showHomeView = showHomeView;
window.togglePdfMemorization = togglePdfMemorization;

})();
</script>
</body>
</html>
