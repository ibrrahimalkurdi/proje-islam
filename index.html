<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرۆژێ زانست</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');

        :root {
            --dark-bg: #0d1117; --primary-text: #c9d1d9; --secondary-text: #8b949e; --accent-color: #58a6ff;
            --border-color: #30363d; --card-bg: #161b22; --font-kurdish: 'Noto Sans Arabic', sans-serif;
            --success-color: #2ea043; --danger-color: #f85149;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; } html { scroll-behavior: smooth; }
        body { font-family: var(--font-kurdish); background-color: var(--dark-bg); color: var(--primary-text); line-height: 1.7; }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .container { width: 90%; max-width: 1200px; margin: auto; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1f2e 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #loading-screen.fade-out { opacity: 0; pointer-events: none; }
        .loading-logo { font-size: 4rem; font-weight: 700; color: var(--primary-text); margin-bottom: 20px; animation: pulse 2s infinite; }
        .loading-logo span { color: var(--accent-color); }
        .welcome-text { font-size: 1.5rem; color: var(--secondary-text); text-align: center; margin-bottom: 30px; animation: fadeInUp 1s ease-out 0.5s both; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        header { position: sticky; top: 0; width: 100%; padding: 15px 0; z-index: 1000; background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo { font-size: 26px; font-weight: 700; text-decoration: none; color: var(--primary-text); cursor: pointer; }
        .logo span { color: var(--accent-color); }
        nav { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        nav a { color: var(--secondary-text); text-decoration: none; padding: 8px 16px; font-weight: 500; transition: color 0.3s, border-bottom-color 0.3s; cursor: pointer; border-bottom: 2px solid transparent; }
        nav a:hover, nav a.active { color: var(--primary-text); border-bottom-color: var(--accent-color); }
        
        footer { padding: 40px 20px; text-align: center; border-top: 1px solid var(--border-color); margin-top: 50px; color: var(--secondary-text); }
        /* --- NEW, LESS PROMINENT STYLE --- */
        .contribution-link-btn { display: inline-block; background-color: transparent; border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 18px; border-radius: 8px; margin-top: 20px; text-decoration: none; transition: all 0.3s; }
        .contribution-link-btn:hover { background-color: var(--card-bg); border-color: var(--accent-color); color: var(--primary-text); transform: translateY(-2px); }
        .contribution-link-btn i { margin-left: 8px; }

        .view { display: none; }
        .view.is-active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .page-header { text-align: center; padding: 50px 20px; } 
        .page-header h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(120deg, var(--primary-text), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        .back-btn { background: none; border: none; color: var(--secondary-text); font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 30px; }
        .accordion { background: transparent; color: var(--primary-text); cursor: pointer; padding: 18px 25px; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; text-align: right; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition: all 0.3s; }
        .accordion .icon { transition: transform 0.3s ease-out; } .accordion.active .icon { transform: rotate(90deg); }
        .accordion:hover, .accordion.active { border-color: var(--accent-color); background: var(--card-bg); }
        .panel { padding: 5px 20px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .item-card { background: var(--card-bg); border-left: 3px solid transparent; border-radius: 6px; padding: 15px 20px; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
        .item-card:hover { border-left-color: var(--accent-color); transform: translateX(5px); }
        .item-card.completed { border-left-color: var(--success-color) !important; background-color: rgba(46, 160, 67, 0.1); }
        .item-card.completed h4::after { content: ' ✔'; color: var(--success-color); font-weight: bold; }

        #reading-view .reading-layout { display: flex; flex-direction: column; } .sharah-wrapper { background-color: var(--card-bg); border-radius: 10px; padding: 25px; margin-bottom: 40px; }
        .sharah-header { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px; }
        .sharah-header h2 { font-size: 2rem; margin: 0; }
        .matn-tools { display: flex; gap: 10px; margin-right: auto; }
        .matn-tool-btn { background: var(--border-color); color: var(--primary-text); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; }
        .matn-tool-btn:hover { background-color: var(--accent-color); }
        .teacher-tabs { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 25px; align-items: center; }
        .teacher-tab { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .teacher-tab a { color: inherit; text-decoration: none;}
        .teacher-tab.active { background: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
        #matn-content-container p { font-size: 1.6rem; line-height: 2.4; color: var(--primary-text); text-align: center; margin-bottom: 1.5em; }
        
        /* --- Advanced Quiz Styles --- */
        .quiz-section { border-top: 1px solid var(--border-color); margin-top: 30px; padding-top: 30px; }
        .quiz-start-btn { display: block; margin: 20px auto; padding: 12px 30px; font-size: 1.1rem; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-kurdish); transition: all 0.2s ease; }
        .quiz-start-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(88, 166, 255, 0.2); }
        #quiz-container { max-width: 700px; margin: 0 auto; }
        .quiz-progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 10px; height: 10px; margin-bottom: 20px; overflow: hidden; }
        .quiz-progress-bar { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.4s ease-in-out; }
        .quiz-question-card { background-color: var(--dark-bg); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); display: none; }
        .quiz-question-card.active { display: block; animation: fadeIn 0.5s; }
        .quiz-question-card p { font-size: 1.3rem; margin-bottom: 20px; }
        .quiz-options label { display: block; background-color: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border-color); transition: all .2s; position: relative; }
        .quiz-options label:hover { border-color: var(--accent-color); background-color: rgba(88, 166, 255, 0.1); }
        .quiz-options input { margin-left: 10px; }
        .quiz-options label.correct { border-color: var(--success-color) !important; background-color: rgba(46, 160, 67, 0.15); font-weight: bold; }
        .quiz-options label.incorrect { border-color: var(--danger-color) !important; background-color: rgba(248, 81, 73, 0.1); }
        .quiz-options label.correct::after, .quiz-options label.incorrect::after { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        .quiz-options label.correct::after { content: '\f00c'; color: var(--success-color); }
        .quiz-options label.incorrect::after { content: '\f00d'; color: var(--danger-color); }
        .quiz-nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .quiz-results-card { background: var(--card-bg); padding: 30px; border-radius: 10px; text-align: center; margin-top: 20px; border: 1px solid var(--border-color); animation: fadeIn 0.5s; }
        .quiz-results-card h3 { font-size: 1.8rem; margin-bottom: 10px; }
        .quiz-results-card .result-icon { font-size: 3rem; margin-bottom: 15px; }
        .quiz-results-card .result-icon.pass { color: var(--success-color); }
        .quiz-results-card .result-icon.fail { color: var(--danger-color); }
        .quiz-results-card p { font-size: 1.1rem; }
        
        .filters-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; align-items: center; background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color);}
        .filter-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
        .filter-group h4 { margin: 0 15px 0 0; font-weight: 500; color: var(--primary-text); }
        .filter-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 8px 20px; border-radius: 50px; cursor: pointer; }
        .filter-btn:hover, .filter-btn.active { background: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
        
        .waneyan-grid, .pirtuk-grid { display: grid; gap: 25px; } .waneyan-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } .pirtuk-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        .wana-card, .pirtuk-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s; }
        .wana-card:hover, .pirtuk-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .wana-card-img, .pirtuk-card-img { width: 100%; object-fit: cover; } .wana-card-img { height: 180px; } .pirtuk-card-img { height: 320px; border-bottom: 1px solid var(--border-color);}
        .wana-card-content, .pirtuk-card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-btn-group { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; }
        .card-btn-small { flex: 1; background: var(--accent-color); color: #fff; padding: 10px; text-align: center; text-decoration: none; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; }
        .card-btn-small.secondary { background: var(--border-color); } .card-btn-small:hover { opacity: 0.9; }

        .lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-right: 3px solid var(--border-color); transition: border-color .3s; }
        .lesson-item:hover { border-right-color: var(--accent-color); } .lesson-item span { font-size: 1rem; } .lesson-item.clickable { cursor: pointer; } .watch-btn { background: none; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 5px 12px; border-radius: 5px; cursor: pointer; }
        
        #teacher-stories-bar { display: flex; gap: 20px; overflow-x: auto; padding: 20px 10px; margin-bottom: 25px; scrollbar-width: none; } #teacher-stories-bar::-webkit-scrollbar { display: none; }
        .teacher-story { display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; }
        .story-avatar-wrapper { cursor: pointer; } .teacher-story .story-avatar { width: 70px; height: 70px; border-radius: 50%; padding: 3px; background: linear-gradient(45deg, var(--accent-color), #f09433, #e6683c, #dc2743, #cc2366, #bc1888, #7921c2); }
        .teacher-story .story-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--dark-bg); }
        .story-profile-link { font-size: 0.75rem; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.is-visible { display: flex; animation: fadeIn 0.3s; }
        .modal-content { position: relative; width: 90%; background:var(--card-bg); border-radius:10px; max-height: 85vh; overflow-y: auto; }
        .close-modal-btn { position: absolute; top: 15px; right: 20px; color: var(--secondary-text); font-size: 2rem; cursor: pointer; z-index: 10; }
        #lesson-list-modal .modal-content { max-width: 600px; padding: 30px; } #lesson-list-modal h3 { margin-bottom: 20px; text-align: center; font-size: 1.5rem; }
        
        .profile-modal-content { max-width: 900px; padding: 0; }
        .profile-modal-header { padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        #profile-header-img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent-color); object-fit: cover; margin-bottom: 15px;}
        #profile-header-name { font-size: 1.8rem; }
        .profile-modal-body { padding: 25px 30px; }
        .profile-section-title { font-size: 1.3rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; margin-bottom: 20px; }
        .contact-info { display: flex; flex-wrap: wrap; gap: 25px; } .contact-info a { color: var(--secondary-text); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .contact-info i { font-size: 1.4rem; } 
        .location-item { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 15px; border-right: 3px solid var(--border-color); transition: border-color 0.3s; }
        .location-item:hover { border-right-color: var(--accent-color); }
        .location-item p { margin: 0 0 8px 0; line-height: 1.6; } .location-item p:last-child { margin-bottom: 0; }
        .location-item a { color: var(--accent-color); text-decoration: none; font-size: 0.9rem; font-weight: bold; }
        #map-container { min-height: 450px; border-radius: 10px; border: 1px solid var(--border-color); }

        /* --- Live Course Styles & Registration Form --- */
        .live-view-content { text-align: center; padding: 40px 20px; }
        .live-view-content .live-badge { background-color: var(--danger-color); color: white; padding: 5px 15px; border-radius: 50px; font-size: 1rem; display: inline-block; margin-bottom: 20px; animation: livePulse 2s infinite; }
        @keyframes livePulse { 0% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(248, 81, 73, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0); } }
        .live-view-content h1 { font-size: 3rem; margin-bottom: 15px; }
        .live-view-content .live-teacher-info { margin-bottom: 30px; font-size: 1.2rem; }
        #live-countdown { display: flex; justify-content: center; gap: 20px; margin: 40px 0; }
        .countdown-box { background: var(--card-bg); padding: 20px; border-radius: 10px; min-width: 100px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
        .countdown-box .number { font-size: 2.5rem; font-weight: 700; color: var(--accent-color); }
        .countdown-box .label { font-size: 0.9rem; color: var(--secondary-text); }
        .live-details-section { max-width: 800px; margin: 40px auto; text-align: right; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }
        .live-details-section ul { list-style-position: inside; padding-right: 20px; }
        
        /* Registration Form Styles */
        #live-registration-section { margin-top: 50px; }
        .form-group { margin-bottom: 20px; text-align: right; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input[type="text"], .form-group input[type="email"], .form-group textarea { width: 100%; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--primary-text); padding: 12px; border-radius: 6px; font-family: var(--font-kurdish); }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-color); outline: none; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group-checkbox { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .form-submit-btn { width: 100%; padding: 12px; font-size: 1.1rem; background-color: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-kurdish); }
        .live-registration-form { max-width: 600px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 10px; border: 1px solid var(--border-color); }

        /* Contribution Modal Styles */
        #contribution-modal .modal-content { max-width: 700px; padding: 30px; text-align: right; }
        #contribution-modal h3 { text-align: center; margin-bottom: 25px; font-size: 1.6rem; }
        .contribution-step-title { font-size: 1.2rem; margin-bottom: 15px; color: var(--primary-text); font-weight: 500; text-align: center;}
        #contribution-type-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .contribution-type-btn { background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--secondary-text); padding: 15px 25px; border-radius: 8px; cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; }
        .contribution-type-btn:hover, .contribution-type-btn.active { background-color: var(--accent-color); color: var(--dark-bg); border-color: var(--accent-color); }
        .contribution-type-btn i { display: block; font-size: 1.8rem; margin-bottom: 10px; }
        #contribution-form .form-fields-group { display: none; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-logo">زانست<span>.</span></div>
        <div class="welcome-text">بخێر هاتن بۆ ڕێکا زانستی</div>
        <div class="loading-spinner"></div>
    </div>

    <header>
        <div class="container">
            <a href="#" onclick="switchNav(document.querySelector('#main-nav a'), 'manhaj-view')" class="logo">زانست<span>.</span></a>
            <nav id="main-nav">
                <a href="#" onclick="switchNav(this, 'manhaj-view')">ڕێکا زانستی</a>
                <a href="#" onclick="switchNav(this, 'waneyan-view')">وانەیێن گشتی</a>
                <a href="#" onclick="switchNav(this, 'pirtukxane-view')">پەرتوکخانە</a>
                <a href="#" onclick="switchNav(this, 'teachers-view')">مامۆستا و جهـ</a>
                <a href="#" onclick="switchNav(this, 'live-view')">خولێن ڕاستەوخۆ</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Views -->
        <div id="manhaj-view" class="view"></div>
        <div id="reading-view" class="view"></div>
        <div id="waneyan-view" class="view"></div>
        <div id="pirtukxane-view" class="view"></div>
        <div id="teachers-view" class="view"></div>
        <div id="live-view" class="view"></div>
    </main>
    
    <!-- All Modals -->
    <div class="modal-overlay" id="lesson-list-modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('lesson-list-modal')">&times;</span>
            <h3 id="lesson-list-title"></h3>
            <div id="lesson-list-container"></div>
        </div>
    </div>
    <div class="modal-overlay" id="teacher-profile-modal">
        <div class="modal-content profile-modal-content">
            <span class="close-modal-btn" onclick="closeModal('teacher-profile-modal')">&times;</span>
            <div class="profile-modal-header"><img id="profile-header-img" src=""><h2 id="profile-header-name"></h2><p id="profile-header-bio"></p></div>
            <div class="profile-modal-body">
                <div id="contact-section"><h3 class="profile-section-title">پەیوەندی</h3><div id="contact-info-container" class="contact-info"></div></div>
                <div id="locations-section" style="margin-top: 30px;"><h3 class="profile-section-title">جهێن وانەگۆتنێ</h3><div id="profile-locations-container"></div></div>
                <div id="lessons-section" style="margin-top: 30px;"><h3 class="profile-section-title">وانە و زنجیرە</h3><div id="profile-lessons-container"></div></div>
            </div>
        </div>
    </div>
    
    <!-- MODIFIED CONTRIBUTION MODAL -->
    <div class="modal-overlay" id="contribution-modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('contribution-modal')">&times;</span>
            <h3>پشکداریێ د پرۆژەی دا بکە</h3>
            <div id="contribution-form-container">
                <p class="contribution-step-title">تۆ دێ حەزکەی چ جورە پشکداریێ کەی؟</p>
                <div id="contribution-type-selector">
                    <button class="contribution-type-btn" onclick="showContributionFields('teacher')"><i class="fas fa-chalkboard-teacher"></i>مامۆستا</button>
                    <button class="contribution-type-btn" onclick="showContributionFields('lesson')"><i class="fas fa-video"></i>وانەیێن گشتی</button>
                    <button class="contribution-type-btn" onclick="showContributionFields('book')"><i class="fas fa-book-open"></i>پەرتووک</button>
                </div>
                
                <!-- FIXED FORM ACTION -->
                <form id="contribution-form" action="https://formspree.io/f/mzzvyjve" method="POST" style="display: none;">
                    <input type="hidden" id="contribution_type_input" name="جۆرێ پشکداریێ" value="">
                    
                    <div id="teacher-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن مامۆستای بنڤیسە</p>
                        <div class="form-group"><label>ناڤێ مامۆستای:</label><input type="text" name="ناڤێ مامۆستای" required></div>
                        <!-- NEW FIELD FOR REGION -->
                        <div class="form-group"><label>شار/دەڤەرێ مامۆستای:</label><input type="text" name="دەڤەرێ مامۆستای" required></div>
                        <div class="form-group"><label>کورتەیەک لسەر ژیانی یان پسپۆری:</label><textarea name="ژیانناما مامۆستای"></textarea></div>
                        <div class="form-group"><label>پەیوەندی (ئیمەیل، تەلەفون، یان لینکێ سۆشیال میدیایێ):</label><input type="text" name="پەیوەندیا مامۆستای" required></div>
                    </div>
                    
                    <div id="lesson-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن زنجیرە وانەیێ بنڤیسە</p>
                        <div class="form-group"><label>ناڤونیشانێ زنجیرە وانەیێ:</label><input type="text" name="ناڤونیشانێ وانەیێ" required></div>
                        <div class="form-group"><label>ناڤێ مامۆستایێ وانەبێژ:</label><input type="text" name="مامۆستایێ وانەیێ" required></div>
                        <div class="form-group"><label>لینکێ زنجیرە وانەیێ (بۆ نموونە لینکێ پلەیلیستا یوتیوبی):</label><input type="text" name="لینکێ وانەیێ" required></div>
                    </div>

                    <div id="book-fields" class="form-fields-group">
                        <p class="contribution-step-title">هیڤیدارین پێزانینێن پەرتووکێ بنڤیسە</p>
                        <div class="form-group"><label>ناڤێ پەرتووکێ:</label><input type="text" name="ناڤێ پەرتووکێ" required></div>
                        <div class="form-group"><label>ناڤێ نڤیسەری:</label><input type="text" name="نڤیسەرێ پەرتووکێ" required></div>
                        <div class="form-group"><label>لینکێ خواندنێ یان داگرتنێ (PDF):</label><input type="text" name="لینکێ پەرتووکێ" required></div>
                    </div>

                    <!-- NEW COMMON FIELDS -->
                    <div class="form-group">
                        <label>پەیوەندییا هنێرەری (بۆ نموونە ئیمێل یان تەلەفون - نە پێدڤیە):</label>
                        <input type="text" name="پەیوەندییا هنێرەری">
                    </div>
                    <div class="form-group">
                        <label>تێبینی یان پێشنیارەکا دی:</label>
                        <textarea name="تێبینی"></textarea>
                    </div>
                    
                    <button type="submit" class="form-submit-btn">پشکداریێ هنێرە</button>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 - پرۆژێ زانست. هەمی ماف پاراستینە.</p>
        <div class="footer-contribution-area">
             <a href="#" class="contribution-link-btn" onclick="openModal('contribution-modal')">
                <i class="fas fa-hands-helping"></i>
                پشکداریێ بکە یان پێشنیارەکێ بکە
            </a>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- DATA ---
        const allData = {
            'teachers': {
                'bryar_ahmad': { name: 'م.بریار ئەحمەد', profileImage: 'https://i.postimg.cc/HxCQWnsN/IMG-0990.jpg', bio: 'پسپۆر د زانستێن شەرعی دا و خودان چەندین زنجیرە وانەیێن تۆمارکری.', phone: '+964 750 873 3725', social: { youtube: 'https://youtube.com/@bryar_ahmad?si=7V9o1a0k-kkC6TPR', telegram: 'https://t.me/Bryar_ahmaad' }, locations: [ { name: 'مزگەفتا شێلی، تاخێ شێلێ', coordinates: [36.8625, 42.9885], schedule: 'هەر ڕۆژا پێنچ شەمبی، پشتی نڤێژا مەغریب', lessonTaught: 'شلۆڤەکرنا پەرتووکا "الأصول الثلاثة"' }, { name: 'مزگەفتا تەقوا، دهۆک', coordinates: [36.8580, 42.9990], schedule: 'هەر ڕۆژا سێ شەمبی، پشتی نڤێژا عەسر', lessonTaught: 'شلۆڤەکرنا پەرتووکا "نواقض الإسلام"' } ] }, 
                'ismail_zaxo': { name: 'مامۆستا ئیسماعیل', profileImage: 'https://randomuser.me/api/portraits/men/55.jpg', bio: 'پسپۆر د فقهێ داراییدا و خودان چەندین پەرتوکە ل زاخۆ.', phone: '٠٧٥٠٢٢٢٣٣٤٤', social: { youtube: '#', facebook: '#' }, locations: [ { name: 'مزگەفتا زاخو یا مەزن، زاخۆ', coordinates: [37.1435, 42.6820], schedule: 'هەر ڕۆژا چارشەمبی، پشتی نڤێژا عیشا', lessonTaught: 'فقهێ کرین و فرۆتنێ' } ] }, 
                'kawa_erbil': { name: 'مامۆستا کاوە', profileImage: 'https://randomuser.me/api/portraits/men/33.jpg', bio: 'شارەزا د زانستێ سیرە و مێژوویا ئیسلامی دا ل هەولێرێ.', phone: '٠٧٥٠٣٣٣٤٤٥٥', social: { telegram: '#', twitter: '#' }, locations: [ { name: 'مزگەفتا جەلیل خەیات، هەولێر', coordinates: [36.1740, 44.0085], schedule: 'هەمی ڕۆژێن ئێک شەمبی، پشتی نڤێژا سپێدێ', lessonTaught: 'ژیانناما پێغەمبەری ﷺ' } ] }, 
                'ali_sulaymani': { name: 'مامۆستا عەلی', profileImage: 'https://randomuser.me/api/portraits/men/44.jpg', bio: 'پسپۆر د تەزکیە و ئەخلاقی دا و خودان دەنگەکێ خوشە ل سلێمانیێ.', phone: '٠٧٧٠٤٤٤٥٥٦٦', social: { facebook: '#', instagram: '#' }, locations: [ { name: 'مزگەفتا گەورە، سلێمانی', coordinates: [35.5562, 45.4343], schedule: 'پشتی نڤێژا ئەینی', lessonTaught: 'پاککرنا دلی (تەزکیە)' } ] } 
            },
            'curriculum': {
                levels: [ { title: 'ئاستێ یەکێ: بنەمایێن سەرەتایی', items: ['matn1', 'matn2'] }, { title: 'ئاستێ دووێ: فقهێ بنەرەت', items: ['matn3'] }, { title: 'ئاستێ سێیێ: پێشکەفتی', items: ['matn4'] } ],
                items: {
                    'matn1': { matnId: 'matn1', title: 'الأصول الثلاثة', pdfUrl: '#', audioUrl: 'https://www.islamweb.net/ar/audio/1/134909.mp3', text: ["بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ.", "اعْلَمْ رَحِمَكَ اللهُ أَنَّهُ يَجِبُ عَلَيْنَا تَعَلّمُ أَرْبَعِ مَسَائِلَ: الأُولَى: الْعِلْمُ: وَهُوَ مَعْرِفَةُ اللهِ، وَمَعْرِفَةُ نَبِيِّهِ، وَمَعْرِفَةُ دِينِ الإِسْلامِ بِالأَدِلَّةِ. الثَّانِيَةُ: الْعَمَلُ بِهِ. الثَّالِثَةُ: الدَّعْوَةُ إِلَيْهِ. الرَّابِعَةُ: الصَّبْرُ عَلَى الأَذَى فِيهِ."], quiz: [{ question: 'ئەرکە ل سەر مە فێربوونا چەند مەسئەلەیان؟', options: ['دوو', 'سێ', 'چار', 'پێنج'], correctAnswer: 2 }, { question: 'مەسئەلا ئێکێ چیە؟', options: ['کردن ب زانینێ', 'زانین', 'بانگەوازیکرن بۆ زانینێ'], correctAnswer: 1 }, { question: 'مەسئەلا دویێ چیە؟', options: ['الصبر علی الأذی فیه', 'الدعوة إلیه', 'العمل به'], correctAnswer: 2 }, { question: 'ئەگەر کەسەک تنێ فێری زانستی بوو و کاری پێ نەکرد، وەک کێ یە؟', options: ['وەک جوهیان', 'وەک گاوران', 'وەک هەردووکان'], correctAnswer: 0 }], explanations: [ { id: 'sharah_ahmad_matn1', teacherId: 'bryar_ahmad', videos: [{ title: 'دەرسـا یەکێ', url: '#' }, { title: 'دەرسـا دووێ', url: '#' }], seriesId: 'gl5' } ] },
                    'matn2': { matnId: 'matn2', title: 'القواعد الأربعة', pdfUrl: '#', text: ["بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ", "أَسْأَلُ اللَّهَ الْكَرِيمَ رَبَّ الْعَرْشِ الْعَظِيمِ أَنْ يَتَوَلاَّكَ فِي الدُّنْيَا وَالآخِرَةِ..."], quiz: [], explanations: [ { id: 'sharah_ismail_matn2', teacherId: 'ismail_zaxo', videos: [{ title: 'پێشەکی', url: '#' }] } ] },
                    'matn3': { matnId: 'matn3', title: 'نواقض الإسلام', pdfUrl: '#', text: ["بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ", "اعلم أن نواقض الإسلام عشرة نواقض..."], quiz: [], explanations: [ { id: 'sharah_ahmad_matn3', teacherId: 'bryar_ahmad', videos: [{ title: 'وانا یەکێ', url: '#' }] }, { id: 'sharah_ali_matn3', teacherId: 'ali_sulaymani', videos: [{ title: 'وانا یەکێ', url: '#' }] } ] },
                    'matn4': { matnId: 'matn4', title: 'شروط لا إله إلا الله', pdfUrl: '#', text: ["العلم، اليقين، القبول...", "الانقياد، الصدق، الإخلاص، المحبة"], quiz: [], explanations: [ { id: 'sharah_kawa_matn4', teacherId: 'kawa_erbil', videos: [{ title: 'دەرسـا یەکێ', url: '#' }] } ] }
                }
            },
            'generalLectures': [ { id: 'gl1', title: 'شلۆڤەکرنا ناڤێن جوان یێن خودێ', teacherId: 'bryar_ahmad', category: 'عەقیدە', image: 'https://picsum.photos/400/225?random=1', videos: [{ title: 'وانا یەکێ: الرحمن', url: '#' }, { title: 'وانا دووێ: الرحيم', url: '#' }, { title: 'وانا سێیێ: الملك', url: '#' }] }, { id: 'gl2', title: 'فقهێ کرین و فرۆتنێ', teacherId: 'ismail_zaxo', category: 'فیقه', image: 'https://picsum.photos/400/225?random=2', videos: [{ title: 'دەستپێک', url: '#' }, { title: 'مەرجێن کرین و فرۆتنێ', url: '#' }] }, { id: 'gl3', title: 'ژیانناما پێغەمبەری ﷺ', teacherId: 'kawa_erbil', category: 'سیرە', image: 'https://picsum.photos/400/225?random=4', videos: [{ title: 'وانا یەکێ', url: '#'}, { title: 'وانا دووێ', url: '#' }] }, { id: 'gl4', title: 'پاککرنا دلی', teacherId: 'ali_sulaymani', category: 'تەزکیە', image: 'https://picsum.photos/400/225?random=5', videos: [{ title: 'وانا یەکێ: ئخلاس', url: '#' }, { title: 'وانا دووێ: تەوبە', url: '#' }, { title: 'وانا سێیێ: زوهد', url: '#' }] }, { id: 'gl5', title: 'گرنگییا فێربوونا تەوحیدی', teacherId: 'bryar_ahmad', category: 'عەقیدە', image: 'https://picsum.photos/400/225?random=6', videos: [{ title: 'وانا یەکێ', url: '#' }] } ],
            'pirtukxane': [ { title: 'الأصول الثلاثة', author: 'محمد بن عبد الوهاب', category: 'عەقیدە', coverImage: 'https://picsum.photos/250/350?random=3', description: 'پەرتوکەکا کورت و پر مفایە دەربارەی وان سێ پرسیارێن د قەبری دا دهێنە کرن.', readUrl: '#read-pdf-1', downloadUrl: '#download-pdf-1' }, { title: 'رياض الصالحين', author: 'الإمام النووي', category: 'حەدیس', coverImage: 'https://picsum.photos/250/350?random=7', description: 'کۆمکرنا فەرموودەیێن پێغەمبەری ﷺ لسەر بابەتاێن جودا جودا.', readUrl: '#read-pdf-2', downloadUrl: '#download-pdf-2' } ],
            'liveCourse': {
                title: "خولـا هەیڤانە: شلۆڤەکرنا پەرتووکا 'عقيدة أهل السنة والجماعة'",
                teacherId: 'bryar_ahmad',
                description: "د ڤێ خولـا ڕاستەوخۆ دا، دێ هەمی هەفتیێ جڤینەکا ئۆنلاین هەبیت بۆ شلۆڤەکرنا بابەتاێن گرنگ یێن بیروباوەرێن ئیسلامی.",
                nextSessionDate: '2024-12-25T20:00:00',
                prerequisites: "پێدڤیە قوتابی ل ئاستێ یەکێ یێ 'ڕێکا زانستی' دەرچوو بیت.",
                topics: [ "ناساندنا بیروباوەرێن ئەهلێ سوننەت", "گرنگیا تەوحیدی و جورێن وی", "شرک و مەترسیێن وێ", "بابەتێن ئیمانێ" ],
                schedule: [ "جڤینا یەکێ: ٢٥ی کانوونا یەکەم، ٢٠٢٤", "جڤینا دووێ: ١ی کانوونا دووەم، ٢٠٢٥", "جڤینا سێیێ: ٨ی کانوونا دووەم، ٢٠٢٥" ]
            }
        };

        // --- GLOBAL VARIABLES ---
        let map = null, mapInitialized = false, teacherMarkers = {};
        const synth = window.speechSynthesis;
        let voices = [], currentAudio = null;
        let currentQuizState = { questions: [], answers: [], currentQuestionIndex: 0, matnId: null };


        // --- INIT & SETUP ---
        window.addEventListener('load', function() {
            setTimeout(() => { document.getElementById('loading-screen').classList.add('fade-out'); }, 1500);
            populateVoices();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoices;
            }
            buildManhajView();
            switchNav(document.querySelector('#main-nav a'), 'manhaj-view');
        });
        
        // --- VIEW MANAGEMENT ---
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('is-active')); const targetView = document.getElementById(viewId); if (targetView) targetView.classList.add('is-active'); window.scrollTo(0, 0); if (viewId === 'teachers-view' && map) setTimeout(() => map.invalidateSize(), 10); }
        function switchNav(element, viewId) { const targetView = document.getElementById(viewId); if (!targetView) return; if (!targetView.dataset.isBuilt) { if (viewId === 'waneyan-view') buildWaneyanView(); else if (viewId === 'pirtukxane-view') buildPirtukxaneView(); else if (viewId === 'teachers-view') buildTeachersView(); else if (viewId === 'live-view') buildLiveView(); targetView.dataset.isBuilt = 'true'; } document.querySelectorAll('#main-nav a').forEach(a => a.classList.remove('active')); if(element) element.classList.add('active'); showView(viewId); if (viewId === 'teachers-view' && !mapInitialized) initializeMap(); }
        function openModal(modalId) { document.getElementById(modalId)?.classList.add('is-visible'); }
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('is-visible');
                if (modalId === 'contribution-modal') {
                    resetContributionModal();
                }
            }
        }

        // --- VIEW BUILDERS ---
        function buildManhajView() { const container = document.getElementById('manhaj-view'); container.innerHTML = `<header class="page-header"><h1>ڕێکا زانستی</h1><p>قۆناغ ب قۆناغ دگەل مە بە</p></header><div id="manhaj-container"></div>`; const accordionContainer = container.querySelector('#manhaj-container'); const completedItems = getCompletedMatn(); allData.curriculum.levels.forEach(level => { const accordion = document.createElement('button'); accordion.className = 'accordion'; accordion.innerHTML = `${level.title} <span class="icon">›</span>`; const panel = document.createElement('div'); panel.className = 'panel'; level.items.forEach(itemId => { const item = allData.curriculum.items[itemId]; if (item) { const isCompleted = completedItems.includes(itemId); panel.innerHTML += `<div class="item-card ${isCompleted ? 'completed' : ''}" onclick="buildReadingView('${itemId}')"><h4>${item.title}</h4></div>`; } }); accordionContainer.appendChild(accordion); accordionContainer.appendChild(panel); accordion.addEventListener("click", function() { this.classList.toggle("active"); this.nextElementSibling.style.maxHeight = this.nextElementSibling.style.maxHeight ? null : this.nextElementSibling.scrollHeight + "px"; }); }); }
        
        function buildReadingView(matnId) {
            const item = allData.curriculum.items[matnId];
            if (!item) return;
            const container = document.getElementById('reading-view');
            
            const quizHtml = (item.quiz && item.quiz.length > 0) ? `
                <div class="quiz-section">
                    <h2 style="text-align:center; margin-bottom: 20px;">خۆ تاقی بکە</h2>
                    <button class="quiz-start-btn" onclick="startQuiz('${matnId}', 'quiz-container')">دەست ب ئیمتیحانێ بکە</button>
                    <div id="quiz-container"></div>
                </div>` : '';

            container.innerHTML = `
                <button class="back-btn" onclick="switchNav(document.querySelector('#main-nav a'), 'manhaj-view')">‹ ڤەگەڕە</button>
                <div class="reading-layout">
                    <div class="sharah-wrapper">
                        <div class="sharah-header"><h2>شلۆڤەکرن: ${item.title}</h2></div>
                        <div class="teacher-tabs" id="teacher-tabs-container">
                            ${item.explanations.map((exp, index) => {
                                const teacher = allData.teachers[exp.teacherId];
                                return `<div class="teacher-tab ${index === 0 ? 'active' : ''}" onclick="showExplanation(this, '${exp.id}')"><a href="#" onclick="event.preventDefault(); showTeacherProfile('${exp.teacherId}')">${teacher?.name || 'نەناسراو'}</a></div>`;
                            }).join('')}
                        </div>
                        <div id="explanation-content-wrapper"></div>
                    </div>
                    <div class="sharah-wrapper">
                        <div class="sharah-header">
                            <h2>مەتن: ${item.title}</h2>
                            <div class="matn-tools">
                                <button class="matn-tool-btn" onclick="handleAudio('${matnId}', this)" aria-label="گوھداری کردن"><i class="fas fa-play"></i></button>
                                <a href="${item.pdfUrl}" target="_blank" class="matn-tool-btn" aria-label="داگرتنا PDF"><i class="fas fa-file-pdf"></i></a>
                            </div>
                        </div>
                        <div id="matn-content-container">${item.text.map(p => `<p>${p}</p>`).join('')}</div>
                        ${quizHtml}
                    </div>
                </div>`;
            showView('reading-view');
            if (item.explanations.length > 0) {
                showExplanation(document.querySelector('.teacher-tab'), item.explanations[0].id);
            }
        }

        function showExplanation(element, explanationId) { let explanation = null; Object.values(allData.curriculum.items).forEach(item => { const found = item.explanations.find(exp => exp.id === explanationId); if (found) explanation = found; }); if (!explanation) return; document.querySelectorAll('.teacher-tab').forEach(tab => tab.classList.remove('active')); element.closest('.teacher-tab').classList.add('active'); const wrapper = document.getElementById('explanation-content-wrapper'); let seriesButtonHTML = ''; if (explanation.seriesId && allData.generalLectures.find(l => l.id === explanation.seriesId)) { seriesButtonHTML = `<button class="card-btn-small" style="margin: 20px auto; display: block;" onclick="showLessonList('${explanation.seriesId}')">هەمی وانەیێن ڤێ زنجیرێ ببینە</button>`; } wrapper.innerHTML = `<div id="explanation-content">${explanation.videos.map(video => `<div class="lesson-item"><span>${video.title}</span><button class="watch-btn" onclick="window.open('${video.url}','_blank')">تەماشەکرن</button></div>`).join('')}</div>${seriesButtonHTML}`; }
        function buildWaneyanView() { const container = document.getElementById('waneyan-view'); container.innerHTML = `<header class="page-header"><h1>وانەیێن گشتی</h1><p>وانە و زنجیرەیێن جودا جودا</p></header><div class="filters-container" id="waneyan-filters"></div><div class="waneyan-grid" id="waneyan-grid"></div>`; const categories = ['all', ...new Set(allData.generalLectures.map(l => l.category))]; const teachers = ['all', ...new Set(allData.generalLectures.map(l => l.teacherId))]; document.getElementById('waneyan-filters').innerHTML = `<div class="filter-group"><h4>بابەت:</h4>${categories.map(cat => `<button class="filter-btn ${cat === 'all' ? 'active' : ''}" data-filter-type="category" data-filter-value="${cat}">${cat === 'all' ? 'هەمووی' : cat}</button>`).join('')}</div><div class="filter-group"><h4>مامۆستا:</h4>${teachers.map(tId => `<button class="filter-btn ${tId === 'all' ? 'active' : ''}" data-filter-type="teacher" data-filter-value="${tId}">${tId === 'all' ? 'هەمووی' : allData.teachers[tId]?.name}</button>`).join('')}</div>`; document.querySelectorAll('#waneyan-filters .filter-btn').forEach(btn => btn.addEventListener('click', function() { const { filterType } = this.dataset; document.querySelectorAll(`#waneyan-filters .filter-btn[data-filter-type="${filterType}"]`).forEach(b => b.classList.remove('active')); this.classList.add('active'); filterLectures(); })); filterLectures(); }
        function filterLectures() { const activeCategory = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="category"].active').dataset.filterValue; const activeTeacher = document.querySelector('#waneyan-filters .filter-btn[data-filter-type="teacher"].active').dataset.filterValue; const grid = document.getElementById('waneyan-grid'); const filteredLectures = allData.generalLectures.filter(l => (activeCategory === 'all' || l.category === activeCategory) && (activeTeacher === 'all' || l.teacherId === activeTeacher)); grid.innerHTML = filteredLectures.length ? filteredLectures.map(lecture => { const teacher = allData.teachers[lecture.teacherId]; return `<div class="wana-card"><img src="${lecture.image}" class="wana-card-img"><div class="wana-card-content"><h3>${lecture.title}</h3><p><strong>مامۆستا:</strong> <a href="#" onclick="event.preventDefault(); showTeacherProfile('${lecture.teacherId}')">${teacher?.name || 'نەناسراو'}</a></p><p><strong>بابەت:</strong> ${lecture.category}</p><div class="card-btn-group"><button class="card-btn-small" onclick="showLessonList('${lecture.id}')">لیستی وانەکان</button><button class="card-btn-small secondary" onclick="showTeacherProfile('${lecture.teacherId}')">پرۆفایل</button></div></div></div>`; }).join('') : '<p style="text-align:center; grid-column: 1 / -1;">هیچ وانەیەک لسەر ڤان فیلتەران نەهاتە دیتن.</p>'; }
        function buildPirtukxaneView() { const container = document.getElementById('pirtukxane-view'); container.innerHTML = `<header class="page-header"><h1>پەرتوکخانە</h1><p>کۆمەڵێک پەرتوکی پێشنیارکراو</p></header><div class="pirtuk-grid" id="pirtuk-grid">${allData.pirtukxane.map(book => `<div class="pirtuk-card"><img src="${book.coverImage}" class="pirtuk-card-img"><div class="pirtuk-card-content"><h3>${book.title}</h3><p><strong>نووسەر:</strong> ${book.author}</p><p>${book.description}</p><div class="card-btn-group"><button class="card-btn-small" onclick="window.open('${book.readUrl}','_blank')">خواندن</button><button class="card-btn-small secondary" onclick="window.open('${book.downloadUrl}','_blank')">داگرتن</button></div></div></div>`).join('')}</div>`; }
        function buildTeachersView() { const container = document.getElementById('teachers-view'); container.innerHTML = `<header class="page-header"><h1>مامۆستا و جهـ</h1><p>جهێ مامۆستایان و وانەیان لسەر خەریتەی ببینە</p></header><div id="teacher-stories-bar">${Object.entries(allData.teachers).map(([id, t]) => `<div class="teacher-story"><div class="story-avatar-wrapper" onclick="showTeacherProfile('${id}')"><div class="story-avatar"><img src="${t.profileImage}"></div></div><a href="#" class="story-profile-link" onclick="event.preventDefault(); showTeacherProfile('${id}')">${t.name}</a></div>`).join('')}</div><div id="map-container"></div>`; }
        function initializeMap() { if (mapInitialized) return; map = L.map('map-container').setView([36.5, 43.0], 8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map); Object.entries(allData.teachers).forEach(([teacherId, teacher]) => { teacher.locations.forEach((location, index) => { const markerId = `${teacherId}_${index}`; const marker = L.marker(location.coordinates).addTo(map); marker.bindPopup(`<div style="text-align:center;font-family:var(--font-kurdish);"><img src="${teacher.profileImage}" style="width:50px;height:50px;border-radius:50%;margin-bottom:10px;"><h4 style="margin:0;font-size:1rem;">${teacher.name}</h4><p style="margin:5px 0;"><strong>${location.name}</strong></p><p style="margin:5px 0;font-size:0.9rem;"><strong>وانە:</strong> ${location.lessonTaught || 'نادیار'}</p><p style="margin:5px 0;font-size:0.9rem;"><strong>کەنگی:</strong> ${location.schedule}</p><button onclick="showTeacherProfile('${teacherId}')" style="background:var(--accent-color);color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-family:var(--font-kurdish);">پرۆفایل</button></div>`); teacherMarkers[markerId] = marker; }); }); mapInitialized = true; }
        
        function buildLiveView() {
            const container = document.getElementById('live-view');
            const course = allData.liveCourse;
            const teacher = allData.teachers[course.teacherId];
            container.innerHTML = `
                <div class="live-view-content">
                    <span class="live-badge">ڕاستەوخۆ</span>
                    <h1>${course.title}</h1>
                    <p class="live-teacher-info">دگەل: <a href="#" onclick="event.preventDefault(); showTeacherProfile('${course.teacherId}')">${teacher.name}</a></p>
                    <p style="max-width: 700px; margin: 0 auto 30px;">${course.description}</p>
                    <h3 style="margin-bottom: 10px;">جڤینا بهێت دێ دەستپێکەت پشتی:</h3>
                    <div id="live-countdown"></div>
                    
                    <div class="live-details-section">
                        <h3 class="profile-section-title">زانیاریێن زێدەتر لسەر خولێ</h3>
                        <h4><i class="fas fa-bullseye" style="color:var(--accent-color); margin-left: 8px;"></i>بابەتێن دێ هێنە بەحسکرن:</h4>
                        <ul style="margin-bottom: 20px;">${course.topics.map(t => `<li>${t}</li>`).join('')}</ul>
                        
                        <h4><i class="fas fa-tasks" style="color:var(--accent-color); margin-left: 8px;"></i>پێدڤیێن خولێ:</h4>
                        <p style="margin-bottom: 20px;">${course.prerequisites}</p>
                        
                        <h4><i class="fas fa-calendar-alt" style="color:var(--accent-color); margin-left: 8px;"></i>خشتێ جڤینان:</h4>
                        <ul>${course.schedule.map(s => `<li>${s}</li>`).join('')}</ul>
                    </div>

                    <div id="live-registration-section">
                         <h2 class="profile-section-title" style="text-align:center; border-bottom-width:2px; max-width:400px; margin: 40px auto 20px auto;">فورما پشکداریێ</h2>
                         <p style="color: var(--secondary-text); max-width: 600px; margin: 0 auto 20px;">ئەگەر تۆ حەزدکەی پشکداریێ د ڤێ خولێ دا بکەی، هیڤیدارین ڤێ فورمێ پر بکە.</p>
                         <form action="https://formspree.io/f/mvgqdwav" method="POST" class="live-registration-form">
                            <input type="hidden" name="_subject" value="داواکاریەکا نووی بۆ خولا راستەوخۆ!">
                            <div class="form-group">
                                <label for="fullname">ناڤێ سیانی:</label>
                                <input type="text" id="fullname" name="ناڤ" required>
                            </div>
                            <div class="form-group">
                                <label for="email">ئیمێل:</label>
                                <input type="email" id="email" name="ئیمێل" required>
                            </div>
                             <div class="form-group">
                                <label for="reason">بۆچی دێ حەزکەی پشکداریێ د ڤێ خولێ دا بکەی؟</label>
                                <textarea id="reason" name="ئەگەر" required></textarea>
                            </div>
                            <div class="form-group form-group-checkbox">
                               <input type="checkbox" id="prereq" name="مەرج قەبیلکرن" value="بەلێ" required>
                               <label for="prereq">ئەز پشتراستم کو من مەرجێن پێدڤی بۆ ڤێ خولێ هەنە</label>
                           </div>
                           <button type="submit" class="form-submit-btn">هنارتن</button>
                         </form>
                    </div>
                </div>
            `;
            startCountdown(course.nextSessionDate);
        }

        // --- HANDLERS & OTHER FUNCTIONS ---
        function showLessonList(lectureId) { const lecture = allData.generalLectures.find(l => l.id === lectureId); if (!lecture) return; openModal('lesson-list-modal'); document.getElementById('lesson-list-title').textContent = lecture.title; document.getElementById('lesson-list-container').innerHTML = lecture.videos.map(video => `<div class="lesson-item clickable" onclick="window.open('${video.url}','_blank')"><span>${video.title}</span><button class="watch-btn">تەماشەکرن</button></div>`).join(''); }
        function showTeacherProfile(teacherId) { const teacher = allData.teachers[teacherId]; if (!teacher) return; openModal('teacher-profile-modal'); document.getElementById('profile-header-img').src = teacher.profileImage; document.getElementById('profile-header-name').textContent = teacher.name; document.getElementById('profile-header-bio').textContent = teacher.bio; document.getElementById('contact-info-container').innerHTML = `<a href="tel:${teacher.phone}"><i class="fas fa-phone"></i> ${teacher.phone}</a> ${Object.entries(teacher.social).map(([p,u])=>`<a href="${u}" target="_blank"><i class="fab fa-${p.toLowerCase()}"></i> ${p}</a>`).join('')}`; document.getElementById('profile-locations-container').innerHTML = teacher.locations.map((loc, index) => { const markerId = `${teacherId}_${index}`; return `<div class="location-item"><p><strong><i class="fas fa-map-marker-alt" style="margin-left: 8px; color: var(--accent-color);"></i>جهـ:</strong> ${loc.name}</p><p><strong><i class="fas fa-book-open" style="margin-left: 8px; color: var(--accent-color);"></i>وانا لێ دهێتە گۆتن:</strong> ${loc.lessonTaught || 'نەهاتیە دیارکرن'}</p><p><strong><i class="fas fa-clock" style="margin-left: 8px; color: var(--accent-color);"></i>کەنگی:</strong> ${loc.schedule}</p><a href="#" onclick="event.preventDefault(); closeModal('teacher-profile-modal'); switchNav(document.querySelector('#main-nav a[onclick*=\\'teachers-view\\']'), 'teachers-view'); setTimeout(() => { if(map) { map.setView([${loc.coordinates}], 15); if(teacherMarkers['${markerId}']) { teacherMarkers['${markerId}'].openPopup(); } } }, 500);">لەسەر نەخشە ببینە</a></div>` }).join('') || '<p>هیچ جهەکێ وانەگۆتنێ بۆ ڤی مامۆستای نەهاتیە تۆمارکرن.</p>'; const lessonsContainer = document.getElementById('profile-lessons-container'); const teacherLectures = allData.generalLectures.filter(l => l.teacherId === teacherId); const teacherExplanations = []; Object.values(allData.curriculum.items).forEach(item => { item.explanations.forEach(exp => { if (exp.teacherId === teacherId) teacherExplanations.push({title: item.title, matnId: item.matnId, explanation: exp}); }); }); lessonsContainer.innerHTML = `${teacherLectures.map(l => `<div class="lesson-item clickable" onclick="closeModal('teacher-profile-modal');showLessonList('${l.id}')"><span>${l.title}</span><button class="watch-btn">وانەکان</button></div>`).join('')}${teacherExplanations.map(i => `<div class="lesson-item clickable" onclick="closeModal('teacher-profile-modal');buildReadingView('${i.matnId}')"><span>شلۆڤەکرنی ${i.title}</span><button class="watch-btn">${i.explanation.videos.length} وانە</button></div>`).join('')}`; }
        
        // --- FEATURE FUNCTIONS ---
        function populateVoices() { voices = synth.getVoices().filter(voice => voice.lang.startsWith('ar')); }
        function handleAudio(matnId, buttonElement) {
            const item = allData.curriculum.items[matnId];
            const icon = buttonElement.querySelector('i');
            if(synth.speaking) synth.cancel();
            if (item.audioUrl) {
                if (currentAudio && !currentAudio.paused) { currentAudio.pause(); return; }
                if(currentAudio && currentAudio.src === item.audioUrl) { currentAudio.play(); return; }
                currentAudio = new Audio(item.audioUrl);
                currentAudio.onplay = () => icon.className = 'fas fa-pause';
                currentAudio.onpause = () => icon.className = 'fas fa-play';
                currentAudio.onended = () => icon.className = 'fas fa-play';
                currentAudio.play();
            } else { 
                if (!item || !synth) return;
                const textToSpeak = item.text.join(' ');
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                const arabicVoice = voices[0];
                if(arabicVoice) utterance.voice = arabicVoice;
                utterance.lang = 'ar-SA';
                utterance.rate = 0.9;
                utterance.onstart = () => { icon.className = 'fas fa-pause'; };
                utterance.onend = () => { icon.className = 'fas fa-play'; };
                synth.speak(utterance);
            }
        }
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        // --- ADVANCED QUIZ LOGIC ---
        function startQuiz(matnId, containerId) {
            const item = allData.curriculum.items[matnId];
            const container = document.getElementById(containerId);
            if (!item || !item.quiz || item.quiz.length === 0) { container.innerHTML = '<p>ئیمتیحان بۆ ڤی بەشی بەردەست نینە.</p>'; return; }
            document.querySelector('.quiz-start-btn').style.display = 'none';
            currentQuizState = { questions: shuffleArray(item.quiz.map((q, i) => ({ ...q, originalIndex: i }))), answers: [], currentQuestionIndex: 0, matnId: matnId };
            let quizHTML = `<div class="quiz-progress-bar-container"><div class="quiz-progress-bar"></div></div>`;
            currentQuizState.questions.forEach((q, index) => {
                quizHTML += `<div class="quiz-question-card" id="question-card-${index}"><p>پرسیارا ${index + 1} ژ ${currentQuizState.questions.length}: ${q.question}</p><div class="quiz-options">${q.options.map((opt, optIndex) => `<label onclick="handleQuizAnswer(${index}, ${optIndex})"><input type="radio" name="q${index}" value="${optIndex}" style="display: none;">${opt}</label>`).join('')}</div></div>`;
            });
            quizHTML += `<div id="quiz-result-container"></div>`;
            container.innerHTML = quizHTML;
            showQuizQuestion(0);
        }
        function showQuizQuestion(index) {
            document.querySelectorAll('.quiz-question-card').forEach(card => card.classList.remove('active'));
            const activeCard = document.getElementById(`question-card-${index}`);
            if(activeCard) activeCard.classList.add('active');
            document.querySelector('.quiz-progress-bar').style.width = `${((index) / currentQuizState.questions.length) * 100}%`;
        }
        function handleQuizAnswer(questionIndex, answerIndex) {
            const question = currentQuizState.questions[questionIndex];
            const questionCard = document.getElementById(`question-card-${questionIndex}`);
            const labels = questionCard.querySelectorAll('.quiz-options label');
            labels.forEach(l => l.style.pointerEvents = 'none');
            currentQuizState.answers[questionIndex] = answerIndex;
            if (answerIndex === question.correctAnswer) { labels[answerIndex].classList.add('correct'); } else { labels[answerIndex].classList.add('incorrect'); labels[question.correctAnswer].classList.add('correct'); }
            setTimeout(() => { if (currentQuizState.currentQuestionIndex < currentQuizState.questions.length - 1) { currentQuizState.currentQuestionIndex++; showQuizQuestion(currentQuizState.currentQuestionIndex); } else { showQuizResults(); } }, 1500);
        }
        function showQuizResults() {
            document.querySelector('.quiz-progress-bar').style.width = `100%`;
            document.querySelectorAll('.quiz-question-card').forEach(card => card.classList.remove('active'));
            let score = 0;
            currentQuizState.questions.forEach((q, index) => { if (currentQuizState.answers[index] === q.correctAnswer) { score++; } });
            const didPass = (score / currentQuizState.questions.length) >= 0.7;
            if (didPass) { setCompletedMatn(currentQuizState.matnId); buildManhajView(); }
            const resultContainer = document.getElementById('quiz-result-container');
            resultContainer.innerHTML = `<div class="quiz-results-card"><div class="result-icon ${didPass ? 'pass' : 'fail'}"><i class="fas ${didPass ? 'fa-check-circle' : 'fa-times-circle'}"></i></div><h3>${didPass ? 'پیرۆزە! تۆ دەرچووی.' : 'هەولەکا باش بوو!'}</h3><p>تە ${score} ژ ${currentQuizState.questions.length} پرسیاران راست بەرسڤدان.</p><p style="color: ${didPass ? 'var(--success-color)' : 'var(--danger-color)'}; margin-top:10px; font-weight: bold;">${didPass ? 'تۆ نها دشێی بچیە ئاستێ داهاتوو.' : 'هیڤیدارین جارەکا دی هەول بدەی بۆ دەرچوونێ.'}</p><button class="quiz-start-btn" style="display: inline-block; margin-top: 20px;" onclick="startQuiz('${currentQuizState.matnId}', 'quiz-container')">دووبارە تاقیکرنەوە</button></div>`;
        }
        function getCompletedMatn() { return JSON.parse(localStorage.getItem('completedMatn') || '[]'); }
        function setCompletedMatn(matnId) {
            let completed = getCompletedMatn();
            if (!completed.includes(matnId)) { completed.push(matnId); localStorage.setItem('completedMatn', JSON.stringify(completed)); }
        }
        function startCountdown(targetDateStr) {
            const countdownContainer = document.getElementById('live-countdown');
            if(!countdownContainer) return;
            const targetDate = new Date(targetDateStr).getTime();
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                if (distance < 0) { clearInterval(interval); countdownContainer.innerHTML = "<h3>خول دەستپێکریە یان ب دوماهیک هاتیە!</h3>"; return; }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                countdownContainer.innerHTML = `<div class="countdown-box"><div class="number">${days}</div><div class="label">ڕۆژ</div></div><div class="countdown-box"><div class="number">${hours}</div><div class="label">دەمژمێر</div></div><div class="countdown-box"><div class="number">${minutes}</div><div class="label">خولەک</div></div><div class="countdown-box"><div class="number">${seconds}</div><div class="label">چرکە</div></div>`;
            }, 1000);
        }

        // --- Contribution Modal Logic ---
        function showContributionFields(type) {
            document.getElementById('contribution-form').style.display = 'block';
            const typeInput = document.getElementById('contribution_type_input');
            const typeButtons = document.querySelectorAll('.contribution-type-btn');
            
            if(type === 'teacher') typeInput.value = 'پێشنیارا مامۆستای';
            else if (type === 'lesson') typeInput.value = 'پێشنیارا وانەیێ';
            else if (type === 'book') typeInput.value = 'پێشنیارا پەرتووکێ';

            document.querySelectorAll('.form-fields-group').forEach(group => group.style.display = 'none');
            document.getElementById(`${type}-fields`).style.display = 'block';

            typeButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.contribution-type-btn[onclick="showContributionFields('${type}')"]`).classList.add('active');
        }

        function resetContributionModal() {
            const form = document.getElementById('contribution-form');
            form.style.display = 'none';
            form.reset(); 
            document.querySelectorAll('.form-fields-group').forEach(group => group.style.display = 'none');
            document.querySelectorAll('.contribution-type-btn').forEach(btn => btn.classList.remove('active'));
        }

    </script>
</body>
</html>
