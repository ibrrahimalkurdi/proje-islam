<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پەڕا ئەدمین - پڕۆژێ ئیسلام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap');
        :root {
            --dark-bg: #0d1117; --card-bg: #161b22; --primary-text: #c9d1d9; --secondary-text: #8b949e;
            --accent-color: #58a6ff; --border-color: #30363d; --success-color: #2ea043; --danger-color: #f85149;
            --font-kurdish: 'Noto Sans Arabic', sans-serif;
        }
        body { font-family: var(--font-kurdish); background-color: var(--dark-bg); color: var(--primary-text); line-height: 1.6; margin: 0; padding: 20px; }
        #admin-panel { display: none; }
        .container { width: 95%; max-width: 1400px; margin: auto; background-color: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); }
        h1, h2, h3 { color: var(--primary-text); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 20px; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background: none; border: none; color: var(--secondary-text); padding: 10px 15px; cursor: pointer; font-family: var(--font-kurdish); font-size: 1rem; border-bottom: 3px solid transparent; }
        .tab-button:hover { color: var(--primary-text); }
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Form Styles */
        .form-section { background-color: var(--dark-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; background: #1c222c; border: 1px solid var(--border-color); color: var(--primary-text);
            padding: 10px; border-radius: 6px; font-family: var(--font-kurdish); box-sizing: border-box;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input[type="checkbox"] { width: auto; margin-left: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-family: var(--font-kurdish); font-weight: bold; transition: opacity 0.3s; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-text); color: var(--dark-bg); }
        .btn:hover { opacity: 0.85; }
        
        /* Table Styles */
        .item-list { width: 100%; border-collapse: collapse; }
        .item-list th, .item-list td { padding: 12px; border: 1px solid var(--border-color); text-align: right; }
        .item-list th { background-color: var(--dark-bg); }
        .item-list img { max-width: 60px; height: auto; border-radius: 4px; }
        .actions { display: flex; gap: 10px; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color); width: 80%; max-width: 700px; border-radius: 10px; position: relative; }
        .close-btn { color: var(--secondary-text); position: absolute; top: 10px; left: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }

        /* Nested items for Levels */
        .nested-item-container { background: #1c222c; padding: 15px; margin-top: 10px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="text-align:center;">چوونەژوور بۆ پەڕا ئەدمین</h1>
    </div>

    <div id="admin-panel">
        <div class="container">
            <h1><i class="fas fa-cogs"></i> پەڕا کۆنترۆلکرنێ (ئەدمین)</h1>
            
            <div class="tabs">
                <button class="tab-button active" onclick="openTab('teachers')">مامۆستایان</button>
                <button class="tab-button" onclick="openTab('levels')">رێرەوا فێربوونێ</button>
                <button class="tab-button" onclick="openTab('generalLectures')">وانەیێن گشتی</button>
                <button class="tab-button" onclick="openTab('hadiths')">حەدیسان</button>
                <button class="tab-button" onclick="openTab('fatwas')">پرسیار و بەرسڤ</button>
                <button class="tab-button" onclick="openTab('books')">پەرتوکخانە</button>
                <button class="tab-button" onclick="openTab('bookSales')">فرۆتنا پەرتووکان</button>
                <button class="tab-button" onclick="openTab('locations')">خەریتە</button>
                <button class="tab-button" onclick="openTab('adhkar')">دوعا و زکر</button>
                <button class="tab-button" onclick="openTab('liveCourse')">خولێن ڕاستەوخۆ</button>
                <button class="tab-button" onclick="openTab('viewStatus')">کۆنترۆلا بەشان</button>
            </div>

            <!-- Tab Content: Teachers -->
            <div id="teachers-content" class="tab-content active">
                <h2><i class="fas fa-chalkboard-teacher"></i> کۆنترۆلا مامۆستایان</h2>
                <button class="btn btn-primary" onclick="showForm('teacher-form')"><i class="fas fa-plus"></i> مامۆستایەکێ نوو زێدەبکە</button>
                <div id="teacher-form" class="form-section" style="display:none;">
                    <h3 id="teacher-form-title">مامۆستایەکێ نوو</h3>
                    <form onsubmit="event.preventDefault(); saveTeacher()">
                        <input type="hidden" id="teacher-id">
                        <div class="form-group"><label for="teacher-name">ناڤ</label><input type="text" id="teacher-name" required></div>
                        <div class="form-group"><label for="teacher-bio">کورتەیەک لسەر ژیانێ</label><textarea id="teacher-bio"></textarea></div>
                        <div class="form-group"><label for="teacher-image">لێنکا وێنەی</label><input type="text" id="teacher-image"></div>
                        <div class="form-group"><label for="teacher-phone">ژمارا تەلەفونێ</label><input type="text" id="teacher-phone"></div>
                        <div class="form-group"><label for="teacher-telegram">لێنکا تێلەگرامی</label><input type="text" id="teacher-telegram"></div>
                        <div class="form-group"><label for="teacher-youtube">لێنکا یوتیوبی</label><input type="text" id="teacher-youtube"></div>
                        <div class="form-group"><label for="teacher-facebook">لێنکا فەیسبوکی</label><input type="text" id="teacher-facebook"></div>
                        <div class="form-group"><label for="teacher-order">رێزبەندی</label><input type="number" id="teacher-order" value="0"></div>
                        <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                    </form>
                </div>
                <table class="item-list" id="teachers-list"></table>
            </div>

            <!-- Tab Content: Levels -->
            <div id="levels-content" class="tab-content">
                <h2><i class="fas fa-stairs"></i> کۆنترۆلا رێرەوا فێربوونێ</h2>
                <button class="btn btn-primary" onclick="showForm('level-form')"><i class="fas fa-plus"></i> ئاستەکێ نوو زێدەبکە</button>
                <div id="level-form" class="form-section" style="display:none;">
                    <h3 id="level-form-title">ئاستەکێ نوو</h3>
                    <form onsubmit="event.preventDefault(); saveLevel()">
                        <input type="hidden" id="level-id">
                        <div class="form-group"><label for="level-name">ناڤێ ئاستی</label><input type="text" id="level-name" required></div>
                        <div class="form-group"><label for="level-number">ژمارا ئاستی (بۆ رێزبەندیێ)</label><input type="number" id="level-number" required></div>
                        <div class="form-group"><label for="level-unlock-code">کۆدا ڤەکرنێ (ئارەزوومەندانە)</label><input type="text" id="level-unlock-code"></div>
                        <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                    </form>
                </div>
                <table class="item-list" id="levels-list"></table>
            </div>

            <!-- ... Other Tab Contents will be here ... -->
             <!-- Tab Content: General Lectures -->
            <div id="generalLectures-content" class="tab-content">
                 <h2><i class="fas fa-video"></i> کۆنترۆلا وانەیێن گشتی</h2>
                <button class="btn btn-primary" onclick="showForm('lecture-form')"><i class="fas fa-plus"></i> وانەیەکا نوو زێدەبکە</button>
                <div id="lecture-form" class="form-section" style="display:none;">
                    <h3 id="lecture-form-title">وانەیەکا نوو</h3>
                    <form onsubmit="event.preventDefault(); saveLecture()">
                        <input type="hidden" id="lecture-id">
                        <div class="form-group"><label for="lecture-title">ناڤێ وانەیێ</label><input type="text" id="lecture-title" required></div>
                        <div class="form-group"><label for="lecture-category">بابەت (پۆلێن)</label><input type="text" id="lecture-category"></div>
                        <div class="form-group"><label for="lecture-teacher">مامۆستا</label><select id="lecture-teacher" required></select></div>
                        <div class="form-group"><label for="lecture-image">لێنکا وێنەی</label><input type="text" id="lecture-image"></div>
                        <div class="form-group"><label for="lecture-pdf">لێنکا PDF (ئارەزوومەندانە)</label><input type="text" id="lecture-pdf"></div>
                        <div class="form-group"><label>لیستا ڤیدیویان</label><div id="lecture-videos-container"></div><button type="button" class="btn btn-secondary" onclick="addVideoField('lecture-videos-container')">ڤیدیویەکێ زێدەبکە</button></div>
                        <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                    </form>
                </div>
                 <table class="item-list" id="lectures-list"></table>
            </div>

            <!-- Tab Content: Hadiths -->
            <div id="hadiths-content" class="tab-content">
                 <h2><i class="fas fa-book-quran"></i> کۆنترۆلا حەدیسان</h2>
                 <button class="btn btn-primary" onclick="showForm('hadith-form')"><i class="fas fa-plus"></i> حەدیسەکا نوو زێدەبکە</button>
                 <div id="hadith-form" class="form-section" style="display:none;">
                     <h3 id="hadith-form-title">حەدیسەکا نوو</h3>
                     <form onsubmit="event.preventDefault(); saveHadith()">
                         <input type="hidden" id="hadith-id">
                         <div class="form-group"><label for="hadith-text">دەقێ حەدیسێ</label><textarea id="hadith-text" required></textarea></div>
                         <div class="form-group"><label for="hadith-number">ژمارا حەدیسێ</label><input type="text" id="hadith-number"></div>
                         <div class="form-group"><label for="hadith-narrator">راوی</label><input type="text" id="hadith-narrator"></div>
                         <div class="form-group"><label for="hadith-source">ژێدەر</label><input type="text" id="hadith-source"></div>
                         <div class="form-group"><label for="hadith-category">بابەت</label><input type="text" id="hadith-category"></div>
                         <div class="form-group"><label for="hadith-grade">پلە (صحيح، حسن، ضعيف)</label><input type="text" id="hadith-grade"></div>
                         <div class="form-group"><label for="hadith-audio">لێنکا دەنگی (ئارەزوومەندانە)</label><input type="text" id="hadith-audio"></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="hadiths-list"></table>
            </div>
            
             <!-- Tab Content: Fatwas -->
            <div id="fatwas-content" class="tab-content">
                 <h2><i class="fas fa-question-circle"></i> کۆنترۆلا پرسیار و بەرسڤان</h2>
                 <button class="btn btn-primary" onclick="showForm('fatwa-form')"><i class="fas fa-plus"></i> پرسیارەکا نوو زێدەبکە</button>
                 <div id="fatwa-form" class="form-section" style="display:none;">
                     <h3 id="fatwa-form-title">پرسیارەکا نوو</h3>
                     <form onsubmit="event.preventDefault(); saveFatwa()">
                         <input type="hidden" id="fatwa-id">
                         <div class="form-group"><label for="fatwa-question">پرسیار</label><textarea id="fatwa-question" required></textarea></div>
                         <div class="form-group"><label for="fatwa-answer">بەرسڤ</label><textarea id="fatwa-answer" required></textarea></div>
                         <div class="form-group"><label for="fatwa-teacher">مامۆستایێ بەرسڤدەر</label><select id="fatwa-teacher" required></select></div>
                         <div class="form-group"><label for="fatwa-audio">لێنکا دەنگی (ئارەزوومەندانە)</label><input type="text" id="fatwa-audio"></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="fatwas-list"></table>
            </div>

            <!-- Tab Content: Books (Library) -->
            <div id="books-content" class="tab-content">
                <h2><i class="fas fa-swatchbook"></i> کۆنترۆلا پەرتوکخانێ</h2>
                 <button class="btn btn-primary" onclick="showForm('book-form')"><i class="fas fa-plus"></i> پەرتوکەکا نوو زێدەبکە</button>
                 <div id="book-form" class="form-section" style="display:none;">
                     <h3 id="book-form-title">پەرتوکەکا نوو</h3>
                     <form onsubmit="event.preventDefault(); saveBook()">
                         <input type="hidden" id="book-id">
                         <div class="form-group"><label for="book-title">ناڤێ پەرتوکێ</label><input type="text" id="book-title" required></div>
                         <div class="form-group"><label for="book-author">نڤیسەر</label><input type="text" id="book-author"></div>
                         <div class="form-group"><label for="book-cover">لێنکا وێنەیێ بەرگی</label><input type="text" id="book-cover"></div>
                         <div class="form-group"><label for="book-read-url">لێنکا خواندنێ (PDF)</label><input type="text" id="book-read-url" required></div>
                         <div class="form-group"><label for="book-download-url">لێنکا داگرتنێ (PDF)</label><input type="text" id="book-download-url" required></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="books-list"></table>
            </div>

            <!-- Tab Content: Book Sales -->
            <div id="bookSales-content" class="tab-content">
                <h2><i class="fas fa-shopping-cart"></i> کۆنترۆلا فرۆتنا پەرتووکان</h2>
                 <button class="btn btn-primary" onclick="showForm('bookSale-form')"><i class="fas fa-plus"></i> پەرتوکەکا نوو بۆ فرۆتنێ زێدەبکە</button>
                 <div id="bookSale-form" class="form-section" style="display:none;">
                     <h3 id="bookSale-form-title">پەرتوکەکا نوو بۆ فرۆتنێ</h3>
                     <form onsubmit="event.preventDefault(); saveBookSale()">
                         <input type="hidden" id="bookSale-id">
                         <div class="form-group"><label for="bookSale-title">ناڤێ پەرتوکێ</label><input type="text" id="bookSale-title" required></div>
                         <div class="form-group"><label for="bookSale-author">نڤیسەر</label><input type="text" id="bookSale-author"></div>
                         <div class="form-group"><label for="bookSale-desc">کورتە</label><textarea id="bookSale-desc"></textarea></div>
                         <div class="form-group"><label for="bookSale-cover">لێنکا وێنەیێ بەرگی</label><input type="text" id="bookSale-cover"></div>
                         <div class="form-group"><label for="bookSale-price">بها (بۆ نموونە: 5,000 IQD)</label><input type="text" id="bookSale-price"></div>
                         <div class="form-group"><label for="bookSale-link">لێنکا کرینێ</label><input type="text" id="bookSale-link"></div>
                         <div class="form-group"><label for="bookSale-available">بەردەستە؟</label><input type="checkbox" id="bookSale-available" checked></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="bookSales-list"></table>
            </div>
            
            <!-- Tab Content: Map Locations -->
            <div id="locations-content" class="tab-content">
                <h2><i class="fas fa-map-marked-alt"></i> کۆنترۆلا خەریتەی</h2>
                 <button class="btn btn-primary" onclick="showForm('location-form')"><i class="fas fa-plus"></i> جهەکێ نوو زێدەبکە</button>
                 <div id="location-form" class="form-section" style="display:none;">
                     <h3 id="location-form-title">جهەکێ نوو</h3>
                     <form onsubmit="event.preventDefault(); saveLocation()">
                         <input type="hidden" id="location-id">
                         <div class="form-group"><label for="location-name">ناڤێ جهی</label><input type="text" id="location-name" required></div>
                         <div class="form-group"><label for="location-lesson">وانا لێ دهێتە گوتن</label><input type="text" id="location-lesson"></div>
                         <div class="form-group"><label for="location-teacher">مامۆستا</label><select id="location-teacher" required></select></div>
                         <div class="form-group"><label for="location-schedule">دە raspored</label><input type="text" id="location-schedule"></div>
                         <div class="form-group"><label for="location-lat">Coordinates (Latitude)</label><input type="text" id="location-lat" placeholder="بۆ نموونە: 36.85" required></div>
                         <div class="form-group"><label for="location-lng">Coordinates (Longitude)</label><input type="text" id="location-lng" placeholder="بۆ نموونە: 42.98" required></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="locations-list"></table>
            </div>

            <!-- Tab Content: Adhkar -->
            <div id="adhkar-content" class="tab-content">
                <h2><i class="fas fa-mosque"></i> کۆنترۆلا دوعا و زکران</h2>
                 <button class="btn btn-primary" onclick="showForm('adhkar-form')"><i class="fas fa-plus"></i> زکرەکێ نوو زێدەبکە</button>
                 <div id="adhkar-form" class="form-section" style="display:none;">
                     <h3 id="adhkar-form-title">زکرەکێ نوو</h3>
                     <form onsubmit="event.preventDefault(); saveAdhkar()">
                         <input type="hidden" id="adhkar-id">
                         <div class="form-group"><label for="adhkar-title">ناڤ</label><input type="text" id="adhkar-title" required></div>
                         <div class="form-group"><label for="adhkar-content">ناڤەرۆک</label><textarea id="adhkar-content" required></textarea></div>
                         <div class="form-group"><label for="adhkar-category">بابەت</label><input type="text" id="adhkar-category"></div>
                         <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                     </form>
                 </div>
                 <table class="item-list" id="adhkar-list"></table>
            </div>
            
            <!-- Tab Content: Live Course -->
            <div id="liveCourse-content" class="tab-content">
                <h2><i class="fas fa-satellite-dish"></i> کۆنترۆلا خولا ڕاستەوخۆ</h2>
                <div id="liveCourse-form" class="form-section">
                    <h3>زانیاریێن خولێ</h3>
                    <p>تێبینی: بتنێ ئێک خولا راستەوخو دشێت چالاک بیت.</p>
                    <form onsubmit="event.preventDefault(); saveLiveCourse()">
                        <div class="form-group"><label for="live-title">ناڤێ خولێ</label><input type="text" id="live-title"></div>
                        <div class="form-group"><label for="live-desc">کورتە</label><textarea id="live-desc"></textarea></div>
                        <div class="form-group"><label for="live-teacher">مامۆستا</label><select id="live-teacher"></select></div>
                        <div class="form-group"><label for="live-date">کەنگیا جڤینا بهێت (YYYY-MM-DDTHH:MM)</label><input type="datetime-local" id="live-date"></div>
                        <div class="form-group"><label for="live-topics">بابەتێن سەرەکی (هەر ئێک لسەر රێزەکێ)</label><textarea id="live-topics"></textarea></div>
                        <div class="form-group"><label for="live-prereq">پێدڤیێن خولێ</label><textarea id="live-prereq"></textarea></div>
                        <div class="form-group"><label for="live-schedule">خشتێ جڤینان (هەر ئێک لسەر රێزەکێ)</label><textarea id="live-schedule"></textarea></div>
                        <button type="submit" class="btn btn-success">پاشکەفتکرن</button>
                    </form>
                </div>
            </div>

            <!-- Tab Content: View Status -->
            <div id="viewStatus-content" class="tab-content">
                <h2><i class="fas fa-eye-slash"></i> کۆنترۆلا نیشاندانا بەشان</h2>
                <p>ل ڤێرێ دشێی هەر بەشەکێ ماڵپەری ب دلێ خۆ قفل بکەی، ڤەشێری یان چالاک بکەی.</p>
                <div id="viewStatus-form" class="form-section">
                    <h3>حالەتێ بەشان</h3>
                    <form onsubmit="event.preventDefault(); saveViewStatus()">
                        <table class="item-list" id="viewStatus-table"></table>
                        <br>
                        <button type="submit" class="btn btn-success">پاشکەفتکرنا گهورینان</button>
                    </form>
                </div>
            </div>


        </div>
    </div>
    
    <!-- Modal for Level Courses -->
    <div id="coursesModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('coursesModal')">&times;</span>
        <h2 id="courses-modal-title">کۆرسێن ئاستی</h2>
        <input type="hidden" id="courses-level-id">
        <button class="btn btn-primary" onclick="showForm('course-form', true)"><i class="fas fa-plus"></i> کۆرسەکێ نوو زێدەبکە</button>
        <div id="course-form" class="form-section" style="display:none;">
            <h3 id="course-form-title">کۆرسەکێ نوو</h3>
            <form onsubmit="event.preventDefault(); saveCourse()">
                <input type="hidden" id="course-id">
                <div class="form-group"><label for="course-title">ناڤێ کۆرسێ</label><input type="text" id="course-title" required></div>
                <div class="form-group"><label for="course-teacher">مامۆستا</label><select id="course-teacher" required></select></div>
                <div class="form-group"><label for="course-pdf">لێنکا PDF</label><input type="text" id="course-pdf"></div>
                <div class="form-group"><label for="course-mem-pdf-title">ناڤێ PDF یا ژبەرکرنێ</label><input type="text" id="course-mem-pdf-title"></div>
                <div class="form-group"><label for="course-mem-pdf-url">لێنکا PDF یا ژبەرکرنێ</label><input type="text" id="course-mem-pdf-url"></div>
                <div class="form-group"><label>لیستا ڤیدیویان</label><div id="course-videos-container"></div><button type="button" class="btn btn-secondary" onclick="addVideoField('course-videos-container')">ڤیدیویەکێ زێدەبکە</button></div>
                <button type="submit" class="btn btn-success">پاشکەفتکرنا کۆرسی</button>
            </form>
        </div>
        <table class="item-list" id="courses-list"></table>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script>
    // ====================================================================================
    // ============================= ADMIN PANEL JAVASCRIPT ===============================
    // ====================================================================================
    
    // === [ 0. FIREBASE SETUP ] ===
    const firebaseConfig = {
        apiKey: "AIzaSyDDi3HtFigGy3qFpFVhSATal3yzm7Z_dZA",
        authDomain: "projeislam.firebaseapp.com",
        projectId: "projeislam",
        storageBucket: "projeislam.appspot.com",
        messagingSenderId: "686343038831",
        appId: "1:686343038831:web:8b5e19daa95176000b6a9a",
        measurementId: "G-1M6PGZBM29"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const collections = {
        teachers: 'teachers', levels: 'levels', generalLectures: 'generalLectures',
        hadiths: 'hadiths', fatwas: 'fatwas', books: 'books', bookSales: 'bookSales',
        locations: 'locations', adhkar: 'adhkar', liveCourse: 'liveCourse', viewStatus: 'viewStatus'
    };

    // === [ 1. AUTHENTICATION & INITIALIZATION ] ===
    document.addEventListener('DOMContentLoaded', () => {
        const password = prompt("تکایە رەمزا نهێنی بنڤیسە:");
        if (password === "0") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            initializeApp();
        } else {
            alert("رەمزا نهێنی خەلەتە!");
            document.getElementById('login-screen').innerHTML = '<h1 style="text-align:center; color: var(--danger-color);">دەستوور نینە بچیە ژوور</h1>';
        }
    });

    async function initializeApp() {
        await populateTeacherDropdowns();
        await loadAllData();
        loadViewStatus();
    }
    
    async function loadAllData() {
        loadTeachers();
        loadLevels();
        loadLectures();
        loadHadiths();
        loadFatwas();
        loadBooks();
        loadBookSales();
        loadLocations();
        loadAdhkar();
        loadLiveCourse();
    }

    let allTeachers = [];
    async function populateTeacherDropdowns() {
        const snapshot = await db.collection(collections.teachers).orderBy('name').get();
        allTeachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const dropdowns = document.querySelectorAll('#lecture-teacher, #fatwa-teacher, #course-teacher, #location-teacher, #live-teacher');
        dropdowns.forEach(dropdown => {
            dropdown.innerHTML = '<option value="">مامۆستایەکێ هەلبژێرە</option>';
            allTeachers.forEach(teacher => {
                dropdown.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
            });
        });
    }

    // === [ 2. UI & TAB CONTROLS ] ===
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(`${tabName}-content`).classList.add('active');
        event.target.classList.add('active');
    }

    function showForm(formId, isModal = false) {
        const form = document.getElementById(formId);
        form.style.display = 'block';
        
        // Reset form fields
        const formTitle = document.getElementById(formId + '-title');
        if (formTitle) formTitle.textContent = formTitle.textContent.replace("دەستکاریکرنا", "زێدەکرنا");
        form.querySelector('form').reset();
        const hiddenId = form.querySelector('input[type="hidden"]');
        if (hiddenId) hiddenId.value = '';

        // Handle specific form resets
        if (formId === 'lecture-form' || formId === 'course-form') {
            const containerId = formId === 'lecture-form' ? 'lecture-videos-container' : 'course-videos-container';
            document.getElementById(containerId).innerHTML = '';
        }
    }
    
    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }


    // === [ 3. CRUD OPERATIONS: TEACHERS ] ===
    async function loadTeachers() {
        const list = document.getElementById('teachers-list');
        list.innerHTML = `<tr><th>وێنە</th><th>ناڤ</th><th>رێزبەندی</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.teachers).orderBy('order', 'asc').get();
        snapshot.forEach(doc => {
            const teacher = doc.data();
            list.innerHTML += `
                <tr>
                    <td><img src="${teacher.profileImage || ''}" alt="wêne"></td>
                    <td>${teacher.name}</td>
                    <td>${teacher.order || 0}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editTeacher('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.teachers}', '${doc.id}', loadTeachers)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editTeacher(id) {
        const doc = await db.collection(collections.teachers).doc(id).get();
        if (!doc.exists) return;
        const teacher = doc.data();
        showForm('teacher-form');
        document.getElementById('teacher-form-title').textContent = "دەستکاریکرنا مامۆستای";
        document.getElementById('teacher-id').value = id;
        document.getElementById('teacher-name').value = teacher.name;
        document.getElementById('teacher-bio').value = teacher.bio || '';
        document.getElementById('teacher-image').value = teacher.profileImage || '';
        document.getElementById('teacher-phone').value = teacher.phone || '';
        document.getElementById('teacher-order').value = teacher.order || 0;
        if(teacher.social){
             document.getElementById('teacher-telegram').value = teacher.social.telegram || '';
             document.getElementById('teacher-youtube').value = teacher.social.youtube || '';
             document.getElementById('teacher-facebook').value = teacher.social.facebook || '';
        }
    }

    async function saveTeacher() {
        const id = document.getElementById('teacher-id').value;
        const data = {
            name: document.getElementById('teacher-name').value,
            bio: document.getElementById('teacher-bio').value,
            profileImage: document.getElementById('teacher-image').value,
            phone: document.getElementById('teacher-phone').value,
            order: parseInt(document.getElementById('teacher-order').value) || 0,
            social: {
                telegram: document.getElementById('teacher-telegram').value,
                youtube: document.getElementById('teacher-youtube').value,
                facebook: document.getElementById('teacher-facebook').value,
            }
        };
        await saveItem(collections.teachers, id, data, loadTeachers);
        document.getElementById('teacher-form').style.display = 'none';
        await populateTeacherDropdowns();
    }
    
    // === [ 4. CRUD OPERATIONS: LEVELS & COURSES ] ===
    async function loadLevels() {
        const list = document.getElementById('levels-list');
        list.innerHTML = `<tr><th>ژمارە</th><th>ناڤێ ئاستی</th><th>کۆدا ڤەکرنێ</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.levels).orderBy('level').get();
        snapshot.forEach(doc => {
            const level = doc.data();
            list.innerHTML += `
                <tr>
                    <td>${level.level}</td>
                    <td>${level.levelName}</td>
                    <td>${level.unlockCode || 'Nîne'}</td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="manageCourses('${doc.id}')">کۆرسان کۆنترۆل بکە</button>
                        <button class="btn btn-secondary" onclick="editLevel('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.levels}', '${doc.id}', loadLevels)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editLevel(id) {
        const doc = await db.collection(collections.levels).doc(id).get();
        if (!doc.exists) return;
        const level = doc.data();
        showForm('level-form');
        document.getElementById('level-form-title').textContent = "دەستکاریکرنا ئاستی";
        document.getElementById('level-id').value = id;
        document.getElementById('level-name').value = level.levelName;
        document.getElementById('level-number').value = level.level;
        document.getElementById('level-unlock-code').value = level.unlockCode || '';
    }

    async function saveLevel() {
        const id = document.getElementById('level-id').value;
        const data = {
            levelName: document.getElementById('level-name').value,
            level: parseInt(document.getElementById('level-number').value),
            unlockCode: document.getElementById('level-unlock-code').value,
        };
        if (!id) { data.courses = []; }
        await saveItem(collections.levels, id, data, loadLevels);
        document.getElementById('level-form').style.display = 'none';
    }

    // Course Management
    async function manageCourses(levelId) {
        document.getElementById('courses-level-id').value = levelId;
        const levelDoc = await db.collection(collections.levels).doc(levelId).get();
        const level = levelDoc.data();
        document.getElementById('courses-modal-title').textContent = `کۆرسێن ئاستێ: ${level.levelName}`;
        const list = document.getElementById('courses-list');
        list.innerHTML = `<tr><th>ناڤێ کۆرسێ</th><th>مامۆستا</th><th>کارپێکرن</th></tr>`;
        
        if (level.courses && level.courses.length > 0) {
            level.courses.forEach(course => {
                const teacherName = allTeachers.find(t => t.id === course.teacherId)?.name || 'Nenas';
                list.innerHTML += `
                <tr>
                    <td>${course.title}</td>
                    <td>${teacherName}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editCourse('${levelId}', '${course.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteCourse('${levelId}', '${course.id}')">ژێبرن</button>
                    </td>
                </tr>`;
            });
        } else {
             list.innerHTML += `<tr><td colspan="3" style="text-align:center;">هیچ کۆرسەک نینە.</td></tr>`;
        }
        openModal('coursesModal');
    }

    function editCourse(levelId, courseId) {
        showForm('course-form', true);
        document.getElementById('course-form-title').textContent = "دەستکاریکرنا کۆرسی";
        
        db.collection(collections.levels).doc(levelId).get().then(doc => {
            const course = doc.data().courses.find(c => c.id === courseId);
            if(course) {
                document.getElementById('course-id').value = course.id;
                document.getElementById('course-title').value = course.title;
                document.getElementById('course-teacher').value = course.teacherId;
                document.getElementById('course-pdf').value = course.pdfUrl || '';
                document.getElementById('course-mem-pdf-title').value = course.memorizationPdfTitle || '';
                document.getElementById('course-mem-pdf-url').value = course.memorizationPdfUrl || '';

                const videosContainer = document.getElementById('course-videos-container');
                videosContainer.innerHTML = '';
                (course.videos || []).forEach(video => {
                    addVideoField('course-videos-container', video.title, video.url, video.audioUrl);
                });
            }
        });
    }

    async function saveCourse() {
        const levelId = document.getElementById('courses-level-id').value;
        const courseId = document.getElementById('course-id').value || 'course_' + Date.now();

        const videos = [];
        const videoFields = document.querySelectorAll('#course-videos-container .nested-item-container');
        videoFields.forEach(field => {
            videos.push({
                title: field.querySelector('.video-title').value,
                url: field.querySelector('.video-url').value,
                audioUrl: field.querySelector('.video-audio-url').value
            });
        });

        const newCourse = {
            id: courseId,
            title: document.getElementById('course-title').value,
            teacherId: document.getElementById('course-teacher').value,
            pdfUrl: document.getElementById('course-pdf').value,
            memorizationPdfTitle: document.getElementById('course-mem-pdf-title').value,
            memorizationPdfUrl: document.getElementById('course-mem-pdf-url').value,
            videos: videos
        };
        
        const levelRef = db.collection(collections.levels).doc(levelId);
        const levelDoc = await levelRef.get();
        const levelData = levelDoc.data();
        const courseIndex = (levelData.courses || []).findIndex(c => c.id === courseId);

        if (courseIndex > -1) {
            levelData.courses[courseIndex] = newCourse;
        } else {
            if (!levelData.courses) levelData.courses = [];
            levelData.courses.push(newCourse);
        }

        await levelRef.update({ courses: levelData.courses });
        alert('کۆرس ب سەرکەفتی هاتە پاشکەفتکرن!');
        document.getElementById('course-form').style.display = 'none';
        manageCourses(levelId); // Refresh course list
    }

    async function deleteCourse(levelId, courseId) {
        if (!confirm('پشتراستی دێ ڤی کۆرسی ژێبەی؟')) return;
        const levelRef = db.collection(collections.levels).doc(levelId);
        const levelDoc = await levelRef.get();
        const levelData = levelDoc.data();
        levelData.courses = (levelData.courses || []).filter(c => c.id !== courseId);
        await levelRef.update({ courses: levelData.courses });
        alert('کۆرس هاتە ژێبرن.');
        manageCourses(levelId);
    }

     // === [ 5. DYNAMIC VIDEO FIELDS ] ===
    function addVideoField(containerId, title = '', url = '', audioUrl = '') {
        const container = document.getElementById(containerId);
        const fieldId = 'video_' + Date.now();
        const fieldHTML = `
            <div class="nested-item-container" id="${fieldId}">
                <button type="button" class="btn btn-danger" style="float:left; padding: 5px 10px;" onclick="document.getElementById('${fieldId}').remove()">X</button>
                <div class="form-group"><label>ناڤێ ڤیدیویێ</label><input type="text" class="video-title" value="${title}" required></div>
                <div class="form-group"><label>لێنکا ڤیدیویێ (YouTube, etc.)</label><input type="text" class="video-url" value="${url}"></div>
                <div class="form-group"><label>لێنکا دەنگی (MP3, etc.)</label><input type="text" class="video-audio-url" value="${audioUrl}"></div>
            </div>`;
        container.innerHTML += fieldHTML;
    }

    // === [ 6. GENERAL LECTURES, HADITHS, FATWAS, etc. using helper functions ] ===
    // General Lectures
    async function loadLectures() {
        const list = document.getElementById('lectures-list');
        list.innerHTML = `<tr><th>ناڤ</th><th>بابەت</th><th>مامۆستا</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.generalLectures).get();
        snapshot.forEach(doc => {
            const lecture = doc.data();
            const teacherName = allTeachers.find(t => t.id === lecture.teacherId)?.name || 'Nenas';
            list.innerHTML += `
                <tr>
                    <td>${lecture.title}</td>
                    <td>${lecture.category}</td>
                    <td>${teacherName}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editLecture('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.generalLectures}', '${doc.id}', loadLectures)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }
    
    async function editLecture(id) {
        const doc = await db.collection(collections.generalLectures).doc(id).get();
        if (!doc.exists) return;
        const lecture = doc.data();
        showForm('lecture-form');
        document.getElementById('lecture-form-title').textContent = "دەستکاریکرنا وانەیێ";
        document.getElementById('lecture-id').value = id;
        document.getElementById('lecture-title').value = lecture.title;
        document.getElementById('lecture-category').value = lecture.category || '';
        document.getElementById('lecture-teacher').value = lecture.teacherId;
        document.getElementById('lecture-image').value = lecture.image || '';
        document.getElementById('lecture-pdf').value = lecture.pdfUrl || '';
        
        const videosContainer = document.getElementById('lecture-videos-container');
        videosContainer.innerHTML = '';
        (lecture.videos || []).forEach(video => {
            addVideoField('lecture-videos-container', video.title, video.url, video.audioUrl);
        });
    }

    async function saveLecture() {
        const id = document.getElementById('lecture-id').value;
        const videos = [];
        const videoFields = document.querySelectorAll('#lecture-videos-container .nested-item-container');
        videoFields.forEach(field => {
            videos.push({
                title: field.querySelector('.video-title').value,
                url: field.querySelector('.video-url').value,
                audioUrl: field.querySelector('.video-audio-url').value
            });
        });
        const data = {
            title: document.getElementById('lecture-title').value,
            category: document.getElementById('lecture-category').value,
            teacherId: document.getElementById('lecture-teacher').value,
            image: document.getElementById('lecture-image').value,
            pdfUrl: document.getElementById('lecture-pdf').value,
            videos: videos
        };
        await saveItem(collections.generalLectures, id, data, loadLectures);
        document.getElementById('lecture-form').style.display = 'none';
    }

    // Hadiths
    async function loadHadiths() {
        const list = document.getElementById('hadiths-list');
        list.innerHTML = `<tr><th>دەق (کورتە)</th><th>بابەت</th><th>پلە</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.hadiths).get();
        snapshot.forEach(doc => {
            const hadith = doc.data();
            list.innerHTML += `
                <tr>
                    <td>${(hadith.text || '').substring(0, 50)}...</td>
                    <td>${hadith.category}</td>
                    <td>${hadith.grade}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editHadith('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.hadiths}', '${doc.id}', loadHadiths)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editHadith(id) {
        const doc = await db.collection(collections.hadiths).doc(id).get();
        if (!doc.exists) return;
        const hadith = doc.data();
        showForm('hadith-form');
        document.getElementById('hadith-form-title').textContent = "دەستکاریکرنا حەدیسێ";
        document.getElementById('hadith-id').value = id;
        document.getElementById('hadith-text').value = hadith.text;
        document.getElementById('hadith-number').value = hadith.hadith_number || '';
        document.getElementById('hadith-narrator').value = hadith.narrator || '';
        document.getElementById('hadith-source').value = hadith.source || '';
        document.getElementById('hadith-category').value = hadith.category || '';
        document.getElementById('hadith-grade').value = hadith.grade || '';
        document.getElementById('hadith-audio').value = hadith.audioUrl || '';
    }

    async function saveHadith() {
        const id = document.getElementById('hadith-id').value;
        const data = {
            text: document.getElementById('hadith-text').value,
            hadith_number: document.getElementById('hadith-number').value,
            narrator: document.getElementById('hadith-narrator').value,
            source: document.getElementById('hadith-source').value,
            category: document.getElementById('hadith-category').value,
            grade: document.getElementById('hadith-grade').value,
            audioUrl: document.getElementById('hadith-audio').value,
        };
        await saveItem(collections.hadiths, id, data, loadHadiths);
        document.getElementById('hadith-form').style.display = 'none';
    }

    // Fatwas
    async function loadFatwas() {
        const list = document.getElementById('fatwas-list');
        list.innerHTML = `<tr><th>پرسیار</th><th>مامۆستا</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.fatwas).get();
        snapshot.forEach(doc => {
            const fatwa = doc.data();
            const teacherName = allTeachers.find(t => t.id === fatwa.teacherId)?.name || 'Nenas';
            list.innerHTML += `
                <tr>
                    <td>${(fatwa.question || '').substring(0, 50)}...</td>
                    <td>${teacherName}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editFatwa('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.fatwas}', '${doc.id}', loadFatwas)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editFatwa(id) {
        const doc = await db.collection(collections.fatwas).doc(id).get();
        if (!doc.exists) return;
        const fatwa = doc.data();
        showForm('fatwa-form');
        document.getElementById('fatwa-form-title').textContent = "دەستکاریکرنا پرسیارێ";
        document.getElementById('fatwa-id').value = id;
        document.getElementById('fatwa-question').value = fatwa.question;
        document.getElementById('fatwa-answer').value = fatwa.answer;
        document.getElementById('fatwa-teacher').value = fatwa.teacherId;
        document.getElementById('fatwa-audio').value = fatwa.audioUrl || '';
    }

    async function saveFatwa() {
        const id = document.getElementById('fatwa-id').value;
        const data = {
            question: document.getElementById('fatwa-question').value,
            answer: document.getElementById('fatwa-answer').value,
            teacherId: document.getElementById('fatwa-teacher').value,
            audioUrl: document.getElementById('fatwa-audio').value,
        };
        await saveItem(collections.fatwas, id, data, loadFatwas);
        document.getElementById('fatwa-form').style.display = 'none';
    }

    // Books (Library)
    async function loadBooks() {
        const list = document.getElementById('books-list');
        list.innerHTML = `<tr><th>بەرگ</th><th>ناڤ</th><th>نڤیسەر</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.books).get();
        snapshot.forEach(doc => {
            const book = doc.data();
            list.innerHTML += `
                <tr>
                    <td><img src="${book.coverImage || ''}"></td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editBook('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.books}', '${doc.id}', loadBooks)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editBook(id) {
        const doc = await db.collection(collections.books).doc(id).get();
        if (!doc.exists) return;
        const book = doc.data();
        showForm('book-form');
        document.getElementById('book-form-title').textContent = "دەستکاریکرنا پەرتوکێ";
        document.getElementById('book-id').value = id;
        document.getElementById('book-title').value = book.title;
        document.getElementById('book-author').value = book.author;
        document.getElementById('book-cover').value = book.coverImage;
        document.getElementById('book-read-url').value = book.readUrl;
        document.getElementById('book-download-url').value = book.downloadUrl;
    }

    async function saveBook() {
        const id = document.getElementById('book-id').value;
        const data = {
            title: document.getElementById('book-title').value,
            author: document.getElementById('book-author').value,
            coverImage: document.getElementById('book-cover').value,
            readUrl: document.getElementById('book-read-url').value,
            downloadUrl: document.getElementById('book-download-url').value,
        };
        await saveItem(collections.books, id, data, loadBooks);
        document.getElementById('book-form').style.display = 'none';
    }

    // Book Sales
    async function loadBookSales() {
        const list = document.getElementById('bookSales-list');
        list.innerHTML = `<tr><th>بەرگ</th><th>ناڤ</th><th>بها</th><th>بەردەستە؟</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.bookSales).get();
        snapshot.forEach(doc => {
            const book = doc.data();
            list.innerHTML += `
                <tr>
                    <td><img src="${book.coverImage || ''}"></td>
                    <td>${book.title}</td>
                    <td>${book.price}</td>
                    <td>${book.isAvailable ? 'بەلێ' : 'نەخێر'}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editBookSale('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.bookSales}', '${doc.id}', loadBookSales)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editBookSale(id) {
        const doc = await db.collection(collections.bookSales).doc(id).get();
        if (!doc.exists) return;
        const book = doc.data();
        showForm('bookSale-form');
        document.getElementById('bookSale-form-title').textContent = "دەستکاریکرنا پەرتوکا فرۆتنێ";
        document.getElementById('bookSale-id').value = id;
        document.getElementById('bookSale-title').value = book.title;
        document.getElementById('bookSale-author').value = book.author;
        document.getElementById('bookSale-desc').value = book.description;
        document.getElementById('bookSale-cover').value = book.coverImage;
        document.getElementById('bookSale-price').value = book.price;
        document.getElementById('bookSale-link').value = book.purchaseLink;
        document.getElementById('bookSale-available').checked = book.isAvailable;
    }

    async function saveBookSale() {
        const id = document.getElementById('bookSale-id').value;
        const data = {
            title: document.getElementById('bookSale-title').value,
            author: document.getElementById('bookSale-author').value,
            description: document.getElementById('bookSale-desc').value,
            coverImage: document.getElementById('bookSale-cover').value,
            price: document.getElementById('bookSale-price').value,
            purchaseLink: document.getElementById('bookSale-link').value,
            isAvailable: document.getElementById('bookSale-available').checked,
        };
        await saveItem(collections.bookSales, id, data, loadBookSales);
        document.getElementById('bookSale-form').style.display = 'none';
    }

    // Map Locations
    async function loadLocations() {
        const list = document.getElementById('locations-list');
        list.innerHTML = `<tr><th>ناڤێ جهی</th><th>وانە</th><th>مامۆستا</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.locations).get();
        snapshot.forEach(doc => {
            const loc = doc.data();
            const teacherName = allTeachers.find(t => t.id === loc.teacherId)?.name || 'Nenas';
            list.innerHTML += `
                <tr>
                    <td>${loc.locationName}</td>
                    <td>${loc.lessonTaught}</td>
                    <td>${teacherName}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editLocation('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.locations}', '${doc.id}', loadLocations)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }

    async function editLocation(id) {
        const doc = await db.collection(collections.locations).doc(id).get();
        if (!doc.exists) return;
        const loc = doc.data();
        showForm('location-form');
        document.getElementById('location-form-title').textContent = "دەستکاریکرنا جهی";
        document.getElementById('location-id').value = id;
        document.getElementById('location-name').value = loc.locationName;
        document.getElementById('location-lesson').value = loc.lessonTaught;
        document.getElementById('location-teacher').value = loc.teacherId;
        document.getElementById('location-schedule').value = loc.schedule;
        document.getElementById('location-lat').value = loc.coordinates[0];
        document.getElementById('location-lng').value = loc.coordinates[1];
    }

    async function saveLocation() {
        const id = document.getElementById('location-id').value;
        const lat = parseFloat(document.getElementById('location-lat').value);
        const lng = parseFloat(document.getElementById('location-lng').value);
        const data = {
            locationName: document.getElementById('location-name').value,
            lessonTaught: document.getElementById('location-lesson').value,
            teacherId: document.getElementById('location-teacher').value,
            schedule: document.getElementById('location-schedule').value,
            coordinates: new firebase.firestore.GeoPoint(lat, lng),
        };
        await saveItem(collections.locations, id, data, loadLocations);
        document.getElementById('location-form').style.display = 'none';
    }
    
    // Adhkar
    async function loadAdhkar() {
        const list = document.getElementById('adhkar-list');
        list.innerHTML = `<tr><th>ناڤ</th><th>بابەت</th><th>کارپێکرن</th></tr>`;
        const snapshot = await db.collection(collections.adhkar).get();
        snapshot.forEach(doc => {
            const dhikr = doc.data();
            list.innerHTML += `
                <tr>
                    <td>${dhikr.title}</td>
                    <td>${dhikr.category || ''}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editAdhkar('${doc.id}')">دەستکاری</button>
                        <button class="btn btn-danger" onclick="deleteItem('${collections.adhkar}', '${doc.id}', loadAdhkar)">ژێبرن</button>
                    </td>
                </tr>`;
        });
    }
    
    async function editAdhkar(id) {
        const doc = await db.collection(collections.adhkar).doc(id).get();
        if (!doc.exists) return;
        const dhikr = doc.data();
        showForm('adhkar-form');
        document.getElementById('adhkar-form-title').textContent = "دەستکاریکرنا زکری";
        document.getElementById('adhkar-id').value = id;
        document.getElementById('adhkar-title').value = dhikr.title;
        document.getElementById('adhkar-content').value = dhikr.content;
        document.getElementById('adhkar-category').value = dhikr.category || '';
    }
    
    async function saveAdhkar() {
        const id = document.getElementById('adhkar-id').value;
        const data = {
            title: document.getElementById('adhkar-title').value,
            content: document.getElementById('adhkar-content').value,
            category: document.getElementById('adhkar-category').value,
        };
        await saveItem(collections.adhkar, id, data, loadAdhkar);
        document.getElementById('adhkar-form').style.display = 'none';
    }

    // Live Course
    async function loadLiveCourse() {
        const snapshot = await db.collection(collections.liveCourse).limit(1).get();
        if (snapshot.empty) return;
        const doc = snapshot.docs[0];
        const course = doc.data();
        document.getElementById('live-title').value = course.title || '';
        document.getElementById('live-desc').value = course.description || '';
        document.getElementById('live-teacher').value = course.teacherId || '';
        if(course.nextSessionDate) {
             const date = new Date(course.nextSessionDate).toISOString().slice(0, 16);
             document.getElementById('live-date').value = date;
        }
        document.getElementById('live-topics').value = (course.topics || []).join('\n');
        document.getElementById('live-prereq').value = course.prerequisites || '';
        document.getElementById('live-schedule').value = (course.schedule || []).join('\n');
    }

    async function saveLiveCourse() {
        const data = {
            title: document.getElementById('live-title').value,
            description: document.getElementById('live-desc').value,
            teacherId: document.getElementById('live-teacher').value,
            nextSessionDate: document.getElementById('live-date').value,
            topics: document.getElementById('live-topics').value.split('\n').filter(t => t),
            prerequisites: document.getElementById('live-prereq').value,
            schedule: document.getElementById('live-schedule').value.split('\n').filter(s => s),
        };

        const snapshot = await db.collection(collections.liveCourse).limit(1).get();
        let docId = 'main_course'; // Default ID
        if (!snapshot.empty) {
            docId = snapshot.docs[0].id;
        }
        await db.collection(collections.liveCourse).doc(docId).set(data);
        alert('زانیاریێن خولا راستەوخو هاتنە پاشکەفتکرن.');
    }

    // View Status
    const allViews = [ 'waneyan-view', 'hadith-view', 'pirtukxane-view', 'book-sales-view', 'teachers-view', 'fatwas-view', 'map-view', 'live-view', 'dashboard-view', 'favorites-view', 'adhkar-view', 'feedback-view' ];
    const viewNames = { 'waneyan-view': 'وانەیێن گشتی', 'hadith-view': 'حەدیسان', 'pirtukxane-view': 'پەرتوکخانە', 'book-sales-view': 'فرۆتنا پەرتووکان', 'teachers-view': 'مامۆستایان', 'fatwas-view': 'پرسیار و بەرسڤ', 'map-view': 'خەریتە', 'live-view': 'خولێن ڕاستەوخۆ', 'dashboard-view': 'داشبۆرد', 'favorites-view': 'دڵخوازان', 'adhkar-view': 'دوعا و زکر', 'feedback-view': 'پێشنیار و ڕەخنە' };
    const statusOptions = { '0': 'چالاک', '1': 'د کارکرنێ دایە', '8': 'قفل', '7': 'ڤەشارتî' };
    
    async function loadViewStatus() {
        const table = document.getElementById('viewStatus-table');
        table.innerHTML = '<tr><th>ناڤێ بەشی</th><th>حالەت</th></tr>';
        const snapshot = await db.collection(collections.viewStatus).get();
        const statuses = {};
        snapshot.forEach(doc => { statuses[doc.id] = doc.data().statusCode; });

        allViews.forEach(viewId => {
            let selectHTML = `<select id="status-${viewId}">`;
            for (const [code, name] of Object.entries(statusOptions)) {
                const isSelected = (statuses[viewId] || '0') === code ? 'selected' : '';
                selectHTML += `<option value="${code}" ${isSelected}>${name}</option>`;
            }
            selectHTML += `</select>`;
            table.innerHTML += `
                <tr>
                    <td>${viewNames[viewId] || viewId}</td>
                    <td>${selectHTML}</td>
                </tr>`;
        });
    }

    async function saveViewStatus() {
        const batch = db.batch();
        allViews.forEach(viewId => {
            const selectedStatus = document.getElementById(`status-${viewId}`).value;
            const docRef = db.collection(collections.viewStatus).doc(viewId);
            batch.set(docRef, { statusCode: selectedStatus });
        });
        await batch.commit();
        alert('حالەتێ بەشان هاتە پاشکەفتکرن.');
    }
    
    // === [ 7. HELPER FUNCTIONS ] ===
    async function saveItem(collection, id, data, callback) {
        try {
            if (id) {
                await db.collection(collection).doc(id).update(data);
                alert('ب سەرکەفتی هاتە دەستکاریکرن.');
            } else {
                await db.collection(collection).add(data);
                alert('ب سەرکەفتی هاتە زێدەکرن.');
            }
            if (callback) callback();
        } catch (e) {
            console.error("Error:", e);
            alert("چەوتیەک روویدا: " + e.message);
        }
    }

    async function deleteItem(collection, id, callback) {
        if (confirm('پشتراستی دێ ڤی بابەتی ژێبەی؟')) {
            try {
                await db.collection(collection).doc(id).delete();
                alert('ب سەرکەفتی هاتە ژێبرن.');
                if (callback) callback();
            } catch (e) {
                console.error("Error:", e);
                alert("چەوتیەک روویدا: " + e.message);
            }
        }
    }

    // Make functions globally accessible
    window.openTab = openTab; window.showForm = showForm; window.openModal = openModal; window.closeModal = closeModal;
    window.saveTeacher = saveTeacher; window.editTeacher = editTeacher; window.loadTeachers = loadTeachers;
    window.saveLevel = saveLevel; window.editLevel = editLevel; window.loadLevels = loadLevels;
    window.manageCourses = manageCourses; window.editCourse = editCourse; window.saveCourse = saveCourse; window.deleteCourse = deleteCourse;
    window.addVideoField = addVideoField;
    window.saveLecture = saveLecture; window.editLecture = editLecture; window.loadLectures = loadLectures;
    window.saveHadith = saveHadith; window.editHadith = editHadith; window.loadHadiths = loadHadiths;
    window.saveFatwa = saveFatwa; window.editFatwa = editFatwa; window.loadFatwas = loadFatwas;
    window.saveBook = saveBook; window.editBook = editBook; window.loadBooks = loadBooks;
    window.saveBookSale = saveBookSale; window.editBookSale = editBookSale; window.loadBookSales = loadBookSales;
    window.saveLocation = saveLocation; window.editLocation = editLocation; window.loadLocations = loadLocations;
    window.saveAdhkar = saveAdhkar; window.editAdhkar = editAdhkar; window.loadAdhkar = loadAdhkar;
    window.saveLiveCourse = saveLiveCourse;
    window.saveViewStatus = saveViewStatus;
    window.deleteItem = deleteItem;

    </script>
</body>
</html>
